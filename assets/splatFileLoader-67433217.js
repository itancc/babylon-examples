import{L as U,c as ts,_ as ss,d as ns,I as rs,D as os,e as S,b as ce,O as q,A as bt,f as jt,R as is,E as as,g as Z,h as ls,V as C,i as be,T as B,j as de,k as Kt,l as Re,m as cs,n as Ot,S as we,a as L,o as ee,C as he,p as b,Q as Y,H as Wt,q as Tt,r as Et,s as wt,F as Be,t as qt,M as oe,u as Ce,v as De,w as hs,x as Me,y as ds,z as N,J as St,K as us,N as fs,U as _s,W as ps,X as ms,Y as G,Z as As,$ as gs,a0 as Q,a1 as ys,a2 as bs,a3 as Os,a4 as Ts,a5 as Es,a6 as Pt,a7 as ws,a8 as Cs,a9 as xs,aa as Ns,ab as Is,ac as Ms,ad as vs,ae as Ss,af as Ps,ag as Ls,ah as Fs,ai as Rs,aj as Bs,ak as Ds,al as $s,am as ks,an as Vs,ao as Gs,ap as Us,aq as Hs,ar as js,as as Ks,at as Ws,au as qs,av as Ys,aw as zs,ax as Xs,ay as Zs,az as Js,aA as Qs,aB as en,aC as tn,aD as sn,aE as nn,aF as rn,aG as on,aH as an,aI as ln,aJ as cn,aK as hn,aL as dn,aM as un,aN as fn,aO as _n,aP as pn,aQ as mn,aR as An,aS as gn,aT as yn,aU as bn,aV as On,aW as Tn,aX as En,aY as wn,aZ as Cn,a_ as xn,a$ as Nn,b0 as In,b1 as Mn,b2 as vn,b3 as Sn,b4 as Pn,b5 as Ln,b6 as Fn,b7 as Rn,b8 as Bn,b9 as Dn,ba as $n,bb as kn,bc as Vn,bd as Gn,be as Un,bf as Hn,bg as jn,bh as Kn,bi as Wn,bj as qn,bk as Yn,bl as zn,bm as Xn,bn as Zn,bo as Jn,bp as Qn,bq as er,br as tr,bs as sr,bt as me,bu as Ne,bv as nr,bw as rr,bx as Lt}from"./index-fe6f640a.js";class Ct{constructor(e,t,s){this.frame=e,this.action=t,this.onlyOnce=s,this.isDone=!1}_clone(){return new Ct(this.frame,this.action,this.onlyOnce)}}class or{constructor(e,t,s){if(this.loop=!1,this._coneInnerAngle=360,this._coneOuterAngle=360,this._volume=1,this.isPlaying=!1,this.isPaused=!1,this._sounds=[],this._weights=[],t.length!==s.length)throw new Error("Sounds length does not equal weights length");this.loop=e,this._weights=s;let n=0;for(const o of s)n+=o;const r=n>0?1/n:0;for(let o=0;o<this._weights.length;o++)this._weights[o]*=r;this._sounds=t;for(const o of this._sounds)o.onEndedObservable.add(()=>{this._onended()})}get directionalConeInnerAngle(){return this._coneInnerAngle}set directionalConeInnerAngle(e){if(e!==this._coneInnerAngle){if(this._coneOuterAngle<e){U.Error("directionalConeInnerAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneInnerAngle=e;for(const t of this._sounds)t.directionalConeInnerAngle=e}}get directionalConeOuterAngle(){return this._coneOuterAngle}set directionalConeOuterAngle(e){if(e!==this._coneOuterAngle){if(e<this._coneInnerAngle){U.Error("directionalConeOuterAngle: outer angle of the cone must be superior or equal to the inner angle.");return}this._coneOuterAngle=e;for(const t of this._sounds)t.directionalConeOuterAngle=e}}get volume(){return this._volume}set volume(e){if(e!==this._volume)for(const t of this._sounds)t.setVolume(e)}_onended(){this._currentIndex!==void 0&&(this._sounds[this._currentIndex].autoplay=!1),this.loop&&this.isPlaying?this.play():this.isPlaying=!1}pause(){this.isPaused=!0,this._currentIndex!==void 0&&this._sounds[this._currentIndex].pause()}stop(){this.isPlaying=!1,this._currentIndex!==void 0&&this._sounds[this._currentIndex].stop()}play(e){if(!this.isPaused){this.stop();const s=Math.random();let n=0;for(let r=0;r<this._weights.length;r++)if(n+=this._weights[r],s<=n){this._currentIndex=r;break}}const t=this._sounds[this._currentIndex];t.isReady()?t.play(0,this.isPaused?void 0:e):t.autoplay=!0,this.isPlaying=!0,this.isPaused=!1}}class xt extends ts{constructor(e,t,s,n=5,r=0,o=!1,a=!1,l=3,c=null){super("",e),this._texture=e.getEngine().createRawCubeTexture(t,s,n,r,o,a,l,c)}update(e,t,s,n,r=null){this._texture.getEngine().updateRawCubeTexture(this._texture,e,t,s,n,r)}updateRGBDAsync(e,t=null,s=.8,n=0){return ss(this._texture,e,t,s,n).then(()=>{})}clone(){return ns.Clone(()=>{const e=this.getScene(),t=this._texture,s=new xt(e,t._bufferViewArray,t.width,t.format,t.type,t.generateMipMaps,t.invertY,t.samplingMode,t._compression);return t.source===rs.CubeRawRGBD&&s.updateRGBDAsync(t._bufferViewArrayArray,t._sphericalPolynomial,t._lodGenerationScale,t._lodGenerationOffset),s},this)}}class ge{get resolve(){return this._resolve}get reject(){return this._reject}constructor(){this.promise=new Promise((e,t)=>{this._resolve=e,this._reject=t})}}class Ie{constructor(e){this.byteOffset=0,this.buffer=e}loadAsync(e){return this.buffer.readAsync(this.byteOffset,e).then(t=>{this._dataView=new DataView(t.buffer,t.byteOffset,t.byteLength),this._dataByteOffset=0})}readUint32(){const e=this._dataView.getUint32(this._dataByteOffset,!0);return this._dataByteOffset+=4,this.byteOffset+=4,e}readUint8Array(e){const t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._dataByteOffset,e);return this._dataByteOffset+=e,this.byteOffset+=e,t}readString(e){return os(this.readUint8Array(e))}skipBytes(e){this._dataByteOffset+=e,this.byteOffset+=e}}function $e(i,e,t,s){const n={externalResourceFunction:s};return t&&(n.uri=e==="file:"?t:e+t),ArrayBuffer.isView(i)?GLTFValidator.validateBytes(i,n):GLTFValidator.validateString(i,n)}function ir(){const i=[];onmessage=e=>{const t=e.data;switch(t.id){case"init":{importScripts(t.url);break}case"validate":{$e(t.data,t.rootUrl,t.fileName,s=>new Promise((n,r)=>{const o=i.length;i.push({resolve:n,reject:r}),postMessage({id:"getExternalResource",index:o,uri:s})})).then(s=>{postMessage({id:"validate.resolve",value:s})},s=>{postMessage({id:"validate.reject",reason:s})});break}case"getExternalResource.resolve":{i[t.index].resolve(t.value);break}case"getExternalResource.reject":{i[t.index].reject(t.reason);break}}}}class Yt{static ValidateAsync(e,t,s,n){return typeof Worker=="function"?new Promise((r,o)=>{const a=`${$e}(${ir})()`,l=URL.createObjectURL(new Blob([a],{type:"application/javascript"})),c=new Worker(l),h=u=>{c.removeEventListener("error",h),c.removeEventListener("message",d),o(u)},d=u=>{const f=u.data;switch(f.id){case"getExternalResource":{n(f.uri).then(p=>{c.postMessage({id:"getExternalResource.resolve",index:f.index,value:p},[p])},p=>{c.postMessage({id:"getExternalResource.reject",index:f.index,reason:p})});break}case"validate.resolve":{c.removeEventListener("error",h),c.removeEventListener("message",d),r(f.value),c.terminate();break}case"validate.reject":c.removeEventListener("error",h),c.removeEventListener("message",d),o(f.reason),c.terminate()}};if(c.addEventListener("error",h),c.addEventListener("message",d),c.postMessage({id:"init",url:S.GetBabylonScriptURL(this.Configuration.url)}),ArrayBuffer.isView(e)){const u=e.slice();c.postMessage({id:"validate",data:u,rootUrl:t,fileName:s},[u.buffer])}else c.postMessage({id:"validate",data:e,rootUrl:t,fileName:s})}):(this._LoadScriptPromise||(this._LoadScriptPromise=S.LoadBabylonScriptAsync(this.Configuration.url)),this._LoadScriptPromise.then(()=>$e(e,t,s,n)))}}Yt.Configuration={url:`${S._DefaultCdnUrl}/gltf_validator.js`};function Ft(i,e,t){try{return Promise.resolve(new Uint8Array(i,e,t))}catch(s){return Promise.reject(s)}}function ar(i,e,t){try{if(e<0||e>=i.byteLength)throw new RangeError("Offset is out of range.");if(e+t>i.byteLength)throw new RangeError("Length is out of range.");return Promise.resolve(new Uint8Array(i.buffer,i.byteOffset+e,t))}catch(s){return Promise.reject(s)}}var Te;(function(i){i[i.AUTO=0]="AUTO",i[i.FORCE_RIGHT_HANDED=1]="FORCE_RIGHT_HANDED"})(Te||(Te={}));var _e;(function(i){i[i.NONE=0]="NONE",i[i.FIRST=1]="FIRST",i[i.ALL=2]="ALL"})(_e||(_e={}));var J;(function(i){i[i.LOADING=0]="LOADING",i[i.READY=1]="READY",i[i.COMPLETE=2]="COMPLETE"})(J||(J={}));class k{constructor(){this.onParsedObservable=new q,this.coordinateSystemMode=Te.AUTO,this.animationStartMode=_e.FIRST,this.compileMaterials=!1,this.useClipPlane=!1,this.compileShadowGenerators=!1,this.transparencyAsCoverage=!1,this.useRangeRequests=!1,this.createInstances=!0,this.alwaysComputeBoundingBox=!1,this.loadAllMaterials=!1,this.loadOnlyMaterials=!1,this.skipMaterials=!1,this.useSRGBBuffers=!0,this.targetFps=60,this.alwaysComputeSkeletonRootNode=!1,this.preprocessUrlAsync=e=>Promise.resolve(e),this.onMeshLoadedObservable=new q,this.onSkinLoadedObservable=new q,this.onTextureLoadedObservable=new q,this.onMaterialLoadedObservable=new q,this.onCameraLoadedObservable=new q,this.onCompleteObservable=new q,this.onErrorObservable=new q,this.onDisposeObservable=new q,this.onExtensionLoadedObservable=new q,this.validate=!1,this.onValidatedObservable=new q,this._loader=null,this._state=null,this._requests=new Array,this.name="gltf",this.extensions={".gltf":{isBinary:!1},".glb":{isBinary:!0}},this.onLoaderStateChangedObservable=new q,this._logIndentLevel=0,this._loggingEnabled=!1,this._log=this._logDisabled,this._capturePerformanceCounters=!1,this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled}set onParsed(e){this._onParsedObserver&&this.onParsedObservable.remove(this._onParsedObserver),this._onParsedObserver=this.onParsedObservable.add(e)}set onMeshLoaded(e){this._onMeshLoadedObserver&&this.onMeshLoadedObservable.remove(this._onMeshLoadedObserver),this._onMeshLoadedObserver=this.onMeshLoadedObservable.add(e)}set onTextureLoaded(e){this._onTextureLoadedObserver&&this.onTextureLoadedObservable.remove(this._onTextureLoadedObserver),this._onTextureLoadedObserver=this.onTextureLoadedObservable.add(e)}set onMaterialLoaded(e){this._onMaterialLoadedObserver&&this.onMaterialLoadedObservable.remove(this._onMaterialLoadedObserver),this._onMaterialLoadedObserver=this.onMaterialLoadedObservable.add(e)}set onCameraLoaded(e){this._onCameraLoadedObserver&&this.onCameraLoadedObservable.remove(this._onCameraLoadedObserver),this._onCameraLoadedObserver=this.onCameraLoadedObservable.add(e)}set onComplete(e){this._onCompleteObserver&&this.onCompleteObservable.remove(this._onCompleteObserver),this._onCompleteObserver=this.onCompleteObservable.add(e)}set onError(e){this._onErrorObserver&&this.onErrorObservable.remove(this._onErrorObserver),this._onErrorObserver=this.onErrorObservable.add(e)}set onDispose(e){this._onDisposeObserver&&this.onDisposeObservable.remove(this._onDisposeObserver),this._onDisposeObserver=this.onDisposeObservable.add(e)}set onExtensionLoaded(e){this._onExtensionLoadedObserver&&this.onExtensionLoadedObservable.remove(this._onExtensionLoadedObserver),this._onExtensionLoadedObserver=this.onExtensionLoadedObservable.add(e)}get loggingEnabled(){return this._loggingEnabled}set loggingEnabled(e){this._loggingEnabled!==e&&(this._loggingEnabled=e,this._loggingEnabled?this._log=this._logEnabled:this._log=this._logDisabled)}get capturePerformanceCounters(){return this._capturePerformanceCounters}set capturePerformanceCounters(e){this._capturePerformanceCounters!==e&&(this._capturePerformanceCounters=e,this._capturePerformanceCounters?(this._startPerformanceCounter=this._startPerformanceCounterEnabled,this._endPerformanceCounter=this._endPerformanceCounterEnabled):(this._startPerformanceCounter=this._startPerformanceCounterDisabled,this._endPerformanceCounter=this._endPerformanceCounterDisabled))}set onValidated(e){this._onValidatedObserver&&this.onValidatedObservable.remove(this._onValidatedObserver),this._onValidatedObserver=this.onValidatedObservable.add(e)}dispose(){this._loader&&(this._loader.dispose(),this._loader=null);for(const e of this._requests)e.abort();this._requests.length=0,delete this._progressCallback,this.preprocessUrlAsync=e=>Promise.resolve(e),this.onMeshLoadedObservable.clear(),this.onSkinLoadedObservable.clear(),this.onTextureLoadedObservable.clear(),this.onMaterialLoadedObservable.clear(),this.onCameraLoadedObservable.clear(),this.onCompleteObservable.clear(),this.onExtensionLoadedObservable.clear(),this.onDisposeObservable.notifyObservers(void 0),this.onDisposeObservable.clear()}loadFile(e,t,s,n,r,o,a,l){if(ArrayBuffer.isView(t))return this._loadBinary(e,t,s,n,a,l),null;this._progressCallback=r;const c=t.name||S.GetFilename(t);if(o){if(this.useRangeRequests){this.validate&&U.Warn("glTF validation is not supported when range requests are enabled");const h={abort:()=>{},onCompleteObservable:new q},d={readAsync:(u,f)=>new Promise((p,A)=>{this._loadFile(e,t,m=>{p(new Uint8Array(m))},!0,m=>{A(m)},m=>{m.setRequestHeader("Range",`bytes=${u}-${u+f-1}`)})}),byteLength:0};return this._unpackBinaryAsync(new Ie(d)).then(u=>{h.onCompleteObservable.notifyObservers(h),n(u)},a?u=>a(void 0,u):void 0),h}return this._loadFile(e,t,h=>{this._validate(e,new Uint8Array(h,0,h.byteLength),s,c),this._unpackBinaryAsync(new Ie({readAsync:(d,u)=>Ft(h,d,u),byteLength:h.byteLength})).then(d=>{n(d)},a?d=>a(void 0,d):void 0)},!0,a)}else return this._loadFile(e,t,h=>{this._validate(e,h,s,c),n({json:this._parseJson(h)})},!1,a)}_loadBinary(e,t,s,n,r,o){this._validate(e,new Uint8Array(t.buffer,t.byteOffset,t.byteLength),s,o),this._unpackBinaryAsync(new Ie({readAsync:(a,l)=>ar(t,a,l),byteLength:t.byteLength})).then(a=>{n(a)},r?a=>r(void 0,a):void 0)}importMeshAsync(e,t,s,n,r,o){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(s),this.onParsedObservable.clear(),this._log(`Loading ${o||""}`),this._loader=this._getLoader(s),this._loader.importMeshAsync(e,t,null,s,n,r,o)))}loadAsync(e,t,s,n,r){return Promise.resolve().then(()=>(this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${r||""}`),this._loader=this._getLoader(t),this._loader.loadAsync(e,t,s,n,r)))}loadAssetContainerAsync(e,t,s,n,r){return Promise.resolve().then(()=>{this.onParsedObservable.notifyObservers(t),this.onParsedObservable.clear(),this._log(`Loading ${r||""}`),this._loader=this._getLoader(t);const o=new bt(e),a=[];this.onMaterialLoadedObservable.add(d=>{a.push(d)});const l=[];this.onTextureLoadedObservable.add(d=>{l.push(d)});const c=[];this.onCameraLoadedObservable.add(d=>{c.push(d)});const h=[];return this.onMeshLoadedObservable.add(d=>{d.morphTargetManager&&h.push(d.morphTargetManager)}),this._loader.importMeshAsync(null,e,o,t,s,n,r).then(d=>(Array.prototype.push.apply(o.geometries,d.geometries),Array.prototype.push.apply(o.meshes,d.meshes),Array.prototype.push.apply(o.particleSystems,d.particleSystems),Array.prototype.push.apply(o.skeletons,d.skeletons),Array.prototype.push.apply(o.animationGroups,d.animationGroups),Array.prototype.push.apply(o.materials,a),Array.prototype.push.apply(o.textures,l),Array.prototype.push.apply(o.lights,d.lights),Array.prototype.push.apply(o.transformNodes,d.transformNodes),Array.prototype.push.apply(o.cameras,c),Array.prototype.push.apply(o.morphTargetManagers,h),o))})}canDirectLoad(e){return e.indexOf("asset")!==-1&&e.indexOf("version")!==-1||e.startsWith("data:base64,"+k._MagicBase64Encoded)||e.startsWith("data:;base64,"+k._MagicBase64Encoded)||e.startsWith("data:application/octet-stream;base64,"+k._MagicBase64Encoded)||e.startsWith("data:model/gltf-binary;base64,"+k._MagicBase64Encoded)}directLoad(e,t){if(t.startsWith("base64,"+k._MagicBase64Encoded)||t.startsWith(";base64,"+k._MagicBase64Encoded)||t.startsWith("application/octet-stream;base64,"+k._MagicBase64Encoded)||t.startsWith("model/gltf-binary;base64,"+k._MagicBase64Encoded)){const s=jt(t);return this._validate(e,new Uint8Array(s,0,s.byteLength)),this._unpackBinaryAsync(new Ie({readAsync:(n,r)=>Ft(s,n,r),byteLength:s.byteLength}))}return this._validate(e,t),Promise.resolve({json:this._parseJson(t)})}createPlugin(){return new k}get loaderState(){return this._state}whenCompleteAsync(){return new Promise((e,t)=>{this.onCompleteObservable.addOnce(()=>{e()}),this.onErrorObservable.addOnce(s=>{t(s)})})}_setState(e){this._state!==e&&(this._state=e,this.onLoaderStateChangedObservable.notifyObservers(this._state),this._log(J[this._state]))}_loadFile(e,t,s,n,r,o){const a=e._loadFile(t,s,l=>{this._onProgress(l,a)},!0,n,r,o);return a.onCompleteObservable.add(l=>{this._requests.splice(this._requests.indexOf(l),1)}),this._requests.push(a),a}_onProgress(e,t){if(!this._progressCallback)return;t._lengthComputable=e.lengthComputable,t._loaded=e.loaded,t._total=e.total;let s=!0,n=0,r=0;for(const o of this._requests){if(o._lengthComputable===void 0||o._loaded===void 0||o._total===void 0)return;s=s&&o._lengthComputable,n+=o._loaded,r+=o._total}this._progressCallback({lengthComputable:s,loaded:n,total:s?r:0})}_validate(e,t,s="",n=""){this.validate&&(this._startPerformanceCounter("Validate JSON"),Yt.ValidateAsync(t,s,n,r=>this.preprocessUrlAsync(s+r).then(o=>e._loadFileAsync(o,void 0,!0,!0).then(a=>new Uint8Array(a,0,a.byteLength)))).then(r=>{this._endPerformanceCounter("Validate JSON"),this.onValidatedObservable.notifyObservers(r),this.onValidatedObservable.clear()},r=>{this._endPerformanceCounter("Validate JSON"),S.Warn(`Failed to validate: ${r.message}`),this.onValidatedObservable.clear()}))}_getLoader(e){const t=e.json.asset||{};this._log(`Asset version: ${t.version}`),t.minVersion&&this._log(`Asset minimum version: ${t.minVersion}`),t.generator&&this._log(`Asset generator: ${t.generator}`);const s=k._parseVersion(t.version);if(!s)throw new Error("Invalid version: "+t.version);if(t.minVersion!==void 0){const o=k._parseVersion(t.minVersion);if(!o)throw new Error("Invalid minimum version: "+t.minVersion);if(k._compareVersion(o,{major:2,minor:0})>0)throw new Error("Incompatible minimum version: "+t.minVersion)}const r={1:k._CreateGLTF1Loader,2:k._CreateGLTF2Loader}[s.major];if(!r)throw new Error("Unsupported version: "+t.version);return r(this)}_parseJson(e){this._startPerformanceCounter("Parse JSON"),this._log(`JSON length: ${e.length}`);const t=JSON.parse(e);return this._endPerformanceCounter("Parse JSON"),t}_unpackBinaryAsync(e){return this._startPerformanceCounter("Unpack Binary"),e.loadAsync(20).then(()=>{const t={Magic:1179937895},s=e.readUint32();if(s!==t.Magic)throw new is("Unexpected magic: "+s,as.GLTFLoaderUnexpectedMagicError);const n=e.readUint32();this.loggingEnabled&&this._log(`Binary version: ${n}`);const r=e.readUint32();!this.useRangeRequests&&r!==e.buffer.byteLength&&U.Warn(`Length in header does not match actual data length: ${r} != ${e.buffer.byteLength}`);let o;switch(n){case 1:{o=this._unpackBinaryV1Async(e,r);break}case 2:{o=this._unpackBinaryV2Async(e,r);break}default:throw new Error("Unsupported version: "+n)}return this._endPerformanceCounter("Unpack Binary"),o})}_unpackBinaryV1Async(e,t){const s={JSON:0},n=e.readUint32(),r=e.readUint32();if(r!==s.JSON)throw new Error(`Unexpected content format: ${r}`);const o=t-e.byteOffset,a={json:this._parseJson(e.readString(n)),bin:null};if(o!==0){const l=e.byteOffset;a.bin={readAsync:(c,h)=>e.buffer.readAsync(l+c,h),byteLength:o}}return Promise.resolve(a)}_unpackBinaryV2Async(e,t){const s={JSON:1313821514,BIN:5130562},n=e.readUint32();if(e.readUint32()!==s.JSON)throw new Error("First chunk format is not JSON");return e.byteOffset+n===t?e.loadAsync(n).then(()=>({json:this._parseJson(e.readString(n)),bin:null})):e.loadAsync(n+8).then(()=>{const o={json:this._parseJson(e.readString(n)),bin:null},a=()=>{const l=e.readUint32();switch(e.readUint32()){case s.JSON:throw new Error("Unexpected JSON chunk");case s.BIN:{const h=e.byteOffset;o.bin={readAsync:(d,u)=>e.buffer.readAsync(h+d,u),byteLength:l},e.skipBytes(l);break}default:{e.skipBytes(l);break}}return e.byteOffset!==t?e.loadAsync(8).then(a):Promise.resolve(o)};return a()})}static _parseVersion(e){if(e==="1.0"||e==="1.0.1")return{major:1,minor:0};const t=(e+"").match(/^(\d+)\.(\d+)/);return t?{major:parseInt(t[1]),minor:parseInt(t[2])}:null}static _compareVersion(e,t){return e.major>t.major?1:e.major<t.major?-1:e.minor>t.minor?1:e.minor<t.minor?-1:0}_logOpen(e){this._log(e),this._logIndentLevel++}_logClose(){--this._logIndentLevel}_logEnabled(e){const t=k._logSpaces.substr(0,this._logIndentLevel*2);U.Log(`${t}${e}`)}_logDisabled(e){}_startPerformanceCounterEnabled(e){S.StartPerformanceCounter(e)}_startPerformanceCounterDisabled(e){}_endPerformanceCounterEnabled(e){S.EndPerformanceCounter(e)}_endPerformanceCounterDisabled(e){}}k.IncrementalLoading=!0;k.HomogeneousCoordinates=!1;k._MagicBase64Encoded="Z2xURg";k._logSpaces="                                ";ce&&ce.RegisterPlugin(new k);var ae;(function(i){i[i.BYTE=5120]="BYTE",i[i.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",i[i.SHORT=5122]="SHORT",i[i.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",i[i.FLOAT=5126]="FLOAT"})(ae||(ae={}));var ke;(function(i){i[i.FRAGMENT=35632]="FRAGMENT",i[i.VERTEX=35633]="VERTEX"})(ke||(ke={}));var X;(function(i){i[i.BYTE=5120]="BYTE",i[i.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",i[i.SHORT=5122]="SHORT",i[i.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",i[i.INT=5124]="INT",i[i.UNSIGNED_INT=5125]="UNSIGNED_INT",i[i.FLOAT=5126]="FLOAT",i[i.FLOAT_VEC2=35664]="FLOAT_VEC2",i[i.FLOAT_VEC3=35665]="FLOAT_VEC3",i[i.FLOAT_VEC4=35666]="FLOAT_VEC4",i[i.INT_VEC2=35667]="INT_VEC2",i[i.INT_VEC3=35668]="INT_VEC3",i[i.INT_VEC4=35669]="INT_VEC4",i[i.BOOL=35670]="BOOL",i[i.BOOL_VEC2=35671]="BOOL_VEC2",i[i.BOOL_VEC3=35672]="BOOL_VEC3",i[i.BOOL_VEC4=35673]="BOOL_VEC4",i[i.FLOAT_MAT2=35674]="FLOAT_MAT2",i[i.FLOAT_MAT3=35675]="FLOAT_MAT3",i[i.FLOAT_MAT4=35676]="FLOAT_MAT4",i[i.SAMPLER_2D=35678]="SAMPLER_2D"})(X||(X={}));var Oe;(function(i){i[i.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",i[i.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",i[i.REPEAT=10497]="REPEAT"})(Oe||(Oe={}));var se;(function(i){i[i.NEAREST=9728]="NEAREST",i[i.LINEAR=9728]="LINEAR",i[i.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",i[i.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",i[i.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",i[i.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"})(se||(se={}));var Rt;(function(i){i[i.ALPHA=6406]="ALPHA",i[i.RGB=6407]="RGB",i[i.RGBA=6408]="RGBA",i[i.LUMINANCE=6409]="LUMINANCE",i[i.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA"})(Rt||(Rt={}));var Ve;(function(i){i[i.FRONT=1028]="FRONT",i[i.BACK=1029]="BACK",i[i.FRONT_AND_BACK=1032]="FRONT_AND_BACK"})(Ve||(Ve={}));var V;(function(i){i[i.ZERO=0]="ZERO",i[i.ONE=1]="ONE",i[i.SRC_COLOR=768]="SRC_COLOR",i[i.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",i[i.DST_COLOR=774]="DST_COLOR",i[i.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",i[i.SRC_ALPHA=770]="SRC_ALPHA",i[i.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",i[i.DST_ALPHA=772]="DST_ALPHA",i[i.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",i[i.CONSTANT_COLOR=32769]="CONSTANT_COLOR",i[i.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",i[i.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",i[i.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",i[i.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE"})(V||(V={}));class j{static SetMatrix(e,t,s,n,r){let o=null;if(s.semantic==="MODEL"?o=t.getWorldMatrix():s.semantic==="PROJECTION"?o=e.getProjectionMatrix():s.semantic==="VIEW"?o=e.getViewMatrix():s.semantic==="MODELVIEWINVERSETRANSPOSE"?o=Z.Transpose(t.getWorldMatrix().multiply(e.getViewMatrix()).invert()):s.semantic==="MODELVIEW"?o=t.getWorldMatrix().multiply(e.getViewMatrix()):s.semantic==="MODELVIEWPROJECTION"?o=t.getWorldMatrix().multiply(e.getTransformMatrix()):s.semantic==="MODELINVERSE"?o=t.getWorldMatrix().invert():s.semantic==="VIEWINVERSE"?o=e.getViewMatrix().invert():s.semantic==="PROJECTIONINVERSE"?o=e.getProjectionMatrix().invert():s.semantic==="MODELVIEWINVERSE"?o=t.getWorldMatrix().multiply(e.getViewMatrix()).invert():s.semantic==="MODELVIEWPROJECTIONINVERSE"?o=t.getWorldMatrix().multiply(e.getTransformMatrix()).invert():s.semantic==="MODELINVERSETRANSPOSE"&&(o=Z.Transpose(t.getWorldMatrix().invert())),o)switch(s.type){case X.FLOAT_MAT2:r.setMatrix2x2(n,Z.GetAsMatrix2x2(o));break;case X.FLOAT_MAT3:r.setMatrix3x3(n,Z.GetAsMatrix3x3(o));break;case X.FLOAT_MAT4:r.setMatrix(n,o);break}}static SetUniform(e,t,s,n){switch(n){case X.FLOAT:return e.setFloat(t,s),!0;case X.FLOAT_VEC2:return e.setVector2(t,be.FromArray(s)),!0;case X.FLOAT_VEC3:return e.setVector3(t,C.FromArray(s)),!0;case X.FLOAT_VEC4:return e.setVector4(t,ls.FromArray(s)),!0;default:return!1}}static GetWrapMode(e){switch(e){case Oe.CLAMP_TO_EDGE:return B.CLAMP_ADDRESSMODE;case Oe.MIRRORED_REPEAT:return B.MIRROR_ADDRESSMODE;case Oe.REPEAT:return B.WRAP_ADDRESSMODE;default:return B.WRAP_ADDRESSMODE}}static GetByteStrideFromType(e){switch(e.type){case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 1}}static GetTextureFilterMode(e){switch(e){case se.LINEAR:case se.LINEAR_MIPMAP_NEAREST:case se.LINEAR_MIPMAP_LINEAR:return B.TRILINEAR_SAMPLINGMODE;case se.NEAREST:case se.NEAREST_MIPMAP_NEAREST:return B.NEAREST_SAMPLINGMODE;default:return B.BILINEAR_SAMPLINGMODE}}static GetBufferFromBufferView(e,t,s,n,r){s=t.byteOffset+s;const o=e.loadedBufferViews[t.buffer];if(s+n>o.byteLength)throw new Error("Buffer access is out of range");const a=o.buffer;switch(s+=o.byteOffset,r){case ae.BYTE:return new Int8Array(a,s,n);case ae.UNSIGNED_BYTE:return new Uint8Array(a,s,n);case ae.SHORT:return new Int16Array(a,s,n);case ae.UNSIGNED_SHORT:return new Uint16Array(a,s,n);default:return new Float32Array(a,s,n)}}static GetBufferFromAccessor(e,t){const s=e.bufferViews[t.bufferView],n=t.count*j.GetByteStrideFromType(t);return j.GetBufferFromBufferView(e,s,t.byteOffset,n,t.componentType)}static DecodeBufferToText(e){let t="";const s=e.byteLength;for(let n=0;n<s;++n)t+=String.fromCharCode(e[n]);return t}static GetDefaultMaterial(e){if(!j._DefaultMaterial){de.ShadersStore.GLTFDefaultMaterialVertexShader=["precision highp float;","","uniform mat4 worldView;","uniform mat4 projection;","","attribute vec3 position;","","void main(void)","{","    gl_Position = projection * worldView * vec4(position, 1.0);","}"].join(`
`),de.ShadersStore.GLTFDefaultMaterialPixelShader=["precision highp float;","","uniform vec4 u_emission;","","void main(void)","{","    gl_FragColor = u_emission;","}"].join(`
`);const t={vertex:"GLTFDefaultMaterial",fragment:"GLTFDefaultMaterial"},s={attributes:["position"],uniforms:["worldView","projection","u_emission"],samplers:new Array,needAlphaBlending:!1};j._DefaultMaterial=new Kt("GLTFDefaultMaterial",e,t,s),j._DefaultMaterial.setColor4("u_emission",new Re(.5,.5,.5,1))}return j._DefaultMaterial}}j._DefaultMaterial=null;var le;(function(i){i[i.IDENTIFIER=1]="IDENTIFIER",i[i.UNKNOWN=2]="UNKNOWN",i[i.END_OF_INPUT=3]="END_OF_INPUT"})(le||(le={}));class Bt{constructor(e){this._pos=0,this.currentToken=le.UNKNOWN,this.currentIdentifier="",this.currentString="",this.isLetterOrDigitPattern=/^[a-zA-Z0-9]+$/,this._toParse=e,this._maxPos=e.length}getNextToken(){if(this.isEnd())return le.END_OF_INPUT;if(this.currentString=this.read(),this.currentToken=le.UNKNOWN,this.currentString==="_"||this.isLetterOrDigitPattern.test(this.currentString))for(this.currentToken=le.IDENTIFIER,this.currentIdentifier=this.currentString;!this.isEnd()&&(this.isLetterOrDigitPattern.test(this.currentString=this.peek())||this.currentString==="_");)this.currentIdentifier+=this.currentString,this.forward();return this.currentToken}peek(){return this._toParse[this._pos]}read(){return this._toParse[this._pos++]}forward(){this._pos++}isEnd(){return this._pos>=this._maxPos}}const zt=["MODEL","VIEW","PROJECTION","MODELVIEW","MODELVIEWPROJECTION","JOINTMATRIX"],Xt=["world","view","projection","worldView","worldViewProjection","mBones"],lr=["translation","rotation","scale"],cr=["position","rotationQuaternion","scaling"],hr=(i,e)=>{for(const t in i){const s=i[t];e.buffers[t]=s,e.buffersCount++}},dr=(i,e)=>{for(const t in i){const s=i[t];e.shaders[t]=s,e.shaderscount++}},W=(i,e,t)=>{for(const s in i){const n=i[s];t[e][s]=n}},ur=i=>{if(i)for(let e=0;e<i.length/2;e++)i[e*2+1]=1-i[e*2+1]},Dt=i=>{if(i.semantic==="NORMAL")return"normal";if(i.semantic==="POSITION")return"position";if(i.semantic==="JOINT")return"matricesIndices";if(i.semantic==="WEIGHT")return"matricesWeights";if(i.semantic==="COLOR")return"color";if(i.semantic&&i.semantic.indexOf("TEXCOORD_")!==-1){const e=Number(i.semantic.split("_")[1]);return"uv"+(e===0?"":e+1)}return null},fr=i=>{for(const e in i.animations){const t=i.animations[e];if(!t.channels||!t.samplers)continue;let s=null;for(let n=0;n<t.channels.length;n++){const r=t.channels[n],o=t.samplers[r.sampler];if(!o)continue;let a=null,l=null;t.parameters?(a=t.parameters[o.input],l=t.parameters[o.output]):(a=o.input,l=o.output);const c=j.GetBufferFromAccessor(i,i.accessors[a]),h=j.GetBufferFromAccessor(i,i.accessors[l]),d=r.target.id;let u=i.scene.getNodeById(d);if(u===null&&(u=i.scene.getNodeByName(d)),u===null){S.Warn("Creating animation named "+e+". But cannot find node named "+d+" to attach to");continue}const f=u instanceof Ce;let p=r.target.path;const A=lr.indexOf(p);A!==-1&&(p=cr[A]);let m=b.ANIMATIONTYPE_MATRIX;f||(p==="rotationQuaternion"?(m=b.ANIMATIONTYPE_QUATERNION,u.rotationQuaternion=new Y):m=b.ANIMATIONTYPE_VECTOR3);let g=null;const x=[];let w=0,E=!1;f&&s&&s.getKeys().length===c.length&&(g=s,E=!0),E||(i.scene._blockEntityCollection=!!i.assetContainer,g=new b(e,f?"_matrix":p,1,m,b.ANIMATIONLOOPMODE_CYCLE),i.scene._blockEntityCollection=!1);for(let O=0;O<c.length;O++){let I=null;if(p==="rotationQuaternion"?(I=Y.FromArray([h[w],h[w+1],h[w+2],h[w+3]]),w+=4):(I=C.FromArray([h[w],h[w+1],h[w+2]]),w+=3),f){const T=u;let v=C.Zero(),$=new Y,R=C.Zero(),M=T.getBaseMatrix();E&&s&&(M=s.getKeys()[O].value),M.decompose(R,$,v),p==="position"?v=I:p==="rotationQuaternion"?$=I:R=I,I=Z.Compose(R,$,v)}E?s&&(s.getKeys()[O].value=I):x.push({frame:c[O],value:I})}!E&&g&&(g.setKeys(x),u.animations.push(g)),s=g,i.scene.stopAnimation(u),i.scene.beginAnimation(u,0,c[c.length-1],!0,1)}}},Nt=i=>{let e=null;if(i.translation||i.rotation||i.scale){const t=C.FromArray(i.scale||[1,1,1]),s=Y.FromArray(i.rotation||[0,0,0,1]),n=C.FromArray(i.translation||[0,0,0]);e=Z.Compose(t,s,n)}else e=Z.FromArray(i.matrix);return e},Zt=(i,e,t,s)=>{for(let r=0;r<s.bones.length;r++)if(s.bones[r].name===t)return s.bones[r];const n=i.nodes;for(const r in n){const o=n[r];if(!o.jointName)continue;const a=o.children;for(let l=0;l<a.length;l++){const c=i.nodes[a[l]];if(c.jointName&&c.jointName===t){const h=Nt(o),d=new Ce(o.name||"",s,Zt(i,e,o.jointName,s),h);return d.id=r,d}}}return null},_r=(i,e)=>{for(let t=0;t<i.length;t++){const s=i[t];for(let n=0;n<s.node.children.length;n++)if(s.node.children[n]===e)return s.bone}return null},Pe=(i,e)=>{const t=i.nodes;let s=t[e];if(s)return{node:s,id:e};for(const n in t)if(s=t[n],s.jointName===e)return{node:s,id:n};return null},pr=(i,e)=>{for(let t=0;t<i.jointNames.length;t++)if(i.jointNames[t]===e)return!0;return!1},mr=(i,e,t,s)=>{for(const n in i.nodes){const r=i.nodes[n],o=n;if(!r.jointName||pr(t,r.jointName))continue;const a=Nt(r),l=new Ce(r.name||"",e,null,a);l.id=o,s.push({bone:l,node:r,id:o})}for(let n=0;n<s.length;n++){const r=s[n],o=r.node.children;for(let a=0;a<o.length;a++){let l=null;for(let c=0;c<s.length;c++)if(s[c].id===o[a]){l=s[c];break}l&&(l.bone._parent=r.bone,r.bone.children.push(l.bone))}}},Ar=(i,e,t,s)=>{if(s||(s=new Ot(e.name||"","",i.scene)),!e.babylonSkeleton)return s;const n=[],r=[];mr(i,s,e,n),s.bones=[];for(let a=0;a<e.jointNames.length;a++){const l=Pe(i,e.jointNames[a]);if(!l)continue;const c=l.node;if(!c){S.Warn("Joint named "+e.jointNames[a]+" does not exist");continue}const h=l.id,d=i.scene.getBoneById(h);if(d){s.bones.push(d);continue}let u=!1,f=null;for(let m=0;m<a;m++){const g=Pe(i,e.jointNames[m]);if(!g)continue;const x=g.node;if(!x){S.Warn("Joint named "+e.jointNames[m]+" does not exist when looking for parent");continue}const w=x.children;if(w){u=!1;for(let E=0;E<w.length;E++)if(w[E]===h){f=Zt(i,e,e.jointNames[m],s),u=!0;break}if(u)break}}const p=Nt(c);!f&&n.length>0&&(f=_r(n,h),f&&r.indexOf(f)===-1&&r.push(f));const A=new Ce(c.jointName||"",s,f,p);A.id=h}const o=s.bones;s.bones=[];for(let a=0;a<e.jointNames.length;a++){const l=Pe(i,e.jointNames[a]);if(l){for(let c=0;c<o.length;c++)if(o[c].id===l.id){s.bones.push(o[c]);break}}}s.prepare();for(let a=0;a<r.length;a++)s.bones.push(r[a]);return s},$t=(i,e,t,s,n)=>{if(n||(i.scene._blockEntityCollection=!!i.assetContainer,n=new oe(e.name||"",i.scene),n._parentContainer=i.assetContainer,i.scene._blockEntityCollection=!1,n.id=s),!e.babylonNode)return n;const r=[];let o=null;const a=[],l=[],c=[],h=[];for(let f=0;f<t.length;f++){const p=t[f],A=i.meshes[p];if(A)for(let m=0;m<A.primitives.length;m++){const g=new De,x=A.primitives[m];x.mode;const w=x.attributes;let E=null,O=null;for(const T in w)if(E=i.accessors[w[T]],O=j.GetBufferFromAccessor(i,E),T==="NORMAL")g.normals=new Float32Array(O.length),g.normals.set(O);else if(T==="POSITION"){if(k.HomogeneousCoordinates){g.positions=new Float32Array(O.length-O.length/4);for(let v=0;v<O.length;v+=4)g.positions[v]=O[v],g.positions[v+1]=O[v+1],g.positions[v+2]=O[v+2]}else g.positions=new Float32Array(O.length),g.positions.set(O);l.push(g.positions.length)}else if(T.indexOf("TEXCOORD_")!==-1){const v=Number(T.split("_")[1]),$=N.UVKind+(v===0?"":v+1),R=new Float32Array(O.length);R.set(O),ur(R),g.set(R,$)}else T==="JOINT"?(g.matricesIndices=new Float32Array(O.length),g.matricesIndices.set(O)):T==="WEIGHT"?(g.matricesWeights=new Float32Array(O.length),g.matricesWeights.set(O)):T==="COLOR"&&(g.colors=new Float32Array(O.length),g.colors.set(O));if(E=i.accessors[x.indices],E)O=j.GetBufferFromAccessor(i,E),g.indices=new Int32Array(O.length),g.indices.set(O),h.push(g.indices.length);else{const T=[];for(let v=0;v<g.positions.length/3;v++)T.push(v);g.indices=new Int32Array(T),h.push(g.indices.length)}o?o.merge(g):o=g;const I=i.scene.getMaterialById(x.material);r.push(I===null?j.GetDefaultMaterial(i.scene):I),a.push(a.length===0?0:a[a.length-1]+l[l.length-2]),c.push(c.length===0?0:c[c.length-1]+h[h.length-2])}}let d;i.scene._blockEntityCollection=!!i.assetContainer,r.length>1?(d=new hs("multimat"+s,i.scene),d.subMaterials=r):d=new we("multimat"+s,i.scene),r.length===1&&(d=r[0]),d._parentContainer=i.assetContainer,n.material||(n.material=d),new Me(s,i.scene,o,!1,n),n.computeWorldMatrix(!0),i.scene._blockEntityCollection=!1,n.subMeshes=[];let u=0;for(let f=0;f<t.length;f++){const p=t[f],A=i.meshes[p];if(A)for(let m=0;m<A.primitives.length;m++)A.primitives[m].mode,ds.AddToMesh(u,a[u],l[u],c[u],h[u],n,n,!0),u++}return n},Ge=(i,e,t,s)=>{i.position&&(i.position=e),(i.rotationQuaternion||i.rotation)&&(i.rotationQuaternion=t),i.scaling&&(i.scaling=s)},gr=(i,e)=>{if(e.matrix){const t=new C(0,0,0),s=new Y,n=new C(0,0,0);Z.FromArray(e.matrix).decompose(n,s,t),Ge(i,t,s,n)}else e.translation&&e.rotation&&e.scale&&Ge(i,C.FromArray(e.translation),Y.FromArray(e.rotation),C.FromArray(e.scale));i.computeWorldMatrix(!0)},yr=(i,e,t)=>{let s=null;if(i.importOnlyMeshes&&(e.skin||e.meshes)&&i.importMeshesNames&&i.importMeshesNames.length>0&&i.importMeshesNames.indexOf(e.name||"")===-1)return null;if(e.skin){if(e.meshes){const n=i.skins[e.skin],r=$t(i,e,e.meshes,t,e.babylonNode);r.skeleton=i.scene.getLastSkeletonById(e.skin),r.skeleton===null&&(r.skeleton=Ar(i,n,r,n.babylonSkeleton),n.babylonSkeleton||(n.babylonSkeleton=r.skeleton)),s=r}}else if(e.meshes)s=$t(i,e,e.mesh?[e.mesh]:e.meshes,t,e.babylonNode);else if(e.light&&!e.babylonNode&&!i.importOnlyMeshes){const n=i.lights[e.light];if(n){if(n.type==="ambient"){const r=n[n.type],o=new Wt(e.light,C.Zero(),i.scene);o.name=e.name||"",r.color&&(o.diffuse=L.FromArray(r.color)),s=o}else if(n.type==="directional"){const r=n[n.type],o=new Tt(e.light,C.Zero(),i.scene);o.name=e.name||"",r.color&&(o.diffuse=L.FromArray(r.color)),s=o}else if(n.type==="point"){const r=n[n.type],o=new Et(e.light,C.Zero(),i.scene);o.name=e.name||"",r.color&&(o.diffuse=L.FromArray(r.color)),s=o}else if(n.type==="spot"){const r=n[n.type],o=new wt(e.light,C.Zero(),C.Zero(),0,0,i.scene);o.name=e.name||"",r.color&&(o.diffuse=L.FromArray(r.color)),r.fallOfAngle&&(o.angle=r.fallOfAngle),r.fallOffExponent&&(o.exponent=r.fallOffExponent),s=o}}}else if(e.camera&&!e.babylonNode&&!i.importOnlyMeshes){const n=i.cameras[e.camera];if(n){if(i.scene._blockEntityCollection=!!i.assetContainer,n.type==="orthographic"){const r=new Be(e.camera,C.Zero(),i.scene,!1);r.name=e.name||"",r.mode=qt.ORTHOGRAPHIC_CAMERA,r.attachControl(),s=r,r._parentContainer=i.assetContainer}else if(n.type==="perspective"){const r=n[n.type],o=new Be(e.camera,C.Zero(),i.scene,!1);o.name=e.name||"",o.attachControl(),r.aspectRatio||(r.aspectRatio=i.scene.getEngine().getRenderWidth()/i.scene.getEngine().getRenderHeight()),r.znear&&r.zfar&&(o.maxZ=r.zfar,o.minZ=r.znear),s=o,o._parentContainer=i.assetContainer}i.scene._blockEntityCollection=!1}}if(!e.jointName){if(e.babylonNode)return e.babylonNode;if(s===null){i.scene._blockEntityCollection=!!i.assetContainer;const n=new oe(e.name||"",i.scene);n._parentContainer=i.assetContainer,i.scene._blockEntityCollection=!1,e.babylonNode=n,s=n}}if(s!==null){if(e.matrix&&s instanceof oe)gr(s,e);else{const n=e.translation||[0,0,0],r=e.rotation||[0,0,0,1],o=e.scale||[1,1,1];Ge(s,C.FromArray(n),Y.FromArray(r),C.FromArray(o))}s.updateCache(!0),e.babylonNode=s}return s},Ee=(i,e,t,s=!1)=>{const n=i.nodes[e];let r=null;if(i.importOnlyMeshes&&!s&&i.importMeshesNames?i.importMeshesNames.indexOf(n.name||"")!==-1||i.importMeshesNames.length===0?s=!0:s=!1:s=!0,!n.jointName&&s&&(r=yr(i,n,e),r!==null&&(r.id=e,r.parent=t)),n.children)for(let o=0;o<n.children.length;o++)Ee(i,n.children[o],r,s)},kt=i=>{let e=i.currentScene;if(e)for(let t=0;t<e.nodes.length;t++)Ee(i,e.nodes[t],null);else for(const t in i.scenes){e=i.scenes[t];for(let s=0;s<e.nodes.length;s++)Ee(i,e.nodes[s],null)}fr(i);for(let t=0;t<i.scene.skeletons.length;t++){const s=i.scene.skeletons[t];i.scene.beginAnimation(s,0,Number.MAX_VALUE,!0,1)}},br=(i,e,t,s,n,r,o)=>{const a=r.values||n.parameters;for(const l in t){const c=t[l],h=c.type;if(h===X.FLOAT_MAT2||h===X.FLOAT_MAT3||h===X.FLOAT_MAT4){if(c.semantic&&!c.source&&!c.node)j.SetMatrix(e.scene,i,c,l,s.getEffect());else if(c.semantic&&(c.source||c.node)){let d=e.scene.getNodeByName(c.source||c.node||"");if(d===null&&(d=e.scene.getNodeById(c.source||c.node||"")),d===null)continue;j.SetMatrix(e.scene,d,c,l,s.getEffect())}}else{const d=a[n.uniforms[l]];if(!d)continue;if(h===X.SAMPLER_2D){const u=e.textures[r.values?d:c.value].babylonTexture;if(u==null)continue;s.getEffect().setTexture(l,u)}else j.SetUniform(s.getEffect(),l,d,h)}}o(s)},Or=(i,e,t,s,n)=>{const r=s.values||t.parameters,o=t.uniforms;for(const a in n){const l=n[a],c=l.type;let h=r[o[a]];if(h===void 0&&(h=l.value),!h)continue;const d=u=>f=>{l.value&&u&&(e.setTexture(u,f),delete n[u])};c===X.SAMPLER_2D?K.LoadTextureAsync(i,s.values?h:l.value,d(a),()=>d(null)):l.value&&j.SetUniform(e,a,s.values?h:l.value,c)&&delete n[a]}},Tr=(i,e,t)=>(s,n)=>{e.dispose(!0),t("Cannot compile program named "+i.name+". Error: "+n+". Default material will be applied")},Er=(i,e,t,s,n,r)=>o=>{Or(i,e,t,s,n),e.onBind=a=>{br(a,i,n,e,t,s,r)}},Vt=(i,e,t)=>{for(const s in e.uniforms){const n=e.uniforms[s],r=e.parameters[n];if(i.currentIdentifier===s&&r.semantic&&!r.source&&!r.node){const o=zt.indexOf(r.semantic);if(o!==-1)return delete t[s],Xt[o]}}return i.currentIdentifier},Gt=i=>{for(const e in i.materials)K.LoadMaterialAsync(i,e,()=>{},()=>{})};class re{static CreateRuntime(e,t,s){const n={extensions:{},accessors:{},buffers:{},bufferViews:{},meshes:{},lights:{},cameras:{},nodes:{},images:{},textures:{},shaders:{},programs:{},samplers:{},techniques:{},materials:{},animations:{},skins:{},extensionsUsed:[],scenes:{},buffersCount:0,shaderscount:0,scene:t,rootUrl:s,loadedBufferCount:0,loadedBufferViews:{},loadedShaderCount:0,importOnlyMeshes:!1,dummyNodes:[],assetContainer:null};return e.extensions&&W(e.extensions,"extensions",n),e.extensionsUsed&&W(e.extensionsUsed,"extensionsUsed",n),e.buffers&&hr(e.buffers,n),e.bufferViews&&W(e.bufferViews,"bufferViews",n),e.accessors&&W(e.accessors,"accessors",n),e.meshes&&W(e.meshes,"meshes",n),e.lights&&W(e.lights,"lights",n),e.cameras&&W(e.cameras,"cameras",n),e.nodes&&W(e.nodes,"nodes",n),e.images&&W(e.images,"images",n),e.textures&&W(e.textures,"textures",n),e.shaders&&dr(e.shaders,n),e.programs&&W(e.programs,"programs",n),e.samplers&&W(e.samplers,"samplers",n),e.techniques&&W(e.techniques,"techniques",n),e.materials&&W(e.materials,"materials",n),e.animations&&W(e.animations,"animations",n),e.skins&&W(e.skins,"skins",n),e.scenes&&(n.scenes=e.scenes),e.scene&&e.scenes&&(n.currentScene=e.scenes[e.scene]),n}static LoadBufferAsync(e,t,s,n,r){const o=e.buffers[t];S.IsBase64(o.uri)?setTimeout(()=>s(new Uint8Array(S.DecodeBase64(o.uri)))):S.LoadFile(e.rootUrl+o.uri,a=>s(new Uint8Array(a)),r,void 0,!0,a=>{a&&n(a.status+" "+a.statusText)})}static LoadTextureBufferAsync(e,t,s,n){const r=e.textures[t];if(!r||!r.source){n("");return}if(r.babylonTexture){s(null);return}const o=e.images[r.source];S.IsBase64(o.uri)?setTimeout(()=>s(new Uint8Array(S.DecodeBase64(o.uri)))):S.LoadFile(e.rootUrl+o.uri,a=>s(new Uint8Array(a)),void 0,void 0,!0,a=>{a&&n(a.status+" "+a.statusText)})}static CreateTextureAsync(e,t,s,n){const r=e.textures[t];if(r.babylonTexture){n(r.babylonTexture);return}const o=e.samplers[r.sampler],a=o.minFilter===se.NEAREST_MIPMAP_NEAREST||o.minFilter===se.NEAREST_MIPMAP_LINEAR||o.minFilter===se.LINEAR_MIPMAP_NEAREST||o.minFilter===se.LINEAR_MIPMAP_LINEAR,l=B.BILINEAR_SAMPLINGMODE,c=s==null?new Blob:new Blob([s]),h=URL.createObjectURL(c),d=()=>URL.revokeObjectURL(h),u=new B(h,e.scene,!a,!0,l,d,d);o.wrapS!==void 0&&(u.wrapU=j.GetWrapMode(o.wrapS)),o.wrapT!==void 0&&(u.wrapV=j.GetWrapMode(o.wrapT)),u.name=t,r.babylonTexture=u,n(u)}static LoadShaderStringAsync(e,t,s,n){const r=e.shaders[t];if(S.IsBase64(r.uri)){const o=atob(r.uri.split(",")[1]);s&&s(o)}else S.LoadFile(e.rootUrl+r.uri,s,void 0,void 0,!1,o=>{o&&n&&n(o.status+" "+o.statusText)})}static LoadMaterialAsync(e,t,s,n){const r=e.materials[t];if(!r.technique){n&&n("No technique found.");return}const o=e.techniques[r.technique];if(!o){e.scene._blockEntityCollection=!!e.assetContainer;const I=new we(t,e.scene);I._parentContainer=e.assetContainer,e.scene._blockEntityCollection=!1,I.diffuseColor=new L(.5,.5,.5),I.sideOrientation=ee.CounterClockWiseSideOrientation,s(I);return}const a=e.programs[o.program],l=o.states,c=de.ShadersStore[a.vertexShader+"VertexShader"],h=de.ShadersStore[a.fragmentShader+"PixelShader"];let d="",u="";const f=new Bt(c),p=new Bt(h),A={},m=[],g=[],x=[];for(const I in o.uniforms){const T=o.uniforms[I],v=o.parameters[T];if(A[I]=v,v.semantic&&!v.node&&!v.source){const $=zt.indexOf(v.semantic);$!==-1?(m.push(Xt[$]),delete A[I]):m.push(I)}else v.type===X.SAMPLER_2D?x.push(I):m.push(I)}for(const I in o.attributes){const T=o.attributes[I],v=o.parameters[T];if(v.semantic){const $=Dt(v);$&&g.push($)}}for(;!f.isEnd()&&f.getNextToken();){if(f.currentToken!==le.IDENTIFIER){d+=f.currentString;continue}let T=!1;for(const v in o.attributes){const $=o.attributes[v],R=o.parameters[$];if(f.currentIdentifier===v&&R.semantic){d+=Dt(R),T=!0;break}}T||(d+=Vt(f,o,A))}for(;!p.isEnd()&&p.getNextToken();){if(p.currentToken!==le.IDENTIFIER){u+=p.currentString;continue}u+=Vt(p,o,A)}const w={vertex:a.vertexShader+t,fragment:a.fragmentShader+t},E={attributes:g,uniforms:m,samplers:x,needAlphaBlending:l&&l.enable&&l.enable.indexOf(3042)!==-1};de.ShadersStore[a.vertexShader+t+"VertexShader"]=d,de.ShadersStore[a.fragmentShader+t+"PixelShader"]=u;const O=new Kt(t,e.scene,w,E);if(O.onError=Tr(a,O,n),O.onCompiled=Er(e,O,o,r,A,s),O.sideOrientation=ee.CounterClockWiseSideOrientation,l&&l.functions){const I=l.functions;I.cullFace&&I.cullFace[0]!==Ve.BACK&&(O.backFaceCulling=!1);const T=I.blendFuncSeparate;T&&(T[0]===V.SRC_ALPHA&&T[1]===V.ONE_MINUS_SRC_ALPHA&&T[2]===V.ONE&&T[3]===V.ONE?O.alphaMode=he.ALPHA_COMBINE:T[0]===V.ONE&&T[1]===V.ONE&&T[2]===V.ZERO&&T[3]===V.ONE?O.alphaMode=he.ALPHA_ONEONE:T[0]===V.SRC_ALPHA&&T[1]===V.ONE&&T[2]===V.ZERO&&T[3]===V.ONE?O.alphaMode=he.ALPHA_ADD:T[0]===V.ZERO&&T[1]===V.ONE_MINUS_SRC_COLOR&&T[2]===V.ONE&&T[3]===V.ONE?O.alphaMode=he.ALPHA_SUBTRACT:T[0]===V.DST_COLOR&&T[1]===V.ZERO&&T[2]===V.ONE&&T[3]===V.ONE?O.alphaMode=he.ALPHA_MULTIPLY:T[0]===V.SRC_ALPHA&&T[1]===V.ONE_MINUS_SRC_COLOR&&T[2]===V.ONE&&T[3]===V.ONE&&(O.alphaMode=he.ALPHA_MAXIMIZED))}}}let pe=class Ue{static RegisterExtension(e){if(Ue.Extensions[e.name]){S.Error('Tool with the same name "'+e.name+'" already exists');return}Ue.Extensions[e.name]=e}dispose(){}_importMeshAsync(e,t,s,n,r,o,a,l){return t.useRightHandedSystem=!0,K.LoadRuntimeAsync(t,s,n,c=>{c.assetContainer=r,c.importOnlyMeshes=!0,e===""?c.importMeshesNames=[]:typeof e=="string"?c.importMeshesNames=[e]:e&&!(e instanceof Array)?c.importMeshesNames=[e]:(c.importMeshesNames=[],S.Warn("Argument meshesNames must be of type string or string[]")),this._createNodes(c);const h=[],d=[];for(const u in c.nodes){const f=c.nodes[u];f.babylonNode instanceof cs&&h.push(f.babylonNode)}for(const u in c.skins){const f=c.skins[u];f.babylonSkeleton instanceof Ot&&d.push(f.babylonSkeleton)}this._loadBuffersAsync(c,()=>{this._loadShadersAsync(c,()=>{Gt(c),kt(c),!k.IncrementalLoading&&o&&o(h,d)})}),k.IncrementalLoading&&o&&o(h,d)},l),!0}importMeshAsync(e,t,s,n,r,o){return new Promise((a,l)=>{this._importMeshAsync(e,t,n,r,s,(c,h)=>{a({meshes:c,particleSystems:[],skeletons:h,animationGroups:[],lights:[],transformNodes:[],geometries:[]})},o,c=>{l(new Error(c))})})}_loadAsync(e,t,s,n,r,o){e.useRightHandedSystem=!0,K.LoadRuntimeAsync(e,t,s,a=>{K.LoadRuntimeExtensionsAsync(a,()=>{this._createNodes(a),this._loadBuffersAsync(a,()=>{this._loadShadersAsync(a,()=>{Gt(a),kt(a),k.IncrementalLoading||n()})}),k.IncrementalLoading&&n()},o)},o)}loadAsync(e,t,s,n){return new Promise((r,o)=>{this._loadAsync(e,t,s,()=>{r()},n,a=>{o(new Error(a))})})}_loadShadersAsync(e,t){let s=!1;const n=(r,o)=>{K.LoadShaderStringAsync(e,r,a=>{a instanceof ArrayBuffer||(e.loadedShaderCount++,a&&(de.ShadersStore[r+(o.type===ke.VERTEX?"VertexShader":"PixelShader")]=a),e.loadedShaderCount===e.shaderscount&&t())},()=>{S.Error("Error when loading shader program named "+r+" located at "+o.uri)})};for(const r in e.shaders){s=!0;const o=e.shaders[r];o?n.bind(this,r,o)():S.Error("No shader named: "+r)}s||t()}_loadBuffersAsync(e,t){let s=!1;const n=(r,o)=>{K.LoadBufferAsync(e,r,a=>{e.loadedBufferCount++,a&&(a.byteLength!=e.buffers[r].byteLength&&S.Error("Buffer named "+r+" is length "+a.byteLength+". Expected: "+o.byteLength),e.loadedBufferViews[r]=a),e.loadedBufferCount===e.buffersCount&&t()},()=>{S.Error("Error when loading buffer named "+r+" located at "+o.uri)})};for(const r in e.buffers){s=!0;const o=e.buffers[r];o?n.bind(this,r,o)():S.Error("No buffer named: "+r)}s||t()}_createNodes(e){let t=e.currentScene;if(t)for(let s=0;s<t.nodes.length;s++)Ee(e,t.nodes[s],null);else for(const s in e.scenes){t=e.scenes[s];for(let n=0;n<t.nodes.length;n++)Ee(e,t.nodes[n],null)}}};pe.Extensions={};class K{constructor(e){this._name=e}get name(){return this._name}loadRuntimeAsync(e,t,s,n,r){return!1}loadRuntimeExtensionsAsync(e,t,s){return!1}loadBufferAsync(e,t,s,n,r){return!1}loadTextureBufferAsync(e,t,s,n){return!1}createTextureAsync(e,t,s,n,r){return!1}loadShaderStringAsync(e,t,s,n){return!1}loadMaterialAsync(e,t,s,n){return!1}static LoadRuntimeAsync(e,t,s,n,r){K._ApplyExtensions(o=>o.loadRuntimeAsync(e,t,s,n,r),()=>{setTimeout(()=>{n&&n(re.CreateRuntime(t.json,e,s))})})}static LoadRuntimeExtensionsAsync(e,t,s){K._ApplyExtensions(n=>n.loadRuntimeExtensionsAsync(e,t,s),()=>{setTimeout(()=>{t()})})}static LoadBufferAsync(e,t,s,n,r){K._ApplyExtensions(o=>o.loadBufferAsync(e,t,s,n,r),()=>{re.LoadBufferAsync(e,t,s,n,r)})}static LoadTextureAsync(e,t,s,n){K._LoadTextureBufferAsync(e,t,r=>{r&&K._CreateTextureAsync(e,t,r,s,n)},n)}static LoadShaderStringAsync(e,t,s,n){K._ApplyExtensions(r=>r.loadShaderStringAsync(e,t,s,n),()=>{re.LoadShaderStringAsync(e,t,s,n)})}static LoadMaterialAsync(e,t,s,n){K._ApplyExtensions(r=>r.loadMaterialAsync(e,t,s,n),()=>{re.LoadMaterialAsync(e,t,s,n)})}static _LoadTextureBufferAsync(e,t,s,n){K._ApplyExtensions(r=>r.loadTextureBufferAsync(e,t,s,n),()=>{re.LoadTextureBufferAsync(e,t,s,n)})}static _CreateTextureAsync(e,t,s,n,r){K._ApplyExtensions(o=>o.createTextureAsync(e,t,s,n,r),()=>{re.CreateTextureAsync(e,t,s,n)})}static _ApplyExtensions(e,t){for(const s in pe.Extensions){const n=pe.Extensions[s];if(e(n))return}t()}}k._CreateGLTF1Loader=()=>new pe;const wr="binary_glTF";class Cr extends K{constructor(){super("KHR_binary_glTF")}loadRuntimeAsync(e,t,s,n){const r=t.json.extensionsUsed;return!r||r.indexOf(this.name)===-1||!t.bin?!1:(this._bin=t.bin,n(re.CreateRuntime(t.json,e,s)),!0)}loadBufferAsync(e,t,s,n){return e.extensionsUsed.indexOf(this.name)===-1||t!==wr?!1:(this._bin.readAsync(0,this._bin.byteLength).then(s,r=>n(r.message)),!0)}loadTextureBufferAsync(e,t,s){const n=e.textures[t],r=e.images[n.source];if(!r.extensions||!(this.name in r.extensions))return!1;const o=r.extensions[this.name],a=e.bufferViews[o.bufferView],l=j.GetBufferFromBufferView(e,a,0,a.byteLength,ae.UNSIGNED_BYTE);return s(l),!0}loadShaderStringAsync(e,t,s){const n=e.shaders[t];if(!n.extensions||!(this.name in n.extensions))return!1;const r=n.extensions[this.name],o=e.bufferViews[r.bufferView],a=j.GetBufferFromBufferView(e,o,0,o.byteLength,ae.UNSIGNED_BYTE);return setTimeout(()=>{const l=j.DecodeBufferToText(a);s(l)}),!0}}pe.RegisterExtension(new Cr);class xr extends K{constructor(){super("KHR_materials_common")}loadRuntimeExtensionsAsync(e){if(!e.extensions)return!1;const t=e.extensions[this.name];if(!t)return!1;const s=t.lights;if(s)for(const n in s){const r=s[n];switch(r.type){case"ambient":{const o=new Wt(r.name,new C(0,1,0),e.scene),a=r.ambient;a&&(o.diffuse=L.FromArray(a.color||[1,1,1]));break}case"point":{const o=new Et(r.name,new C(10,10,10),e.scene),a=r.point;a&&(o.diffuse=L.FromArray(a.color||[1,1,1]));break}case"directional":{const o=new Tt(r.name,new C(0,-1,0),e.scene),a=r.directional;a&&(o.diffuse=L.FromArray(a.color||[1,1,1]));break}case"spot":{const o=r.spot;if(o){const a=new wt(r.name,new C(0,10,0),new C(0,-1,0),o.fallOffAngle||Math.PI,o.fallOffExponent||0,e.scene);a.diffuse=L.FromArray(o.color||[1,1,1])}break}default:S.Warn('GLTF Material Common extension: light type "'+r.type+" not supported");break}}return!1}loadMaterialAsync(e,t,s,n){const r=e.materials[t];if(!r||!r.extensions)return!1;const o=r.extensions[this.name];if(!o)return!1;const a=new we(t,e.scene);return a.sideOrientation=ee.CounterClockWiseSideOrientation,o.technique==="CONSTANT"&&(a.disableLighting=!0),a.backFaceCulling=o.doubleSided===void 0?!1:!o.doubleSided,a.alpha=o.values.transparency===void 0?1:o.values.transparency,a.specularPower=o.values.shininess===void 0?0:o.values.shininess,typeof o.values.ambient=="string"?this._loadTexture(e,o.values.ambient,a,"ambientTexture",n):a.ambientColor=L.FromArray(o.values.ambient||[0,0,0]),typeof o.values.diffuse=="string"?this._loadTexture(e,o.values.diffuse,a,"diffuseTexture",n):a.diffuseColor=L.FromArray(o.values.diffuse||[0,0,0]),typeof o.values.emission=="string"?this._loadTexture(e,o.values.emission,a,"emissiveTexture",n):a.emissiveColor=L.FromArray(o.values.emission||[0,0,0]),typeof o.values.specular=="string"?this._loadTexture(e,o.values.specular,a,"specularTexture",n):a.specularColor=L.FromArray(o.values.specular||[0,0,0]),!0}_loadTexture(e,t,s,n,r){re.LoadTextureBufferAsync(e,t,o=>{re.CreateTextureAsync(e,t,o,a=>s[n]=a)},r)}}pe.RegisterExtension(new xr);function Ut(i,e,t,s){return C.FromArray(e,t).scaleInPlace(s)}function Nr(i,e,t,s){return Y.FromArray(e,t).scaleInPlace(s)}function Ir(i,e,t,s){const n=new Array(i._numMorphTargets);for(let r=0;r<n.length;r++)n[r]=e[t++]*s;return n}class xe{constructor(e,t,s,n){this.type=e,this.name=t,this.getValue=s,this.getStride=n}_buildAnimation(e,t,s){const n=new b(e,this.name,t,this.type);return n.setKeys(s),n}}class Le extends xe{buildAnimations(e,t,s,n,r){r(e._babylonTransformNode,this._buildAnimation(t,s,n))}}class Mr extends xe{buildAnimations(e,t,s,n,r){if(e._numMorphTargets)for(let o=0;o<e._numMorphTargets;o++){const a=new b(`${t}_${o}`,this.name,s,this.type);if(a.setKeys(n.map(l=>({frame:l.frame,inTangent:l.inTangent?l.inTangent[o]:void 0,value:l.value[o],outTangent:l.outTangent?l.outTangent[o]:void 0,interpolation:l.interpolation}))),e._primitiveBabylonMeshes){for(const l of e._primitiveBabylonMeshes)if(l.morphTargetManager){const c=l.morphTargetManager.getTarget(o),h=a.clone();c.animations.push(h),r(c,h)}}}}}const ye={translation:[new Le(b.ANIMATIONTYPE_VECTOR3,"position",Ut,()=>3)],rotation:[new Le(b.ANIMATIONTYPE_QUATERNION,"rotationQuaternion",Nr,()=>4)],scale:[new Le(b.ANIMATIONTYPE_VECTOR3,"scaling",Ut,()=>3)],weights:[new Mr(b.ANIMATIONTYPE_FLOAT,"influence",Ir,i=>i._numMorphTargets)]};function Jt(...i){const e=t=>t&&typeof t=="object";return i.reduce((t,s)=>(Object.keys(s).forEach(n=>{const r=t[n],o=s[n];Array.isArray(r)&&Array.isArray(o)?t[n]=r.concat(...o):e(r)&&e(o)?t[n]=Jt(r,o):t[n]=o}),t),{})}class y{static Get(e,t,s){if(!t||s==null||!t[s])throw new Error(`${e}: Failed to find index (${s})`);return t[s]}static TryGet(e,t){return!e||t==null||!e[t]?null:e[t]}static Assign(e){if(e)for(let t=0;t<e.length;t++)e[t].index=t}}class _{static RegisterExtension(e,t){_.UnregisterExtension(e)&&U.Warn(`Extension with the name '${e}' already exists`),_._RegisteredExtensions[e]={factory:t}}static UnregisterExtension(e){return _._RegisteredExtensions[e]?(delete _._RegisteredExtensions[e],!0):!1}get gltf(){if(!this._gltf)throw new Error("glTF JSON is not available");return this._gltf}get bin(){return this._bin}get parent(){return this._parent}get babylonScene(){if(!this._babylonScene)throw new Error("Scene is not available");return this._babylonScene}get rootBabylonMesh(){return this._rootBabylonMesh}get rootUrl(){return this._rootUrl}constructor(e){this._completePromises=new Array,this._assetContainer=null,this._babylonLights=[],this._disableInstancedMesh=0,this._allMaterialsDirtyRequired=!1,this._extensions=new Array,this._disposed=!1,this._rootUrl=null,this._fileName=null,this._uniqueRootUrl=null,this._bin=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions=new Array,this._parent=e}dispose(){this._disposed||(this._disposed=!0,this._completePromises.length=0,this._extensions.forEach(e=>e.dispose&&e.dispose()),this._extensions.length=0,this._gltf=null,this._bin=null,this._babylonScene=null,this._rootBabylonMesh=null,this._defaultBabylonMaterialData={},this._postSceneLoadActions.length=0,this._parent.dispose())}importMeshAsync(e,t,s,n,r,o,a=""){return Promise.resolve().then(()=>{this._babylonScene=t,this._assetContainer=s,this._loadData(n);let l=null;if(e){const c={};if(this._gltf.nodes)for(const d of this._gltf.nodes)d.name&&(c[d.name]=d.index);l=(e instanceof Array?e:[e]).map(d=>{const u=c[d];if(u===void 0)throw new Error(`Failed to find node '${d}'`);return u})}return this._loadAsync(r,a,l,()=>({meshes:this._getMeshes(),particleSystems:[],skeletons:this._getSkeletons(),animationGroups:this._getAnimationGroups(),lights:this._babylonLights,transformNodes:this._getTransformNodes(),geometries:this._getGeometries()}))})}loadAsync(e,t,s,n,r=""){return Promise.resolve().then(()=>(this._babylonScene=e,this._loadData(t),this._loadAsync(s,r,null,()=>{})))}_loadAsync(e,t,s,n){return Promise.resolve().then(()=>{this._rootUrl=e,this._uniqueRootUrl=!e.startsWith("file:")&&t?e:`${e}${Date.now()}/`,this._fileName=t,this._allMaterialsDirtyRequired=!1,this._loadExtensions(),this._checkExtensions();const r=`${J[J.LOADING]} => ${J[J.READY]}`,o=`${J[J.LOADING]} => ${J[J.COMPLETE]}`;this._parent._startPerformanceCounter(r),this._parent._startPerformanceCounter(o),this._parent._setState(J.LOADING),this._extensionsOnLoading();const a=new Array,l=this._babylonScene.blockMaterialDirtyMechanism;if(this._babylonScene.blockMaterialDirtyMechanism=!0,!this.parent.loadOnlyMaterials){if(s)a.push(this.loadSceneAsync("/nodes",{nodes:s,index:-1}));else if(this._gltf.scene!=null||this._gltf.scenes&&this._gltf.scenes[0]){const h=y.Get("/scene",this._gltf.scenes,this._gltf.scene||0);a.push(this.loadSceneAsync(`/scenes/${h.index}`,h))}}if(!this.parent.skipMaterials&&this.parent.loadAllMaterials&&this._gltf.materials)for(let h=0;h<this._gltf.materials.length;++h){const d=this._gltf.materials[h],u="/materials/"+h,f=ee.TriangleFillMode;a.push(this._loadMaterialAsync(u,d,null,f,()=>{}))}return this._allMaterialsDirtyRequired?this._babylonScene.blockMaterialDirtyMechanism=l:this._babylonScene._forceBlockMaterialDirtyMechanism(l),this._parent.compileMaterials&&a.push(this._compileMaterialsAsync()),this._parent.compileShadowGenerators&&a.push(this._compileShadowGeneratorsAsync()),Promise.all(a).then(()=>(this._rootBabylonMesh&&this._rootBabylonMesh.setEnabled(!0),this._extensionsOnReady(),this._parent._setState(J.READY),this._startAnimations(),n())).then(h=>(this._parent._endPerformanceCounter(r),S.SetImmediate(()=>{this._disposed||Promise.all(this._completePromises).then(()=>{this._parent._endPerformanceCounter(o),this._parent._setState(J.COMPLETE),this._parent.onCompleteObservable.notifyObservers(void 0),this._parent.onCompleteObservable.clear(),this.dispose()},d=>{this._parent.onErrorObservable.notifyObservers(d),this._parent.onErrorObservable.clear(),this.dispose()})}),h))}).catch(r=>{throw this._disposed||(this._parent.onErrorObservable.notifyObservers(r),this._parent.onErrorObservable.clear(),this.dispose()),r})}_loadData(e){if(this._gltf=e.json,this._setupData(),e.bin){const t=this._gltf.buffers;if(t&&t[0]&&!t[0].uri){const s=t[0];(s.byteLength<e.bin.byteLength-3||s.byteLength>e.bin.byteLength)&&U.Warn(`Binary buffer length (${s.byteLength}) from JSON does not match chunk length (${e.bin.byteLength})`),this._bin=e.bin}else U.Warn("Unexpected BIN chunk")}}_setupData(){if(y.Assign(this._gltf.accessors),y.Assign(this._gltf.animations),y.Assign(this._gltf.buffers),y.Assign(this._gltf.bufferViews),y.Assign(this._gltf.cameras),y.Assign(this._gltf.images),y.Assign(this._gltf.materials),y.Assign(this._gltf.meshes),y.Assign(this._gltf.nodes),y.Assign(this._gltf.samplers),y.Assign(this._gltf.scenes),y.Assign(this._gltf.skins),y.Assign(this._gltf.textures),this._gltf.nodes){const e={};for(const s of this._gltf.nodes)if(s.children)for(const n of s.children)e[n]=s.index;const t=this._createRootNode();for(const s of this._gltf.nodes){const n=e[s.index];s.parent=n===void 0?t:this._gltf.nodes[n]}}}_loadExtensions(){for(const e in _._RegisteredExtensions){const t=_._RegisteredExtensions[e].factory(this);t.name!==e&&U.Warn(`The name of the glTF loader extension instance does not match the registered name: ${t.name} !== ${e}`),this._extensions.push(t),this._parent.onExtensionLoadedObservable.notifyObservers(t)}this._extensions.sort((e,t)=>(e.order||Number.MAX_VALUE)-(t.order||Number.MAX_VALUE)),this._parent.onExtensionLoadedObservable.clear()}_checkExtensions(){if(this._gltf.extensionsRequired){for(const e of this._gltf.extensionsRequired)if(!this._extensions.some(s=>s.name===e&&s.enabled))throw new Error(`Required extension ${e} is not available`)}}_createRootNode(){this._babylonScene._blockEntityCollection=!!this._assetContainer,this._rootBabylonMesh=new oe("__root__",this._babylonScene),this._rootBabylonMesh._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._rootBabylonMesh.setEnabled(!1);const e={_babylonTransformNode:this._rootBabylonMesh,index:-1};switch(this._parent.coordinateSystemMode){case Te.AUTO:{this._babylonScene.useRightHandedSystem||(e.rotation=[0,1,0,0],e.scale=[1,1,-1],_._LoadTransform(e,this._rootBabylonMesh));break}case Te.FORCE_RIGHT_HANDED:{this._babylonScene.useRightHandedSystem=!0;break}default:throw new Error(`Invalid coordinate system mode (${this._parent.coordinateSystemMode})`)}return this._parent.onMeshLoadedObservable.notifyObservers(this._rootBabylonMesh),e}loadSceneAsync(e,t){const s=this._extensionsLoadSceneAsync(e,t);if(s)return s;const n=new Array;if(this.logOpen(`${e} ${t.name||""}`),t.nodes)for(const r of t.nodes){const o=y.Get(`${e}/nodes/${r}`,this._gltf.nodes,r);n.push(this.loadNodeAsync(`/nodes/${o.index}`,o,a=>{a.parent=this._rootBabylonMesh}))}for(const r of this._postSceneLoadActions)r();return n.push(this._loadAnimationsAsync()),this.logClose(),Promise.all(n).then(()=>{})}_forEachPrimitive(e,t){if(e._primitiveBabylonMeshes)for(const s of e._primitiveBabylonMeshes)t(s)}_getGeometries(){const e=[],t=this._gltf.nodes;if(t)for(const s of t)this._forEachPrimitive(s,n=>{const r=n.geometry;r&&e.indexOf(r)===-1&&e.push(r)});return e}_getMeshes(){const e=[];this._rootBabylonMesh&&e.push(this._rootBabylonMesh);const t=this._gltf.nodes;if(t)for(const s of t)this._forEachPrimitive(s,n=>{e.push(n)});return e}_getTransformNodes(){const e=[],t=this._gltf.nodes;if(t)for(const s of t)s._babylonTransformNode&&s._babylonTransformNode.getClassName()==="TransformNode"&&e.push(s._babylonTransformNode),s._babylonTransformNodeForSkin&&e.push(s._babylonTransformNodeForSkin);return e}_getSkeletons(){const e=[],t=this._gltf.skins;if(t)for(const s of t)s._data&&e.push(s._data.babylonSkeleton);return e}_getAnimationGroups(){const e=[],t=this._gltf.animations;if(t)for(const s of t)s._babylonAnimationGroup&&e.push(s._babylonAnimationGroup);return e}_startAnimations(){switch(this._parent.animationStartMode){case _e.NONE:break;case _e.FIRST:{const e=this._getAnimationGroups();e.length!==0&&e[0].start(!0);break}case _e.ALL:{const e=this._getAnimationGroups();for(const t of e)t.start(!0);break}default:{U.Error(`Invalid animation start mode (${this._parent.animationStartMode})`);return}}}loadNodeAsync(e,t,s=()=>{}){const n=this._extensionsLoadNodeAsync(e,t,s);if(n)return n;if(t._babylonTransformNode)throw new Error(`${e}: Invalid recursive node hierarchy`);const r=new Array;this.logOpen(`${e} ${t.name||""}`);const o=a=>{if(_.AddPointerMetadata(a,e),_._LoadTransform(t,a),t.camera!=null){const l=y.Get(`${e}/camera`,this._gltf.cameras,t.camera);r.push(this.loadCameraAsync(`/cameras/${l.index}`,l,c=>{c.parent=a}))}if(t.children)for(const l of t.children){const c=y.Get(`${e}/children/${l}`,this._gltf.nodes,l);r.push(this.loadNodeAsync(`/nodes/${c.index}`,c,h=>{h.parent=a}))}s(a)};if(t.mesh==null||t.skin!=null){const a=t.name||`node${t.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const l=new St(a,this._babylonScene);l._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t.mesh==null?t._babylonTransformNode=l:t._babylonTransformNodeForSkin=l,o(l)}if(t.mesh!=null)if(t.skin==null){const a=y.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);r.push(this._loadMeshAsync(`/meshes/${a.index}`,t,a,o))}else{const a=y.Get(`${e}/mesh`,this._gltf.meshes,t.mesh);r.push(this._loadMeshAsync(`/meshes/${a.index}`,t,a,l=>{const c=t._babylonTransformNodeForSkin;l.metadata=Jt(c.metadata,l.metadata||{});const h=y.Get(`${e}/skin`,this._gltf.skins,t.skin);r.push(this._loadSkinAsync(`/skins/${h.index}`,t,h,d=>{this._forEachPrimitive(t,u=>{u.skeleton=d}),this._postSceneLoadActions.push(()=>{if(h.skeleton!=null){const u=y.Get(`/skins/${h.index}/skeleton`,this._gltf.nodes,h.skeleton).parent;t.index===u.index?l.parent=c.parent:l.parent=u._babylonTransformNode}else l.parent=this._rootBabylonMesh;this._parent.onSkinLoadedObservable.notifyObservers({node:c,skinnedNode:l})})}))}))}return this.logClose(),Promise.all(r).then(()=>(this._forEachPrimitive(t,a=>{a.geometry&&a.geometry.useBoundingInfoFromGeometry?a._updateBoundingInfo():a.refreshBoundingInfo(!0)}),t._babylonTransformNode))}_loadMeshAsync(e,t,s,n){const r=s.primitives;if(!r||!r.length)throw new Error(`${e}: Primitives are missing`);r[0].index==null&&y.Assign(r);const o=new Array;this.logOpen(`${e} ${s.name||""}`);const a=t.name||`node${t.index}`;if(r.length===1){const l=s.primitives[0];o.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${l.index}`,a,t,s,l,c=>{t._babylonTransformNode=c,t._primitiveBabylonMeshes=[c]}))}else{this._babylonScene._blockEntityCollection=!!this._assetContainer,t._babylonTransformNode=new St(a,this._babylonScene),t._babylonTransformNode._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._primitiveBabylonMeshes=[];for(const l of r)o.push(this._loadMeshPrimitiveAsync(`${e}/primitives/${l.index}`,`${a}_primitive${l.index}`,t,s,l,c=>{c.parent=t._babylonTransformNode,t._primitiveBabylonMeshes.push(c)}))}return n(t._babylonTransformNode),this.logClose(),Promise.all(o).then(()=>t._babylonTransformNode)}_loadMeshPrimitiveAsync(e,t,s,n,r,o){const a=this._extensionsLoadMeshPrimitiveAsync(e,t,s,n,r,o);if(a)return a;this.logOpen(`${e}`);const l=this._disableInstancedMesh===0&&this._parent.createInstances&&s.skin==null&&!n.primitives[0].targets;let c,h;if(l&&r._instanceData)this._babylonScene._blockEntityCollection=!!this._assetContainer,c=r._instanceData.babylonSourceMesh.createInstance(t),c._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,h=r._instanceData.promise;else{const d=new Array;this._babylonScene._blockEntityCollection=!!this._assetContainer;const u=new oe(t,this._babylonScene);u._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,u.overrideMaterialSideOrientation=this._babylonScene.useRightHandedSystem?ee.CounterClockWiseSideOrientation:ee.ClockWiseSideOrientation,this._createMorphTargets(e,s,n,r,u),d.push(this._loadVertexDataAsync(e,r,u).then(p=>this._loadMorphTargetsAsync(e,r,u,p).then(()=>{this._disposed||(this._babylonScene._blockEntityCollection=!!this._assetContainer,p.applyToMesh(u),p._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1)})));const f=_._GetDrawMode(e,r.mode);if(r.material==null){let p=this._defaultBabylonMaterialData[f];p||(p=this._createDefaultMaterial("__GLTFLoader._default",f),this._parent.onMaterialLoadedObservable.notifyObservers(p),this._defaultBabylonMaterialData[f]=p),u.material=p}else if(!this.parent.skipMaterials){const p=y.Get(`${e}/material`,this._gltf.materials,r.material);d.push(this._loadMaterialAsync(`/materials/${p.index}`,p,u,f,A=>{u.material=A}))}h=Promise.all(d),l&&(r._instanceData={babylonSourceMesh:u,promise:h}),c=u}return _.AddPointerMetadata(c,e),this._parent.onMeshLoadedObservable.notifyObservers(c),o(c),this.logClose(),h.then(()=>c)}_loadVertexDataAsync(e,t,s){const n=this._extensionsLoadVertexDataAsync(e,t,s);if(n)return n;const r=t.attributes;if(!r)throw new Error(`${e}: Attributes are missing`);const o=new Array,a=new Me(s.name,this._babylonScene);if(t.indices==null)s.isUnIndexed=!0;else{const c=y.Get(`${e}/indices`,this._gltf.accessors,t.indices);o.push(this._loadIndicesAccessorAsync(`/accessors/${c.index}`,c).then(h=>{a.setIndices(h)}))}const l=(c,h,d)=>{if(r[c]==null)return;s._delayInfo=s._delayInfo||[],s._delayInfo.indexOf(h)===-1&&s._delayInfo.push(h);const u=y.Get(`${e}/attributes/${c}`,this._gltf.accessors,r[c]);o.push(this._loadVertexAccessorAsync(`/accessors/${u.index}`,u,h).then(f=>{if(f.getKind()===N.PositionKind&&!this.parent.alwaysComputeBoundingBox&&!s.skeleton&&u.min&&u.max){const p=Q.Vector3[0].copyFromFloats(...u.min),A=Q.Vector3[1].copyFromFloats(...u.max);if(u.normalized&&u.componentType!==5126){let m=1;switch(u.componentType){case 5120:m=127;break;case 5121:m=255;break;case 5122:m=32767;break;case 5123:m=65535;break}const g=1/m;p.scaleInPlace(g),A.scaleInPlace(g)}a._boundingInfo=new ys(p,A),a.useBoundingInfoFromGeometry=!0}a.setVerticesBuffer(f,u.count)})),h==N.MatricesIndicesExtraKind&&(s.numBoneInfluencers=8),d&&d(u)};return l("POSITION",N.PositionKind),l("NORMAL",N.NormalKind),l("TANGENT",N.TangentKind),l("TEXCOORD_0",N.UVKind),l("TEXCOORD_1",N.UV2Kind),l("TEXCOORD_2",N.UV3Kind),l("TEXCOORD_3",N.UV4Kind),l("TEXCOORD_4",N.UV5Kind),l("TEXCOORD_5",N.UV6Kind),l("JOINTS_0",N.MatricesIndicesKind),l("WEIGHTS_0",N.MatricesWeightsKind),l("JOINTS_1",N.MatricesIndicesExtraKind),l("WEIGHTS_1",N.MatricesWeightsExtraKind),l("COLOR_0",N.ColorKind,c=>{c.type==="VEC4"&&(s.hasVertexAlpha=!0)}),Promise.all(o).then(()=>a)}_createMorphTargets(e,t,s,n,r){if(!n.targets)return;if(t._numMorphTargets==null)t._numMorphTargets=n.targets.length;else if(n.targets.length!==t._numMorphTargets)throw new Error(`${e}: Primitives do not have the same number of targets`);const o=s.extras?s.extras.targetNames:null;this._babylonScene._blockEntityCollection=!!this._assetContainer,r.morphTargetManager=new us(this._babylonScene),r.morphTargetManager._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,r.morphTargetManager.areUpdatesFrozen=!0;for(let a=0;a<n.targets.length;a++){const l=t.weights?t.weights[a]:s.weights?s.weights[a]:0,c=o?o[a]:`morphTarget${a}`;r.morphTargetManager.addTarget(new fs(c,l,r.getScene()))}}_loadMorphTargetsAsync(e,t,s,n){if(!t.targets)return Promise.resolve();const r=new Array,o=s.morphTargetManager;for(let a=0;a<o.numTargets;a++){const l=o.getTarget(a);r.push(this._loadMorphTargetVertexDataAsync(`${e}/targets/${a}`,n,t.targets[a],l))}return Promise.all(r).then(()=>{o.areUpdatesFrozen=!1})}_loadMorphTargetVertexDataAsync(e,t,s,n){const r=new Array,o=(a,l,c)=>{if(s[a]==null)return;const h=t.getVertexBuffer(l);if(!h)return;const d=y.Get(`${e}/${a}`,this._gltf.accessors,s[a]);r.push(this._loadFloatAccessorAsync(`/accessors/${d.index}`,d).then(u=>{c(h,u)}))};return o("POSITION",N.PositionKind,(a,l)=>{const c=new Float32Array(l.length);a.forEach(l.length,(h,d)=>{c[d]=l[d]+h}),n.setPositions(c)}),o("NORMAL",N.NormalKind,(a,l)=>{const c=new Float32Array(l.length);a.forEach(c.length,(h,d)=>{c[d]=l[d]+h}),n.setNormals(c)}),o("TANGENT",N.TangentKind,(a,l)=>{const c=new Float32Array(l.length/3*4);let h=0;a.forEach(l.length/3*4,(d,u)=>{(u+1)%4!==0&&(c[h]=l[h]+d,h++)}),n.setTangents(c)}),Promise.all(r).then(()=>{})}static _LoadTransform(e,t){if(e.skin!=null)return;let s=C.Zero(),n=Y.Identity(),r=C.One();e.matrix?Z.FromArray(e.matrix).decompose(r,n,s):(e.translation&&(s=C.FromArray(e.translation)),e.rotation&&(n=Y.FromArray(e.rotation)),e.scale&&(r=C.FromArray(e.scale))),t.position=s,t.rotationQuaternion=n,t.scaling=r}_loadSkinAsync(e,t,s,n){const r=this._extensionsLoadSkinAsync(e,t,s);if(r)return r;if(s._data)return n(s._data.babylonSkeleton),s._data.promise;const o=`skeleton${s.index}`;this._babylonScene._blockEntityCollection=!!this._assetContainer;const a=new Ot(s.name||o,o,this._babylonScene);a._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,this._loadBones(e,s,a);const l=this._loadSkinInverseBindMatricesDataAsync(e,s).then(c=>{this._updateBoneMatrices(a,c)});return s._data={babylonSkeleton:a,promise:l},n(a),l}_loadBones(e,t,s){if(t.skeleton==null||this._parent.alwaysComputeSkeletonRootNode){const r=this._findSkeletonRootNode(`${e}/joints`,t.joints);if(r)if(t.skeleton===void 0)t.skeleton=r.index;else{const o=(l,c)=>{for(;c.parent;c=c.parent)if(c.parent===l)return!0;return!1},a=y.Get(`${e}/skeleton`,this._gltf.nodes,t.skeleton);a!==r&&!o(a,r)&&(U.Warn(`${e}/skeleton: Overriding with nearest common ancestor as skeleton node is not a common root`),t.skeleton=r.index)}else U.Warn(`${e}: Failed to find common root`)}const n={};for(const r of t.joints){const o=y.Get(`${e}/joints/${r}`,this._gltf.nodes,r);this._loadBone(o,t,s,n)}}_findSkeletonRootNode(e,t){if(t.length===0)return null;const s={};for(const r of t){const o=[];let a=y.Get(`${e}/${r}`,this._gltf.nodes,r);for(;a.index!==-1;)o.unshift(a),a=a.parent;s[r]=o}let n=null;for(let r=0;;++r){let o=s[t[0]];if(r>=o.length)return n;const a=o[r];for(let l=1;l<t.length;++l)if(o=s[t[l]],r>=o.length||a!==o[r])return n;n=a}}_loadBone(e,t,s,n){let r=n[e.index];if(r)return r;let o=null;e.index!==t.skeleton&&(e.parent&&e.parent.index!==-1?o=this._loadBone(e.parent,t,s,n):t.skeleton!==void 0&&U.Warn(`/skins/${t.index}/skeleton: Skeleton node is not a common root`));const a=t.joints.indexOf(e.index);return r=new Ce(e.name||`joint${e.index}`,s,o,this._getNodeMatrix(e),null,null,a),n[e.index]=r,this._postSceneLoadActions.push(()=>{r.linkTransformNode(e._babylonTransformNode)}),r}_loadSkinInverseBindMatricesDataAsync(e,t){if(t.inverseBindMatrices==null)return Promise.resolve(null);const s=y.Get(`${e}/inverseBindMatrices`,this._gltf.accessors,t.inverseBindMatrices);return this._loadFloatAccessorAsync(`/accessors/${s.index}`,s)}_updateBoneMatrices(e,t){for(const s of e.bones){const n=Z.Identity(),r=s._index;t&&r!==-1&&(Z.FromArrayToRef(t,r*16,n),n.invertToRef(n));const o=s.getParent();o&&n.multiplyToRef(o.getAbsoluteInverseBindMatrix(),n),s.updateMatrix(n,!1,!1),s._updateAbsoluteBindMatrices(void 0,!1)}}_getNodeMatrix(e){return e.matrix?Z.FromArray(e.matrix):Z.Compose(e.scale?C.FromArray(e.scale):C.One(),e.rotation?Y.FromArray(e.rotation):Y.Identity(),e.translation?C.FromArray(e.translation):C.Zero())}loadCameraAsync(e,t,s=()=>{}){const n=this._extensionsLoadCameraAsync(e,t,s);if(n)return n;const r=new Array;this.logOpen(`${e} ${t.name||""}`),this._babylonScene._blockEntityCollection=!!this._assetContainer;const o=new Be(t.name||`camera${t.index}`,C.Zero(),this._babylonScene,!1);switch(o._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,o.ignoreParentScaling=!0,t._babylonCamera=o,o.rotation.set(0,Math.PI,0),t.type){case"perspective":{const a=t.perspective;if(!a)throw new Error(`${e}: Camera perspective properties are missing`);o.fov=a.yfov,o.minZ=a.znear,o.maxZ=a.zfar||0;break}case"orthographic":{if(!t.orthographic)throw new Error(`${e}: Camera orthographic properties are missing`);o.mode=qt.ORTHOGRAPHIC_CAMERA,o.orthoLeft=-t.orthographic.xmag,o.orthoRight=t.orthographic.xmag,o.orthoBottom=-t.orthographic.ymag,o.orthoTop=t.orthographic.ymag,o.minZ=t.orthographic.znear,o.maxZ=t.orthographic.zfar;break}default:throw new Error(`${e}: Invalid camera type (${t.type})`)}return _.AddPointerMetadata(o,e),this._parent.onCameraLoadedObservable.notifyObservers(o),s(o),this.logClose(),Promise.all(r).then(()=>o)}_loadAnimationsAsync(){const e=this._gltf.animations;if(!e)return Promise.resolve();const t=new Array;for(let s=0;s<e.length;s++){const n=e[s];t.push(this.loadAnimationAsync(`/animations/${n.index}`,n).then(r=>{r.targetedAnimations.length===0&&r.dispose()}))}return Promise.all(t).then(()=>{})}loadAnimationAsync(e,t){const s=this._extensionsLoadAnimationAsync(e,t);if(s)return s;this._babylonScene._blockEntityCollection=!!this._assetContainer;const n=new _s(t.name||`animation${t.index}`,this._babylonScene);n._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,t._babylonAnimationGroup=n;const r=new Array;y.Assign(t.channels),y.Assign(t.samplers);for(const o of t.channels)r.push(this._loadAnimationChannelAsync(`${e}/channels/${o.index}`,e,t,o,(a,l)=>{a.animations=a.animations||[],a.animations.push(l),n.addTargetedAnimation(l,a)}));return Promise.all(r).then(()=>(n.normalize(0),n))}_loadAnimationChannelAsync(e,t,s,n,r){const o=this._extensionsLoadAnimationChannelAsync(e,t,s,n,r);if(o)return o;if(n.target.node==null)return Promise.resolve();const a=y.Get(`${e}/target/node`,this._gltf.nodes,n.target.node);if(n.target.path==="weights"&&!a._numMorphTargets||n.target.path!=="weights"&&!a._babylonTransformNode)return Promise.resolve();let l;switch(n.target.path){case"translation":{l=ye.translation;break}case"rotation":{l=ye.rotation;break}case"scale":{l=ye.scale;break}case"weights":{l=ye.weights;break}default:throw new Error(`${e}/target/path: Invalid value (${n.target.path})`)}const c={object:a,info:l};return this._loadAnimationChannelFromTargetInfoAsync(e,t,s,n,c,r)}_loadAnimationChannelFromTargetInfoAsync(e,t,s,n,r,o){const a=this.parent.targetFps,l=1/a,c=y.Get(`${e}/sampler`,s.samplers,n.sampler);return this._loadAnimationSamplerAsync(`${t}/samplers/${n.sampler}`,c).then(h=>{let d=0;const u=r.object,f=r.info;for(const p of f){const A=p.getStride(u),m=h.input,g=h.output,x=new Array(m.length);let w=0;switch(h.interpolation){case"STEP":{for(let E=0;E<m.length;E++){const O=p.getValue(u,g,w,1);w+=A,x[E]={frame:m[E]*a,value:O,interpolation:ps.STEP}}break}case"CUBICSPLINE":{for(let E=0;E<m.length;E++){const O=p.getValue(u,g,w,l);w+=A;const I=p.getValue(u,g,w,1);w+=A;const T=p.getValue(u,g,w,l);w+=A,x[E]={frame:m[E]*a,inTangent:O,value:I,outTangent:T}}break}case"LINEAR":{for(let E=0;E<m.length;E++){const O=p.getValue(u,g,w,1);w+=A,x[E]={frame:m[E]*a,value:O}}break}}if(w>0){const E=`${s.name||`animation${s.index}`}_channel${n.index}_${d}`;p.buildAnimations(u,E,a,x,(O,I)=>{++d,o(O,I)})}}})}_loadAnimationSamplerAsync(e,t){if(t._data)return t._data;const s=t.interpolation||"LINEAR";switch(s){case"STEP":case"LINEAR":case"CUBICSPLINE":break;default:throw new Error(`${e}/interpolation: Invalid value (${t.interpolation})`)}const n=y.Get(`${e}/input`,this._gltf.accessors,t.input),r=y.Get(`${e}/output`,this._gltf.accessors,t.output);return t._data=Promise.all([this._loadFloatAccessorAsync(`/accessors/${n.index}`,n),this._loadFloatAccessorAsync(`/accessors/${r.index}`,r)]).then(([o,a])=>({input:o,interpolation:s,output:a})),t._data}loadBufferAsync(e,t,s,n){const r=this._extensionsLoadBufferAsync(e,t,s,n);if(r)return r;if(!t._data)if(t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else{if(!this._bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);t._data=this._bin.readAsync(0,t.byteLength)}return t._data.then(o=>{try{return new Uint8Array(o.buffer,o.byteOffset+s,n)}catch(a){throw new Error(`${e}: ${a.message}`)}})}loadBufferViewAsync(e,t){const s=this._extensionsLoadBufferViewAsync(e,t);if(s)return s;if(t._data)return t._data;const n=y.Get(`${e}/buffer`,this._gltf.buffers,t.buffer);return t._data=this.loadBufferAsync(`/buffers/${n.index}`,n,t.byteOffset||0,t.byteLength),t._data}_loadAccessorAsync(e,t,s){if(t._data)return t._data;const n=_._GetNumComponents(e,t.type),r=n*N.GetTypeByteLength(t.componentType),o=n*t.count;if(t.bufferView==null)t._data=Promise.resolve(new s(o));else{const a=y.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${a.index}`,a).then(l=>{if(t.componentType===5126&&!t.normalized&&(!a.byteStride||a.byteStride===r))return _._GetTypedArray(e,t.componentType,l,t.byteOffset,o);{const c=new s(o);return N.ForEach(l,t.byteOffset||0,a.byteStride||r,n,t.componentType,c.length,t.normalized||!1,(h,d)=>{c[d]=h}),c}})}if(t.sparse){const a=t.sparse;t._data=t._data.then(l=>{const c=l,h=y.Get(`${e}/sparse/indices/bufferView`,this._gltf.bufferViews,a.indices.bufferView),d=y.Get(`${e}/sparse/values/bufferView`,this._gltf.bufferViews,a.values.bufferView);return Promise.all([this.loadBufferViewAsync(`/bufferViews/${h.index}`,h),this.loadBufferViewAsync(`/bufferViews/${d.index}`,d)]).then(([u,f])=>{const p=_._GetTypedArray(`${e}/sparse/indices`,a.indices.componentType,u,a.indices.byteOffset,a.count),A=n*a.count;let m;if(t.componentType===5126&&!t.normalized)m=_._GetTypedArray(`${e}/sparse/values`,t.componentType,f,a.values.byteOffset,A);else{const x=_._GetTypedArray(`${e}/sparse/values`,t.componentType,f,a.values.byteOffset,A);m=new s(A),N.ForEach(x,0,r,n,t.componentType,m.length,t.normalized||!1,(w,E)=>{m[E]=w})}let g=0;for(let x=0;x<p.length;x++){let w=p[x]*n;for(let E=0;E<n;E++)c[w++]=m[g++]}return c})})}return t._data}_loadFloatAccessorAsync(e,t){return this._loadAccessorAsync(e,t,Float32Array)}_loadIndicesAccessorAsync(e,t){if(t.type!=="SCALAR")throw new Error(`${e}/type: Invalid value ${t.type}`);if(t.componentType!==5121&&t.componentType!==5123&&t.componentType!==5125)throw new Error(`${e}/componentType: Invalid value ${t.componentType}`);if(t._data)return t._data;if(t.sparse){const s=_._GetTypedArrayConstructor(`${e}/componentType`,t.componentType);t._data=this._loadAccessorAsync(e,t,s)}else{const s=y.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${s.index}`,s).then(n=>_._GetTypedArray(e,t.componentType,n,t.byteOffset,t.count))}return t._data}_loadVertexBufferViewAsync(e){if(e._babylonBuffer)return e._babylonBuffer;const t=this._babylonScene.getEngine();return e._babylonBuffer=this.loadBufferViewAsync(`/bufferViews/${e.index}`,e).then(s=>new ms(t,s,!1)),e._babylonBuffer}_loadVertexAccessorAsync(e,t,s){var r;if((r=t._babylonVertexBuffer)!=null&&r[s])return t._babylonVertexBuffer[s];t._babylonVertexBuffer||(t._babylonVertexBuffer={});const n=this._babylonScene.getEngine();if(t.sparse||t.bufferView==null)t._babylonVertexBuffer[s]=this._loadFloatAccessorAsync(e,t).then(o=>new N(n,o,s,!1));else{const o=y.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._babylonVertexBuffer[s]=this._loadVertexBufferViewAsync(o).then(a=>{const l=_._GetNumComponents(e,t.type);return new N(n,a,s,!1,void 0,o.byteStride,void 0,t.byteOffset,l,t.componentType,t.normalized,!0,void 0,!0)})}return t._babylonVertexBuffer[s]}_loadMaterialMetallicRoughnessPropertiesAsync(e,t,s){if(!(s instanceof G))throw new Error(`${e}: Material type not supported`);const n=new Array;return t&&(t.baseColorFactor?(s.albedoColor=L.FromArray(t.baseColorFactor),s.alpha=t.baseColorFactor[3]):s.albedoColor=L.White(),s.metallic=t.metallicFactor==null?1:t.metallicFactor,s.roughness=t.roughnessFactor==null?1:t.roughnessFactor,t.baseColorTexture&&n.push(this.loadTextureInfoAsync(`${e}/baseColorTexture`,t.baseColorTexture,r=>{r.name=`${s.name} (Base Color)`,s.albedoTexture=r})),t.metallicRoughnessTexture&&(t.metallicRoughnessTexture.nonColorData=!0,n.push(this.loadTextureInfoAsync(`${e}/metallicRoughnessTexture`,t.metallicRoughnessTexture,r=>{r.name=`${s.name} (Metallic Roughness)`,s.metallicTexture=r})),s.useMetallnessFromMetallicTextureBlue=!0,s.useRoughnessFromMetallicTextureGreen=!0,s.useRoughnessFromMetallicTextureAlpha=!1)),Promise.all(n).then(()=>{})}_loadMaterialAsync(e,t,s,n,r=()=>{}){const o=this._extensionsLoadMaterialAsync(e,t,s,n,r);if(o)return o;t._data=t._data||{};let a=t._data[n];if(!a){this.logOpen(`${e} ${t.name||""}`);const l=this.createMaterial(e,t,n);a={babylonMaterial:l,babylonMeshes:[],promise:this.loadMaterialPropertiesAsync(e,t,l)},t._data[n]=a,_.AddPointerMetadata(l,e),this._parent.onMaterialLoadedObservable.notifyObservers(l),this.logClose()}return s&&(a.babylonMeshes.push(s),s.onDisposeObservable.addOnce(()=>{const l=a.babylonMeshes.indexOf(s);l!==-1&&a.babylonMeshes.splice(l,1)})),r(a.babylonMaterial),a.promise.then(()=>a.babylonMaterial)}_createDefaultMaterial(e,t){this._babylonScene._blockEntityCollection=!!this._assetContainer;const s=new G(e,this._babylonScene);return s._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,s.fillMode=t,s.enableSpecularAntiAliasing=!0,s.useRadianceOverAlpha=!this._parent.transparencyAsCoverage,s.useSpecularOverAlpha=!this._parent.transparencyAsCoverage,s.transparencyMode=G.PBRMATERIAL_OPAQUE,s.metallic=1,s.roughness=1,s}createMaterial(e,t,s){const n=this._extensionsCreateMaterial(e,t,s);if(n)return n;const r=t.name||`material${t.index}`;return this._createDefaultMaterial(r,s)}loadMaterialPropertiesAsync(e,t,s){const n=this._extensionsLoadMaterialPropertiesAsync(e,t,s);if(n)return n;const r=new Array;return r.push(this.loadMaterialBasePropertiesAsync(e,t,s)),t.pbrMetallicRoughness&&r.push(this._loadMaterialMetallicRoughnessPropertiesAsync(`${e}/pbrMetallicRoughness`,t.pbrMetallicRoughness,s)),this.loadMaterialAlphaProperties(e,t,s),Promise.all(r).then(()=>{})}loadMaterialBasePropertiesAsync(e,t,s){if(!(s instanceof G))throw new Error(`${e}: Material type not supported`);const n=new Array;return s.emissiveColor=t.emissiveFactor?L.FromArray(t.emissiveFactor):new L(0,0,0),t.doubleSided&&(s.backFaceCulling=!1,s.twoSidedLighting=!0),t.normalTexture&&(t.normalTexture.nonColorData=!0,n.push(this.loadTextureInfoAsync(`${e}/normalTexture`,t.normalTexture,r=>{r.name=`${s.name} (Normal)`,s.bumpTexture=r})),s.invertNormalMapX=!this._babylonScene.useRightHandedSystem,s.invertNormalMapY=this._babylonScene.useRightHandedSystem,t.normalTexture.scale!=null&&s.bumpTexture&&(s.bumpTexture.level=t.normalTexture.scale),s.forceIrradianceInFragment=!0),t.occlusionTexture&&(t.occlusionTexture.nonColorData=!0,n.push(this.loadTextureInfoAsync(`${e}/occlusionTexture`,t.occlusionTexture,r=>{r.name=`${s.name} (Occlusion)`,s.ambientTexture=r})),s.useAmbientInGrayScale=!0,t.occlusionTexture.strength!=null&&(s.ambientTextureStrength=t.occlusionTexture.strength)),t.emissiveTexture&&n.push(this.loadTextureInfoAsync(`${e}/emissiveTexture`,t.emissiveTexture,r=>{r.name=`${s.name} (Emissive)`,s.emissiveTexture=r})),Promise.all(n).then(()=>{})}loadMaterialAlphaProperties(e,t,s){if(!(s instanceof G))throw new Error(`${e}: Material type not supported`);switch(t.alphaMode||"OPAQUE"){case"OPAQUE":{s.transparencyMode=G.PBRMATERIAL_OPAQUE,s.alpha=1;break}case"MASK":{s.transparencyMode=G.PBRMATERIAL_ALPHATEST,s.alphaCutOff=t.alphaCutoff==null?.5:t.alphaCutoff,s.albedoTexture&&(s.albedoTexture.hasAlpha=!0);break}case"BLEND":{s.transparencyMode=G.PBRMATERIAL_ALPHABLEND,s.albedoTexture&&(s.albedoTexture.hasAlpha=!0,s.useAlphaFromAlbedoTexture=!0);break}default:throw new Error(`${e}/alphaMode: Invalid value (${t.alphaMode})`)}}loadTextureInfoAsync(e,t,s=()=>{}){const n=this._extensionsLoadTextureInfoAsync(e,t,s);if(n)return n;if(this.logOpen(`${e}`),t.texCoord>=6)throw new Error(`${e}/texCoord: Invalid value (${t.texCoord})`);const r=y.Get(`${e}/index`,this._gltf.textures,t.index);r._textureInfo=t;const o=this._loadTextureAsync(`/textures/${t.index}`,r,a=>{a.coordinatesIndex=t.texCoord||0,_.AddPointerMetadata(a,e),this._parent.onTextureLoadedObservable.notifyObservers(a),s(a)});return this.logClose(),o}_loadTextureAsync(e,t,s=()=>{}){const n=this._extensionsLoadTextureAsync(e,t,s);if(n)return n;this.logOpen(`${e} ${t.name||""}`);const r=t.sampler==null?_.DefaultSampler:y.Get(`${e}/sampler`,this._gltf.samplers,t.sampler),o=y.Get(`${e}/source`,this._gltf.images,t.source),a=this._createTextureAsync(e,r,o,s,void 0,!t._textureInfo.nonColorData);return this.logClose(),a}_createTextureAsync(e,t,s,n=()=>{},r,o){const a=this._loadSampler(`/samplers/${t.index}`,t),l=new Array,c=new ge;this._babylonScene._blockEntityCollection=!!this._assetContainer;const h={noMipmap:a.noMipMaps,invertY:!1,samplingMode:a.samplingMode,onLoad:()=>{this._disposed||c.resolve()},onError:(u,f)=>{this._disposed||c.reject(new Error(`${e}: ${f&&f.message?f.message:u||"Failed to load texture"}`))},mimeType:s.mimeType,loaderOptions:r,useSRGBBuffer:!!o&&this._parent.useSRGBBuffers},d=new B(null,this._babylonScene,h);return d._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,l.push(c.promise),l.push(this.loadImageAsync(`/images/${s.index}`,s).then(u=>{const f=s.uri||`${this._fileName}#image${s.index}`,p=`data:${this._uniqueRootUrl}${f}`;d.updateURL(p,u)})),d.wrapU=a.wrapU,d.wrapV=a.wrapV,n(d),Promise.all(l).then(()=>d)}_loadSampler(e,t){return t._data||(t._data={noMipMaps:t.minFilter===9728||t.minFilter===9729,samplingMode:_._GetTextureSamplingMode(e,t),wrapU:_._GetTextureWrapMode(`${e}/wrapS`,t.wrapS),wrapV:_._GetTextureWrapMode(`${e}/wrapT`,t.wrapT)}),t._data}loadImageAsync(e,t){if(!t._data){if(this.logOpen(`${e} ${t.name||""}`),t.uri)t._data=this.loadUriAsync(`${e}/uri`,t,t.uri);else{const s=y.Get(`${e}/bufferView`,this._gltf.bufferViews,t.bufferView);t._data=this.loadBufferViewAsync(`/bufferViews/${s.index}`,s)}this.logClose()}return t._data}loadUriAsync(e,t,s){const n=this._extensionsLoadUriAsync(e,t,s);if(n)return n;if(!_._ValidateUri(s))throw new Error(`${e}: '${s}' is invalid`);if(As(s)){const r=new Uint8Array(jt(s));return this.log(`${e}: Decoded ${s.substr(0,64)}... (${r.length} bytes)`),Promise.resolve(r)}return this.log(`${e}: Loading ${s}`),this._parent.preprocessUrlAsync(this._rootUrl+s).then(r=>new Promise((o,a)=>{this._parent._loadFile(this._babylonScene,r,l=>{this._disposed||(this.log(`${e}: Loaded ${s} (${l.byteLength} bytes)`),o(new Uint8Array(l)))},!0,l=>{a(new gs(`${e}: Failed to load '${s}'${l?": "+l.status+" "+l.statusText:""}`,l))})}))}static AddPointerMetadata(e,t){e.metadata=e.metadata||{};const s=e._internalMetadata=e._internalMetadata||{},n=s.gltf=s.gltf||{};(n.pointers=n.pointers||[]).push(t)}static _GetTextureWrapMode(e,t){switch(t=t??10497,t){case 33071:return B.CLAMP_ADDRESSMODE;case 33648:return B.MIRROR_ADDRESSMODE;case 10497:return B.WRAP_ADDRESSMODE;default:return U.Warn(`${e}: Invalid value (${t})`),B.WRAP_ADDRESSMODE}}static _GetTextureSamplingMode(e,t){const s=t.magFilter==null?9729:t.magFilter,n=t.minFilter==null?9987:t.minFilter;if(s===9729)switch(n){case 9728:return B.LINEAR_NEAREST;case 9729:return B.LINEAR_LINEAR;case 9984:return B.LINEAR_NEAREST_MIPNEAREST;case 9985:return B.LINEAR_LINEAR_MIPNEAREST;case 9986:return B.LINEAR_NEAREST_MIPLINEAR;case 9987:return B.LINEAR_LINEAR_MIPLINEAR;default:return U.Warn(`${e}/minFilter: Invalid value (${n})`),B.LINEAR_LINEAR_MIPLINEAR}else switch(s!==9728&&U.Warn(`${e}/magFilter: Invalid value (${s})`),n){case 9728:return B.NEAREST_NEAREST;case 9729:return B.NEAREST_LINEAR;case 9984:return B.NEAREST_NEAREST_MIPNEAREST;case 9985:return B.NEAREST_LINEAR_MIPNEAREST;case 9986:return B.NEAREST_NEAREST_MIPLINEAR;case 9987:return B.NEAREST_LINEAR_MIPLINEAR;default:return U.Warn(`${e}/minFilter: Invalid value (${n})`),B.NEAREST_NEAREST_MIPNEAREST}}static _GetTypedArrayConstructor(e,t){switch(t){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:throw new Error(`${e}: Invalid component type ${t}`)}}static _GetTypedArray(e,t,s,n,r){const o=s.buffer;n=s.byteOffset+(n||0);const a=_._GetTypedArrayConstructor(`${e}/componentType`,t),l=N.GetTypeByteLength(t);return n%l!==0?(U.Warn(`${e}: Copying buffer as byte offset (${n}) is not a multiple of component type byte length (${l})`),new a(o.slice(n,n+r*l),0)):new a(o,n,r)}static _GetNumComponents(e,t){switch(t){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":return 4;case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16}throw new Error(`${e}: Invalid type (${t})`)}static _ValidateUri(e){return S.IsBase64(e)||e.indexOf("..")===-1}static _GetDrawMode(e,t){switch(t==null&&(t=4),t){case 0:return ee.PointListDrawMode;case 1:return ee.LineListDrawMode;case 2:return ee.LineLoopDrawMode;case 3:return ee.LineStripDrawMode;case 4:return ee.TriangleFillMode;case 5:return ee.TriangleStripDrawMode;case 6:return ee.TriangleFanDrawMode}throw new Error(`${e}: Invalid mesh primitive mode (${t})`)}_compileMaterialsAsync(){this._parent._startPerformanceCounter("Compile materials");const e=new Array;if(this._gltf.materials){for(const t of this._gltf.materials)if(t._data)for(const s in t._data){const n=t._data[s];for(const r of n.babylonMeshes){r.computeWorldMatrix(!0);const o=n.babylonMaterial;e.push(o.forceCompilationAsync(r)),e.push(o.forceCompilationAsync(r,{useInstances:!0})),this._parent.useClipPlane&&(e.push(o.forceCompilationAsync(r,{clipPlane:!0})),e.push(o.forceCompilationAsync(r,{clipPlane:!0,useInstances:!0})))}}}return Promise.all(e).then(()=>{this._parent._endPerformanceCounter("Compile materials")})}_compileShadowGeneratorsAsync(){this._parent._startPerformanceCounter("Compile shadow generators");const e=new Array,t=this._babylonScene.lights;for(const s of t){const n=s.getShadowGenerator();n&&e.push(n.forceCompilationAsync())}return Promise.all(e).then(()=>{this._parent._endPerformanceCounter("Compile shadow generators")})}_forEachExtensions(e){for(const t of this._extensions)t.enabled&&e(t)}_applyExtensions(e,t,s){for(const n of this._extensions)if(n.enabled){const r=`${n.name}.${t}`,o=e;o._activeLoaderExtensionFunctions=o._activeLoaderExtensionFunctions||{};const a=o._activeLoaderExtensionFunctions;if(!a[r]){a[r]=!0;try{const l=s(n);if(l)return l}finally{delete a[r]}}}return null}_extensionsOnLoading(){this._forEachExtensions(e=>e.onLoading&&e.onLoading())}_extensionsOnReady(){this._forEachExtensions(e=>e.onReady&&e.onReady())}_extensionsLoadSceneAsync(e,t){return this._applyExtensions(t,"loadScene",s=>s.loadSceneAsync&&s.loadSceneAsync(e,t))}_extensionsLoadNodeAsync(e,t,s){return this._applyExtensions(t,"loadNode",n=>n.loadNodeAsync&&n.loadNodeAsync(e,t,s))}_extensionsLoadCameraAsync(e,t,s){return this._applyExtensions(t,"loadCamera",n=>n.loadCameraAsync&&n.loadCameraAsync(e,t,s))}_extensionsLoadVertexDataAsync(e,t,s){return this._applyExtensions(t,"loadVertexData",n=>n._loadVertexDataAsync&&n._loadVertexDataAsync(e,t,s))}_extensionsLoadMeshPrimitiveAsync(e,t,s,n,r,o){return this._applyExtensions(r,"loadMeshPrimitive",a=>a._loadMeshPrimitiveAsync&&a._loadMeshPrimitiveAsync(e,t,s,n,r,o))}_extensionsLoadMaterialAsync(e,t,s,n,r){return this._applyExtensions(t,"loadMaterial",o=>o._loadMaterialAsync&&o._loadMaterialAsync(e,t,s,n,r))}_extensionsCreateMaterial(e,t,s){return this._applyExtensions(t,"createMaterial",n=>n.createMaterial&&n.createMaterial(e,t,s))}_extensionsLoadMaterialPropertiesAsync(e,t,s){return this._applyExtensions(t,"loadMaterialProperties",n=>n.loadMaterialPropertiesAsync&&n.loadMaterialPropertiesAsync(e,t,s))}_extensionsLoadTextureInfoAsync(e,t,s){return this._applyExtensions(t,"loadTextureInfo",n=>n.loadTextureInfoAsync&&n.loadTextureInfoAsync(e,t,s))}_extensionsLoadTextureAsync(e,t,s){return this._applyExtensions(t,"loadTexture",n=>n._loadTextureAsync&&n._loadTextureAsync(e,t,s))}_extensionsLoadAnimationAsync(e,t){return this._applyExtensions(t,"loadAnimation",s=>s.loadAnimationAsync&&s.loadAnimationAsync(e,t))}_extensionsLoadAnimationChannelAsync(e,t,s,n,r){return this._applyExtensions(s,"loadAnimationChannel",o=>o._loadAnimationChannelAsync&&o._loadAnimationChannelAsync(e,t,s,n,r))}_extensionsLoadSkinAsync(e,t,s){return this._applyExtensions(s,"loadSkin",n=>n._loadSkinAsync&&n._loadSkinAsync(e,t,s))}_extensionsLoadUriAsync(e,t,s){return this._applyExtensions(t,"loadUri",n=>n._loadUriAsync&&n._loadUriAsync(e,t,s))}_extensionsLoadBufferViewAsync(e,t){return this._applyExtensions(t,"loadBufferView",s=>s.loadBufferViewAsync&&s.loadBufferViewAsync(e,t))}_extensionsLoadBufferAsync(e,t,s,n){return this._applyExtensions(t,"loadBuffer",r=>r.loadBufferAsync&&r.loadBufferAsync(e,t,s,n))}static LoadExtensionAsync(e,t,s,n){if(!t.extensions)return null;const o=t.extensions[s];return o?n(`${e}/extensions/${s}`,o):null}static LoadExtraAsync(e,t,s,n){if(!t.extras)return null;const o=t.extras[s];return o?n(`${e}/extras/${s}`,o):null}isExtensionUsed(e){return!!this._gltf.extensionsUsed&&this._gltf.extensionsUsed.indexOf(e)!==-1}logOpen(e){this._parent._logOpen(e)}logClose(){this._parent._logClose()}log(e){this._parent._log(e)}startPerformanceCounter(e){this._parent._startPerformanceCounter(e)}endPerformanceCounter(e){this._parent._endPerformanceCounter(e)}}_._RegisteredExtensions={};_.DefaultSampler={index:-1};k._CreateGLTF2Loader=i=>new _(i);const He="EXT_lights_image_based";class vr{constructor(e){this.name=He,this._loader=e,this.enabled=this._loader.isExtensionUsed(He)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights}}loadSceneAsync(e,t){return _.LoadExtensionAsync(e,t,this.name,(s,n)=>{this._loader._allMaterialsDirtyRequired=!0;const r=new Array;r.push(this._loader.loadSceneAsync(e,t)),this._loader.logOpen(`${s}`);const o=y.Get(`${s}/light`,this._lights,n.light);return r.push(this._loadLightAsync(`/extensions/${this.name}/lights/${n.light}`,o).then(a=>{this._loader.babylonScene.environmentTexture=a})),this._loader.logClose(),Promise.all(r).then(()=>{})})}_loadLightAsync(e,t){if(!t._loaded){const s=new Array;this._loader.logOpen(`${e}`);const n=new Array(t.specularImages.length);for(let r=0;r<t.specularImages.length;r++){const o=t.specularImages[r];n[r]=new Array(o.length);for(let a=0;a<o.length;a++){const l=`${e}/specularImages/${r}/${a}`;this._loader.logOpen(`${l}`);const c=o[a],h=y.Get(l,this._loader.gltf.images,c);s.push(this._loader.loadImageAsync(`/images/${c}`,h).then(d=>{n[r][a]=d})),this._loader.logClose()}}this._loader.logClose(),t._loaded=Promise.all(s).then(()=>{const r=new xt(this._loader.babylonScene,null,t.specularImageSize);if(r.name=t.name||"environment",t._babylonTexture=r,t.intensity!=null&&(r.level=t.intensity),t.rotation){let c=Y.FromArray(t.rotation);this._loader.babylonScene.useRightHandedSystem||(c=Y.Inverse(c)),Z.FromQuaternionToRef(c,r.getReflectionTextureMatrix())}if(!t.irradianceCoefficients)throw new Error(`${e}: Irradiance coefficients are missing`);const o=bs.FromArray(t.irradianceCoefficients);o.scaleInPlace(t.intensity),o.convertIrradianceToLambertianRadiance();const a=Os.FromHarmonics(o),l=(n.length-1)/Ts.Log2(t.specularImageSize);return r.updateRGBDAsync(n,a,l)})}return t._loaded.then(()=>t._babylonTexture)}}_.RegisterExtension(He,i=>new vr(i));const je="EXT_mesh_gpu_instancing";class Sr{constructor(e){this.name=je,this._loader=e,this.enabled=this._loader.isExtensionUsed(je)}dispose(){this._loader=null}loadNodeAsync(e,t,s){return _.LoadExtensionAsync(e,t,this.name,(n,r)=>{this._loader._disableInstancedMesh++;const o=this._loader.loadNodeAsync(`/nodes/${t.index}`,t,s);if(this._loader._disableInstancedMesh--,!t._primitiveBabylonMeshes)return o;const a=new Array;let l=0;const c=h=>{if(r.attributes[h]==null){a.push(Promise.resolve(null));return}const d=y.Get(`${n}/attributes/${h}`,this._loader.gltf.accessors,r.attributes[h]);if(a.push(this._loader._loadFloatAccessorAsync(`/accessors/${d.bufferView}`,d)),l===0)l=d.count;else if(l!==d.count)throw new Error(`${n}/attributes: Instance buffer accessors do not have the same count.`)};return c("TRANSLATION"),c("ROTATION"),c("SCALE"),o.then(h=>Promise.all(a).then(([d,u,f])=>{const p=new Float32Array(l*16);Q.Vector3[0].copyFromFloats(0,0,0),Q.Quaternion[0].copyFromFloats(0,0,0,1),Q.Vector3[1].copyFromFloats(1,1,1);for(let A=0;A<l;++A)d&&C.FromArrayToRef(d,A*3,Q.Vector3[0]),u&&Y.FromArrayToRef(u,A*4,Q.Quaternion[0]),f&&C.FromArrayToRef(f,A*3,Q.Vector3[1]),Z.ComposeToRef(Q.Vector3[1],Q.Quaternion[0],Q.Vector3[0],Q.Matrix[0]),Q.Matrix[0].copyToArray(p,A*16);for(const A of t._primitiveBabylonMeshes)A.thinInstanceSetBuffer("matrix",p,16,!0);return h}))})}}_.RegisterExtension(je,i=>new Sr(i));const Ke="EXT_meshopt_compression";class Pr{constructor(e){this.name=Ke,this.enabled=e.isExtensionUsed(Ke),this._loader=e}dispose(){this._loader=null}loadBufferViewAsync(e,t){return _.LoadExtensionAsync(e,t,this.name,(s,n)=>{const r=t;if(r._meshOptData)return r._meshOptData;const o=y.Get(`${e}/buffer`,this._loader.gltf.buffers,n.buffer);return r._meshOptData=this._loader.loadBufferAsync(`/buffers/${o.index}`,o,n.byteOffset||0,n.byteLength).then(a=>Es.Default.decodeGltfBufferAsync(a,n.count,n.byteStride,n.mode,n.filter)),r._meshOptData})}}_.RegisterExtension(Ke,i=>new Pr(i));const We="EXT_texture_webp";class Lr{constructor(e){this.name=We,this._loader=e,this.enabled=e.isExtensionUsed(We)}dispose(){this._loader=null}_loadTextureAsync(e,t,s){return _.LoadExtensionAsync(e,t,this.name,(n,r)=>{const o=t.sampler==null?_.DefaultSampler:y.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),a=y.Get(`${n}/source`,this._loader.gltf.images,r.source);return this._loader._createTextureAsync(e,o,a,l=>{s(l)},void 0,!t._textureInfo.nonColorData)})}}_.RegisterExtension(We,i=>new Lr(i));const qe="KHR_draco_mesh_compression";class Fr{constructor(e){this.name=qe,this.useNormalizedFlagFromAccessor=!0,this._loader=e,this.enabled=Pt.DecoderAvailable&&this._loader.isExtensionUsed(qe)}dispose(){delete this.dracoCompression,this._loader=null}_loadVertexDataAsync(e,t,s){return _.LoadExtensionAsync(e,t,this.name,(n,r)=>{if(t.mode!=null&&t.mode!==4&&t.mode!==5)throw new Error(`${e}: Unsupported mode ${t.mode}`);const o={},a={},l=(h,d)=>{const u=r.attributes[h];if(u!=null&&(s._delayInfo=s._delayInfo||[],s._delayInfo.indexOf(d)===-1&&s._delayInfo.push(d),o[d]=u,this.useNormalizedFlagFromAccessor)){const f=y.TryGet(this._loader.gltf.accessors,t.attributes[h]);f&&(a[d]=f.normalized||!1)}};l("POSITION",N.PositionKind),l("NORMAL",N.NormalKind),l("TANGENT",N.TangentKind),l("TEXCOORD_0",N.UVKind),l("TEXCOORD_1",N.UV2Kind),l("TEXCOORD_2",N.UV3Kind),l("TEXCOORD_3",N.UV4Kind),l("TEXCOORD_4",N.UV5Kind),l("TEXCOORD_5",N.UV6Kind),l("JOINTS_0",N.MatricesIndicesKind),l("WEIGHTS_0",N.MatricesWeightsKind),l("COLOR_0",N.ColorKind);const c=y.Get(n,this._loader.gltf.bufferViews,r.bufferView);return c._dracoBabylonGeometry||(c._dracoBabylonGeometry=this._loader.loadBufferViewAsync(`/bufferViews/${c.index}`,c).then(h=>(this.dracoCompression||Pt.Default)._decodeMeshToGeometryForGltfAsync(s.name,this._loader.babylonScene,h,o,a).catch(u=>{throw new Error(`${e}: ${u.message}`)}))),c._dracoBabylonGeometry})}}_.RegisterExtension(qe,i=>new Fr(i));const Ye="KHR_lights_punctual";class Rr{constructor(e){this.name=Ye,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ye)}dispose(){this._loader=null,delete this._lights}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._lights=t.lights,y.Assign(this._lights)}}loadNodeAsync(e,t,s){return _.LoadExtensionAsync(e,t,this.name,(n,r)=>(this._loader._allMaterialsDirtyRequired=!0,this._loader.loadNodeAsync(e,t,o=>{let a;const l=y.Get(n,this._lights,r.light),c=l.name||o.name;switch(this._loader.babylonScene._blockEntityCollection=!!this._loader._assetContainer,l.type){case"directional":{const h=new Tt(c,C.Backward(),this._loader.babylonScene);h.position.setAll(0),a=h;break}case"point":{a=new Et(c,C.Zero(),this._loader.babylonScene);break}case"spot":{const h=new wt(c,C.Zero(),C.Backward(),0,1,this._loader.babylonScene);h.angle=(l.spot&&l.spot.outerConeAngle||Math.PI/4)*2,h.innerAngle=(l.spot&&l.spot.innerConeAngle||0)*2,a=h;break}default:throw this._loader.babylonScene._blockEntityCollection=!1,new Error(`${n}: Invalid light type (${l.type})`)}a._parentContainer=this._loader._assetContainer,this._loader.babylonScene._blockEntityCollection=!1,l._babylonLight=a,a.falloffType=ws.FALLOFF_GLTF,a.diffuse=l.color?L.FromArray(l.color):L.White(),a.intensity=l.intensity==null?1:l.intensity,a.range=l.range==null?Number.MAX_VALUE:l.range,a.parent=o,this._loader._babylonLights.push(a),_.AddPointerMetadata(a,n),s(o)})))}}_.RegisterExtension(Ye,i=>new Rr(i));const ze="KHR_materials_pbrSpecularGlossiness";class Br{constructor(e){this.name=ze,this.order=200,this._loader=e,this.enabled=this._loader.isExtensionUsed(ze)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return _.LoadExtensionAsync(e,t,this.name,(n,r)=>{const o=new Array;return o.push(this._loader.loadMaterialBasePropertiesAsync(e,t,s)),o.push(this._loadSpecularGlossinessPropertiesAsync(n,r,s)),this._loader.loadMaterialAlphaProperties(e,t,s),Promise.all(o).then(()=>{})})}_loadSpecularGlossinessPropertiesAsync(e,t,s){if(!(s instanceof G))throw new Error(`${e}: Material type not supported`);const n=new Array;return s.metallic=null,s.roughness=null,t.diffuseFactor?(s.albedoColor=L.FromArray(t.diffuseFactor),s.alpha=t.diffuseFactor[3]):s.albedoColor=L.White(),s.reflectivityColor=t.specularFactor?L.FromArray(t.specularFactor):L.White(),s.microSurface=t.glossinessFactor==null?1:t.glossinessFactor,t.diffuseTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/diffuseTexture`,t.diffuseTexture,r=>{r.name=`${s.name} (Diffuse)`,s.albedoTexture=r})),t.specularGlossinessTexture&&(n.push(this._loader.loadTextureInfoAsync(`${e}/specularGlossinessTexture`,t.specularGlossinessTexture,r=>{r.name=`${s.name} (Specular Glossiness)`,s.reflectivityTexture=r,s.reflectivityTexture.hasAlpha=!0})),s.useMicroSurfaceFromReflectivityMapAlpha=!0),Promise.all(n).then(()=>{})}}_.RegisterExtension(ze,i=>new Br(i));const Xe="KHR_materials_unlit";class Dr{constructor(e){this.name=Xe,this.order=210,this._loader=e,this.enabled=this._loader.isExtensionUsed(Xe)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return _.LoadExtensionAsync(e,t,this.name,()=>this._loadUnlitPropertiesAsync(e,t,s))}_loadUnlitPropertiesAsync(e,t,s){if(!(s instanceof G))throw new Error(`${e}: Material type not supported`);const n=new Array;s.unlit=!0;const r=t.pbrMetallicRoughness;return r&&(r.baseColorFactor?(s.albedoColor=L.FromArray(r.baseColorFactor),s.alpha=r.baseColorFactor[3]):s.albedoColor=L.White(),r.baseColorTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/baseColorTexture`,r.baseColorTexture,o=>{o.name=`${s.name} (Base Color)`,s.albedoTexture=o}))),t.doubleSided&&(s.backFaceCulling=!1,s.twoSidedLighting=!0),this._loader.loadMaterialAlphaProperties(e,t,s),Promise.all(n).then(()=>{})}}_.RegisterExtension(Xe,i=>new Dr(i));const Ze="KHR_materials_clearcoat";class $r{constructor(e){this.name=Ze,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(Ze)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return _.LoadExtensionAsync(e,t,this.name,(n,r)=>{const o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,s)),o.push(this._loadClearCoatPropertiesAsync(n,r,s)),Promise.all(o).then(()=>{})})}_loadClearCoatPropertiesAsync(e,t,s){if(!(s instanceof G))throw new Error(`${e}: Material type not supported`);const n=new Array;return s.clearCoat.isEnabled=!0,s.clearCoat.useRoughnessFromMainTexture=!1,s.clearCoat.remapF0OnInterfaceChange=!1,t.clearcoatFactor!=null?s.clearCoat.intensity=t.clearcoatFactor:s.clearCoat.intensity=0,t.clearcoatTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatTexture`,t.clearcoatTexture,r=>{r.name=`${s.name} (ClearCoat Intensity)`,s.clearCoat.texture=r})),t.clearcoatRoughnessFactor!=null?s.clearCoat.roughness=t.clearcoatRoughnessFactor:s.clearCoat.roughness=0,t.clearcoatRoughnessTexture&&(t.clearcoatRoughnessTexture.nonColorData=!0,n.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatRoughnessTexture`,t.clearcoatRoughnessTexture,r=>{r.name=`${s.name} (ClearCoat Roughness)`,s.clearCoat.textureRoughness=r}))),t.clearcoatNormalTexture&&(t.clearcoatNormalTexture.nonColorData=!0,n.push(this._loader.loadTextureInfoAsync(`${e}/clearcoatNormalTexture`,t.clearcoatNormalTexture,r=>{r.name=`${s.name} (ClearCoat Normal)`,s.clearCoat.bumpTexture=r})),s.invertNormalMapX=!s.getScene().useRightHandedSystem,s.invertNormalMapY=s.getScene().useRightHandedSystem,t.clearcoatNormalTexture.scale!=null&&(s.clearCoat.bumpTexture.level=t.clearcoatNormalTexture.scale)),Promise.all(n).then(()=>{})}}_.RegisterExtension(Ze,i=>new $r(i));const Je="KHR_materials_iridescence";class kr{constructor(e){this.name=Je,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(Je)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return _.LoadExtensionAsync(e,t,this.name,(n,r)=>{const o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,s)),o.push(this._loadIridescencePropertiesAsync(n,r,s)),Promise.all(o).then(()=>{})})}_loadIridescencePropertiesAsync(e,t,s){if(!(s instanceof G))throw new Error(`${e}: Material type not supported`);const n=new Array;return s.iridescence.isEnabled=!0,s.iridescence.intensity=t.iridescenceFactor??0,s.iridescence.indexOfRefraction=t.iridescenceIor??t.iridescenceIOR??1.3,s.iridescence.minimumThickness=t.iridescenceThicknessMinimum??100,s.iridescence.maximumThickness=t.iridescenceThicknessMaximum??400,t.iridescenceTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceTexture`,t.iridescenceTexture,r=>{r.name=`${s.name} (Iridescence Intensity)`,s.iridescence.texture=r})),t.iridescenceThicknessTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/iridescenceThicknessTexture`,t.iridescenceThicknessTexture,r=>{r.name=`${s.name} (Iridescence Thickness)`,s.iridescence.thicknessTexture=r})),Promise.all(n).then(()=>{})}}_.RegisterExtension(Je,i=>new kr(i));const Qe="KHR_materials_anisotropy";class Vr{constructor(e){this.name=Qe,this.order=195,this._loader=e,this.enabled=this._loader.isExtensionUsed(Qe)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return _.LoadExtensionAsync(e,t,this.name,(n,r)=>{const o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,s)),o.push(this._loadIridescencePropertiesAsync(n,r,s)),Promise.all(o).then(()=>{})})}_loadIridescencePropertiesAsync(e,t,s){if(!(s instanceof G))throw new Error(`${e}: Material type not supported`);const n=new Array;return s.anisotropy.isEnabled=!0,s.anisotropy.intensity=t.anisotropyStrength??0,s.anisotropy.angle=t.anisotropyRotation??0,t.anisotropyTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/anisotropyTexture`,t.anisotropyTexture,r=>{r.name=`${s.name} (Anisotropy Intensity)`,s.anisotropy.texture=r})),Promise.all(n).then(()=>{})}}_.RegisterExtension(Qe,i=>new Vr(i));const et="KHR_materials_emissive_strength";class Gr{constructor(e){this.name=et,this.order=170,this._loader=e,this.enabled=this._loader.isExtensionUsed(et)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return _.LoadExtensionAsync(e,t,this.name,(n,r)=>this._loader.loadMaterialPropertiesAsync(e,t,s).then(()=>{this._loadEmissiveProperties(n,r,s)}))}_loadEmissiveProperties(e,t,s){if(!(s instanceof G))throw new Error(`${e}: Material type not supported`);t.emissiveStrength!==void 0&&s.emissiveColor.scaleToRef(t.emissiveStrength,s.emissiveColor)}}_.RegisterExtension(et,i=>new Gr(i));const tt="KHR_materials_sheen";class Ur{constructor(e){this.name=tt,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(tt)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return _.LoadExtensionAsync(e,t,this.name,(n,r)=>{const o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,s)),o.push(this._loadSheenPropertiesAsync(n,r,s)),Promise.all(o).then(()=>{})})}_loadSheenPropertiesAsync(e,t,s){if(!(s instanceof G))throw new Error(`${e}: Material type not supported`);const n=new Array;return s.sheen.isEnabled=!0,s.sheen.intensity=1,t.sheenColorFactor!=null?s.sheen.color=L.FromArray(t.sheenColorFactor):s.sheen.color=L.Black(),t.sheenColorTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/sheenColorTexture`,t.sheenColorTexture,r=>{r.name=`${s.name} (Sheen Color)`,s.sheen.texture=r})),t.sheenRoughnessFactor!==void 0?s.sheen.roughness=t.sheenRoughnessFactor:s.sheen.roughness=0,t.sheenRoughnessTexture&&(t.sheenRoughnessTexture.nonColorData=!0,n.push(this._loader.loadTextureInfoAsync(`${e}/sheenRoughnessTexture`,t.sheenRoughnessTexture,r=>{r.name=`${s.name} (Sheen Roughness)`,s.sheen.textureRoughness=r}))),s.sheen.albedoScaling=!0,s.sheen.useRoughnessFromMainTexture=!1,Promise.all(n).then(()=>{})}}_.RegisterExtension(tt,i=>new Ur(i));const st="KHR_materials_specular";class Hr{constructor(e){this.name=st,this.order=190,this._loader=e,this.enabled=this._loader.isExtensionUsed(st)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return _.LoadExtensionAsync(e,t,this.name,(n,r)=>{const o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,s)),o.push(this._loadSpecularPropertiesAsync(n,r,s)),Promise.all(o).then(()=>{})})}_loadSpecularPropertiesAsync(e,t,s){if(!(s instanceof G))throw new Error(`${e}: Material type not supported`);const n=new Array;return t.specularFactor!==void 0&&(s.metallicF0Factor=t.specularFactor),t.specularColorFactor!==void 0&&(s.metallicReflectanceColor=L.FromArray(t.specularColorFactor)),t.specularTexture&&(t.specularTexture.nonColorData=!0,n.push(this._loader.loadTextureInfoAsync(`${e}/specularTexture`,t.specularTexture,r=>{r.name=`${s.name} (Specular F0 Strength)`,s.metallicReflectanceTexture=r,s.useOnlyMetallicFromMetallicReflectanceTexture=!0}))),t.specularColorTexture&&n.push(this._loader.loadTextureInfoAsync(`${e}/specularColorTexture`,t.specularColorTexture,r=>{r.name=`${s.name} (Specular F0 Color)`,s.reflectanceTexture=r})),Promise.all(n).then(()=>{})}}_.RegisterExtension(st,i=>new Hr(i));const nt="KHR_materials_ior";class Se{constructor(e){this.name=nt,this.order=180,this._loader=e,this.enabled=this._loader.isExtensionUsed(nt)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return _.LoadExtensionAsync(e,t,this.name,(n,r)=>{const o=new Array;return o.push(this._loader.loadMaterialPropertiesAsync(e,t,s)),o.push(this._loadIorPropertiesAsync(n,r,s)),Promise.all(o).then(()=>{})})}_loadIorPropertiesAsync(e,t,s){if(!(s instanceof G))throw new Error(`${e}: Material type not supported`);return t.ior!==void 0?s.indexOfRefraction=t.ior:s.indexOfRefraction=Se._DEFAULT_IOR,Promise.resolve()}}Se._DEFAULT_IOR=1.5;_.RegisterExtension(nt,i=>new Se(i));const z="KHR_materials_variants";class ie{constructor(e){this.name=z,this._loader=e,this.enabled=this._loader.isExtensionUsed(z)}dispose(){this._loader=null}static GetAvailableVariants(e){const t=this._GetExtensionMetadata(e);return t?Object.keys(t.variants):[]}getAvailableVariants(e){return ie.GetAvailableVariants(e)}static SelectVariant(e,t){const s=this._GetExtensionMetadata(e);if(!s)throw new Error(`Cannot select variant on a glTF mesh that does not have the ${z} extension`);const n=r=>{const o=s.variants[r];if(o)for(const a of o)a.mesh.material=a.material};if(t instanceof Array)for(const r of t)n(r);else n(t);s.lastSelected=t}selectVariant(e,t){return ie.SelectVariant(e,t)}static Reset(e){const t=this._GetExtensionMetadata(e);if(!t)throw new Error(`Cannot reset on a glTF mesh that does not have the ${z} extension`);for(const s of t.original)s.mesh.material=s.material;t.lastSelected=null}reset(e){return ie.Reset(e)}static GetLastSelectedVariant(e){const t=this._GetExtensionMetadata(e);if(!t)throw new Error(`Cannot get the last selected variant on a glTF mesh that does not have the ${z} extension`);return t.lastSelected}getLastSelectedVariant(e){return ie.GetLastSelectedVariant(e)}static _GetExtensionMetadata(e){var t,s;return((s=(t=e==null?void 0:e._internalMetadata)==null?void 0:t.gltf)==null?void 0:s[z])||null}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._variants=t.variants}}_loadMeshPrimitiveAsync(e,t,s,n,r,o){return _.LoadExtensionAsync(e,r,this.name,(a,l)=>{const c=new Array;return c.push(this._loader._loadMeshPrimitiveAsync(e,t,s,n,r,h=>{if(o(h),h instanceof oe){const d=_._GetDrawMode(e,r.mode),u=this._loader.rootBabylonMesh,f=u?u._internalMetadata=u._internalMetadata||{}:{},p=f.gltf=f.gltf||{},A=p[z]=p[z]||{lastSelected:null,original:[],variants:{}};A.original.push({mesh:h,material:h.material});for(let m=0;m<l.mappings.length;++m){const g=l.mappings[m],x=y.Get(`${a}/mappings/${m}/material`,this._loader.gltf.materials,g.material);c.push(this._loader._loadMaterialAsync(`#/materials/${g.material}`,x,h,d,w=>{for(let E=0;E<g.variants.length;++E){const O=g.variants[E],I=y.Get(`/extensions/${z}/variants/${O}`,this._variants,O);A.variants[I.name]=A.variants[I.name]||[],A.variants[I.name].push({mesh:h,material:w}),h.onClonedObservable.add(T=>{const v=T;let $=null,R=v;do{if(R=R.parent,!R)return;$=ie._GetExtensionMetadata(R)}while($===null);if(u&&$===ie._GetExtensionMetadata(u)){R._internalMetadata={};for(const M in u._internalMetadata)R._internalMetadata[M]=u._internalMetadata[M];R._internalMetadata.gltf=[];for(const M in u._internalMetadata.gltf)R._internalMetadata.gltf[M]=u._internalMetadata.gltf[M];R._internalMetadata.gltf[z]={lastSelected:null,original:[],variants:{}};for(const M of $.original)R._internalMetadata.gltf[z].original.push({mesh:M.mesh,material:M.material});for(const M in $.variants)if(Object.prototype.hasOwnProperty.call($.variants,M)){R._internalMetadata.gltf[z].variants[M]=[];for(const vt of $.variants[M])R._internalMetadata.gltf[z].variants[M].push({mesh:vt.mesh,material:vt.material})}$=R._internalMetadata.gltf[z]}for(const M of $.original)M.mesh===h&&(M.mesh=v);for(const M of $.variants[I.name])M.mesh===h&&(M.mesh=v)})}}))}}})),Promise.all(c).then(([h])=>h)})}}_.RegisterExtension(z,i=>new ie(i));class It{static _GetDefaultOptions(){return{renderSize:1024,samples:4,lodGenerationScale:1,lodGenerationOffset:-4,renderTargetTextureType:he.TEXTURETYPE_HALF_FLOAT,generateMipmaps:!0}}constructor(e,t){this._opaqueRenderTarget=null,this._opaqueMeshesCache=[],this._transparentMeshesCache=[],this._materialObservers={},this._options={...It._GetDefaultOptions(),...e},this._scene=t,this._scene._transmissionHelper=this,this.onErrorObservable=new q,this._scene.onDisposeObservable.addOnce(()=>{this.dispose()}),this._parseScene(),this._setupRenderTargets()}updateOptions(e){if(!Object.keys(e).filter(r=>this._options[r]!==e[r]).length)return;const s={...this._options,...e},n=this._options;this._options=s,s.renderSize!==n.renderSize||s.renderTargetTextureType!==n.renderTargetTextureType||s.generateMipmaps!==n.generateMipmaps||!this._opaqueRenderTarget?this._setupRenderTargets():(this._opaqueRenderTarget.samples=s.samples,this._opaqueRenderTarget.lodGenerationScale=s.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=s.lodGenerationOffset)}getOpaqueTarget(){return this._opaqueRenderTarget}_shouldRenderAsTransmission(e){return e?!!(e instanceof G&&e.subSurface.isRefractionEnabled):!1}_addMesh(e){this._materialObservers[e.uniqueId]=e.onMaterialChangedObservable.add(this._onMeshMaterialChanged.bind(this)),S.SetImmediate(()=>{this._shouldRenderAsTransmission(e.material)?(e.material.refractionTexture=this._opaqueRenderTarget,this._transparentMeshesCache.indexOf(e)===-1&&this._transparentMeshesCache.push(e)):this._opaqueMeshesCache.indexOf(e)===-1&&this._opaqueMeshesCache.push(e)})}_removeMesh(e){e.onMaterialChangedObservable.remove(this._materialObservers[e.uniqueId]),delete this._materialObservers[e.uniqueId];let t=this._transparentMeshesCache.indexOf(e);t!==-1&&this._transparentMeshesCache.splice(t,1),t=this._opaqueMeshesCache.indexOf(e),t!==-1&&this._opaqueMeshesCache.splice(t,1)}_parseScene(){this._scene.meshes.forEach(this._addMesh.bind(this)),this._scene.onNewMeshAddedObservable.add(this._addMesh.bind(this)),this._scene.onMeshRemovedObservable.add(this._removeMesh.bind(this))}_onMeshMaterialChanged(e){const t=this._transparentMeshesCache.indexOf(e),s=this._opaqueMeshesCache.indexOf(e);this._shouldRenderAsTransmission(e.material)?(e.material instanceof G&&(e.material.subSurface.refractionTexture=this._opaqueRenderTarget),s!==-1?(this._opaqueMeshesCache.splice(s,1),this._transparentMeshesCache.push(e)):t===-1&&this._transparentMeshesCache.push(e)):t!==-1?(this._transparentMeshesCache.splice(t,1),this._opaqueMeshesCache.push(e)):s===-1&&this._opaqueMeshesCache.push(e)}_isRenderTargetValid(){var e;return((e=this._opaqueRenderTarget)==null?void 0:e.getInternalTexture())!==null}_setupRenderTargets(){var s;this._opaqueRenderTarget&&this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=new Cs("opaqueSceneTexture",this._options.renderSize,this._scene,this._options.generateMipmaps,void 0,this._options.renderTargetTextureType),this._opaqueRenderTarget.ignoreCameraViewport=!0,this._opaqueRenderTarget.renderList=this._opaqueMeshesCache,this._opaqueRenderTarget.clearColor=((s=this._options.clearColor)==null?void 0:s.clone())??this._scene.clearColor.clone(),this._opaqueRenderTarget.gammaSpace=!1,this._opaqueRenderTarget.lodGenerationScale=this._options.lodGenerationScale,this._opaqueRenderTarget.lodGenerationOffset=this._options.lodGenerationOffset,this._opaqueRenderTarget.samples=this._options.samples,this._opaqueRenderTarget.renderSprites=!0,this._opaqueRenderTarget.renderParticles=!0;let e,t;this._opaqueRenderTarget.onBeforeBindObservable.add(n=>{t=this._scene.environmentIntensity,this._scene.environmentIntensity=1,e=this._scene.imageProcessingConfiguration.applyByPostProcess,this._options.clearColor?n.clearColor.copyFrom(this._options.clearColor):this._scene.clearColor.toLinearSpaceToRef(n.clearColor,this._scene.getEngine().useExactSrgbConversions),this._scene.imageProcessingConfiguration._applyByPostProcess=!0}),this._opaqueRenderTarget.onAfterUnbindObservable.add(()=>{this._scene.environmentIntensity=t,this._scene.imageProcessingConfiguration._applyByPostProcess=e}),this._transparentMeshesCache.forEach(n=>{this._shouldRenderAsTransmission(n.material)&&(n.material.refractionTexture=this._opaqueRenderTarget)})}dispose(){this._scene._transmissionHelper=void 0,this._opaqueRenderTarget&&(this._opaqueRenderTarget.dispose(),this._opaqueRenderTarget=null),this._transparentMeshesCache=[],this._opaqueMeshesCache=[]}}const rt="KHR_materials_transmission";class jr{constructor(e){this.name=rt,this.order=175,this._loader=e,this.enabled=this._loader.isExtensionUsed(rt),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return _.LoadExtensionAsync(e,t,this.name,(n,r)=>{const o=new Array;return o.push(this._loader.loadMaterialBasePropertiesAsync(e,t,s)),o.push(this._loader.loadMaterialPropertiesAsync(e,t,s)),o.push(this._loadTransparentPropertiesAsync(n,t,s,r)),Promise.all(o).then(()=>{})})}_loadTransparentPropertiesAsync(e,t,s,n){var o,a;if(!(s instanceof G))throw new Error(`${e}: Material type not supported`);const r=s;if(r.subSurface.isRefractionEnabled=!0,r.subSurface.volumeIndexOfRefraction=1,r.subSurface.useAlbedoToTintRefraction=!0,n.transmissionFactor!==void 0){r.subSurface.refractionIntensity=n.transmissionFactor;const l=r.getScene();r.subSurface.refractionIntensity&&!l._transmissionHelper?new It({},r.getScene()):r.subSurface.refractionIntensity&&!((o=l._transmissionHelper)!=null&&o._isRenderTargetValid())&&((a=l._transmissionHelper)==null||a._setupRenderTargets())}else return r.subSurface.refractionIntensity=0,r.subSurface.isRefractionEnabled=!1,Promise.resolve();return r.subSurface.minimumThickness=0,r.subSurface.maximumThickness=0,n.transmissionTexture?(n.transmissionTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/transmissionTexture`,n.transmissionTexture,void 0).then(l=>{r.subSurface.refractionIntensityTexture=l,r.subSurface.useGltfStyleTextures=!0})):Promise.resolve()}}_.RegisterExtension(rt,i=>new jr(i));const ot="KHR_materials_translucency";class Kr{constructor(e){this.name=ot,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(ot),this.enabled&&(e.parent.transparencyAsCoverage=!0)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return _.LoadExtensionAsync(e,t,this.name,(n,r)=>{const o=new Array;return o.push(this._loader.loadMaterialBasePropertiesAsync(e,t,s)),o.push(this._loader.loadMaterialPropertiesAsync(e,t,s)),o.push(this._loadTranslucentPropertiesAsync(n,t,s,r)),Promise.all(o).then(()=>{})})}_loadTranslucentPropertiesAsync(e,t,s,n){if(!(s instanceof G))throw new Error(`${e}: Material type not supported`);const r=s;if(r.subSurface.isTranslucencyEnabled=!0,r.subSurface.volumeIndexOfRefraction=1,r.subSurface.minimumThickness=0,r.subSurface.maximumThickness=0,r.subSurface.useAlbedoToTintTranslucency=!0,n.translucencyFactor!==void 0)r.subSurface.translucencyIntensity=n.translucencyFactor;else return r.subSurface.translucencyIntensity=0,r.subSurface.isTranslucencyEnabled=!1,Promise.resolve();return n.translucencyTexture?(n.translucencyTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/translucencyTexture`,n.translucencyTexture).then(o=>{r.subSurface.translucencyIntensityTexture=o})):Promise.resolve()}}_.RegisterExtension(ot,i=>new Kr(i));const it="KHR_materials_volume";class Wr{constructor(e){this.name=it,this.order=173,this._loader=e,this.enabled=this._loader.isExtensionUsed(it),this.enabled&&this._loader._disableInstancedMesh++}dispose(){this.enabled&&this._loader._disableInstancedMesh--,this._loader=null}loadMaterialPropertiesAsync(e,t,s){return _.LoadExtensionAsync(e,t,this.name,(n,r)=>{const o=new Array;return o.push(this._loader.loadMaterialBasePropertiesAsync(e,t,s)),o.push(this._loader.loadMaterialPropertiesAsync(e,t,s)),o.push(this._loadVolumePropertiesAsync(n,t,s,r)),Promise.all(o).then(()=>{})})}_loadVolumePropertiesAsync(e,t,s,n){if(!(s instanceof G))throw new Error(`${e}: Material type not supported`);if(!s.subSurface.isRefractionEnabled&&!s.subSurface.isTranslucencyEnabled||!n.thicknessFactor)return Promise.resolve();s.subSurface.volumeIndexOfRefraction=s.indexOfRefraction;const r=n.attenuationDistance!==void 0?n.attenuationDistance:Number.MAX_VALUE;return s.subSurface.tintColorAtDistance=r,n.attenuationColor!==void 0&&n.attenuationColor.length==3&&s.subSurface.tintColor.copyFromFloats(n.attenuationColor[0],n.attenuationColor[1],n.attenuationColor[2]),s.subSurface.minimumThickness=0,s.subSurface.maximumThickness=n.thicknessFactor,s.subSurface.useThicknessAsDepth=!0,n.thicknessTexture?(n.thicknessTexture.nonColorData=!0,this._loader.loadTextureInfoAsync(`${e}/thicknessTexture`,n.thicknessTexture).then(o=>{s.subSurface.thicknessTexture=o,s.subSurface.useGltfStyleTextures=!0})):Promise.resolve()}}_.RegisterExtension(it,i=>new Wr(i));const at="KHR_materials_dispersion";class qr{constructor(e){this.name=at,this.order=174,this._loader=e,this.enabled=this._loader.isExtensionUsed(at)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return _.LoadExtensionAsync(e,t,this.name,(n,r)=>{const o=new Array;return o.push(this._loader.loadMaterialBasePropertiesAsync(e,t,s)),o.push(this._loader.loadMaterialPropertiesAsync(e,t,s)),o.push(this._loadDispersionPropertiesAsync(n,t,s,r)),Promise.all(o).then(()=>{})})}_loadDispersionPropertiesAsync(e,t,s,n){if(!(s instanceof G))throw new Error(`${e}: Material type not supported`);return!s.subSurface.isRefractionEnabled||!n.dispersion||(s.subSurface.isDispersionEnabled=!0,s.subSurface.dispersion=n.dispersion),Promise.resolve()}}_.RegisterExtension(at,i=>new qr(i));const lt="KHR_mesh_quantization";class Yr{constructor(e){this.name=lt,this.enabled=e.isExtensionUsed(lt)}dispose(){}}_.RegisterExtension(lt,i=>new Yr(i));const ct="KHR_texture_basisu";class zr{constructor(e){this.name=ct,this._loader=e,this.enabled=e.isExtensionUsed(ct)}dispose(){this._loader=null}_loadTextureAsync(e,t,s){return _.LoadExtensionAsync(e,t,this.name,(n,r)=>{const o=t.sampler==null?_.DefaultSampler:y.Get(`${e}/sampler`,this._loader.gltf.samplers,t.sampler),a=y.Get(`${n}/source`,this._loader.gltf.images,r.source);return this._loader._createTextureAsync(e,o,a,l=>{s(l)},t._textureInfo.nonColorData?{useRGBAIfASTCBC7NotAvailableWhenUASTC:!0}:void 0,!t._textureInfo.nonColorData)})}}_.RegisterExtension(ct,i=>new zr(i));const ht="KHR_texture_transform";class Xr{constructor(e){this.name=ht,this._loader=e,this.enabled=this._loader.isExtensionUsed(ht)}dispose(){this._loader=null}loadTextureInfoAsync(e,t,s){return _.LoadExtensionAsync(e,t,this.name,(n,r)=>this._loader.loadTextureInfoAsync(e,t,o=>{if(!(o instanceof B))throw new Error(`${n}: Texture type not supported`);r.offset&&(o.uOffset=r.offset[0],o.vOffset=r.offset[1]),o.uRotationCenter=0,o.vRotationCenter=0,r.rotation&&(o.wAng=-r.rotation),r.scale&&(o.uScale=r.scale[0],o.vScale=r.scale[1]),r.texCoord!=null&&(o.coordinatesIndex=r.texCoord),s(o)}))}}_.RegisterExtension(ht,i=>new Xr(i));const dt="KHR_xmp_json_ld";class Zr{constructor(e){this.name=dt,this.order=100,this._loader=e,this.enabled=this._loader.isExtensionUsed(dt)}dispose(){this._loader=null}onLoading(){var s,n,r;if(this._loader.rootBabylonMesh===null)return;const e=(s=this._loader.gltf.extensions)==null?void 0:s.KHR_xmp_json_ld,t=(r=(n=this._loader.gltf.asset)==null?void 0:n.extensions)==null?void 0:r.KHR_xmp_json_ld;if(e&&t){const o=+t.packet;e.packets&&o<e.packets.length&&(this._loader.rootBabylonMesh.metadata=this._loader.rootBabylonMesh.metadata||{},this._loader.rootBabylonMesh.metadata.xmp=e.packets[o])}}}_.RegisterExtension(dt,i=>new Zr(i));function fe(i,e,t,s){return L.FromArray(e,t).scale(s)}function Jr(i,e,t,s){return e[t+3]*s}function D(i,e,t,s){return e[t]*s}function ut(i,e,t,s){return-e[t]*s}function ve(i,e,t,s){return e[t+1]*s}function Ht(i,e,t,s){return e[t]*s*2}function Fe(i){return{scale:[new F(b.ANIMATIONTYPE_FLOAT,`${i}.uScale`,D,()=>2),new F(b.ANIMATIONTYPE_FLOAT,`${i}.vScale`,ve,()=>2)],offset:[new F(b.ANIMATIONTYPE_FLOAT,`${i}.uOffset`,D,()=>2),new F(b.ANIMATIONTYPE_FLOAT,`${i}.vOffset`,ve,()=>2)],rotation:[new F(b.ANIMATIONTYPE_FLOAT,`${i}.wAng`,ut,()=>1)]}}class ne extends xe{buildAnimations(e,t,s,n,r){r(e._babylonCamera,this._buildAnimation(t,s,n))}}class F extends xe{buildAnimations(e,t,s,n,r){for(const o in e._data)r(e._data[o].babylonMaterial,this._buildAnimation(t,s,n))}}class Ae extends xe{buildAnimations(e,t,s,n,r){r(e._babylonLight,this._buildAnimation(t,s,n))}}const Qr={__array__:{__target__:!0,...ye}},eo={__array__:{__target__:!0,orthographic:{xmag:[new ne(b.ANIMATIONTYPE_FLOAT,"orthoLeft",ut,()=>1),new ne(b.ANIMATIONTYPE_FLOAT,"orthoRight",ve,()=>1)],ymag:[new ne(b.ANIMATIONTYPE_FLOAT,"orthoBottom",ut,()=>1),new ne(b.ANIMATIONTYPE_FLOAT,"orthoTop",ve,()=>1)],zfar:[new ne(b.ANIMATIONTYPE_FLOAT,"maxZ",D,()=>1)],znear:[new ne(b.ANIMATIONTYPE_FLOAT,"minZ",D,()=>1)]},perspective:{yfov:[new ne(b.ANIMATIONTYPE_FLOAT,"fov",D,()=>1)],zfar:[new ne(b.ANIMATIONTYPE_FLOAT,"maxZ",D,()=>1)],znear:[new ne(b.ANIMATIONTYPE_FLOAT,"minZ",D,()=>1)]}}},to={__array__:{__target__:!0,pbrMetallicRoughness:{baseColorFactor:[new F(b.ANIMATIONTYPE_COLOR3,"albedoColor",fe,()=>4),new F(b.ANIMATIONTYPE_FLOAT,"alpha",Jr,()=>4)],metallicFactor:[new F(b.ANIMATIONTYPE_FLOAT,"metallic",D,()=>1)],roughnessFactor:[new F(b.ANIMATIONTYPE_FLOAT,"roughness",D,()=>1)],baseColorTexture:{extensions:{KHR_texture_transform:Fe("albedoTexture")}}},emissiveFactor:[new F(b.ANIMATIONTYPE_COLOR3,"emissiveColor",fe,()=>3)],normalTexture:{scale:[new F(b.ANIMATIONTYPE_FLOAT,"bumpTexture.level",D,()=>1)]},occlusionTexture:{strength:[new F(b.ANIMATIONTYPE_FLOAT,"ambientTextureStrength",D,()=>1)],extensions:{KHR_texture_transform:Fe("ambientTexture")}},emissiveTexture:{extensions:{KHR_texture_transform:Fe("emissiveTexture")}},extensions:{KHR_materials_ior:{ior:[new F(b.ANIMATIONTYPE_FLOAT,"indexOfRefraction",D,()=>1)]},KHR_materials_clearcoat:{clearcoatFactor:[new F(b.ANIMATIONTYPE_FLOAT,"clearCoat.intensity",D,()=>1)],clearcoatRoughnessFactor:[new F(b.ANIMATIONTYPE_FLOAT,"clearCoat.roughness",D,()=>1)]},KHR_materials_sheen:{sheenColorFactor:[new F(b.ANIMATIONTYPE_COLOR3,"sheen.color",fe,()=>3)],sheenRoughnessFactor:[new F(b.ANIMATIONTYPE_FLOAT,"sheen.roughness",D,()=>1)]},KHR_materials_specular:{specularFactor:[new F(b.ANIMATIONTYPE_FLOAT,"metallicF0Factor",D,()=>1)],specularColorFactor:[new F(b.ANIMATIONTYPE_COLOR3,"metallicReflectanceColor",fe,()=>3)]},KHR_materials_emissive_strength:{emissiveStrength:[new F(b.ANIMATIONTYPE_FLOAT,"emissiveIntensity",D,()=>1)]},KHR_materials_transmission:{transmissionFactor:[new F(b.ANIMATIONTYPE_FLOAT,"subSurface.refractionIntensity",D,()=>1)]},KHR_materials_volume:{attenuationColor:[new F(b.ANIMATIONTYPE_COLOR3,"subSurface.tintColor",fe,()=>3)],attenuationDistance:[new F(b.ANIMATIONTYPE_FLOAT,"subSurface.tintColorAtDistance",D,()=>1)],thicknessFactor:[new F(b.ANIMATIONTYPE_FLOAT,"subSurface.maximumThickness",D,()=>1)]},KHR_materials_dispersion:{dispersion:[new F(b.ANIMATIONTYPE_FLOAT,"subSurface.dispersion",D,()=>1)]},KHR_materials_iridescence:{iridescenceFactor:[new F(b.ANIMATIONTYPE_FLOAT,"iridescence.intensity",D,()=>1)],iridescenceIor:[new F(b.ANIMATIONTYPE_FLOAT,"iridescence.indexOfRefraction",D,()=>1)],iridescenceThicknessMinimum:[new F(b.ANIMATIONTYPE_FLOAT,"iridescence.minimumThickness",D,()=>1)],iridescenceThicknessMaximum:[new F(b.ANIMATIONTYPE_FLOAT,"iridescence.maximumThickness",D,()=>1)]},KHR_materials_anisotropy:{anisotropyStrength:[new F(b.ANIMATIONTYPE_FLOAT,"anisotropy.intensity",D,()=>1)],anisotropyRotation:[new F(b.ANIMATIONTYPE_FLOAT,"anisotropy.angle",D,()=>1)]}}}},so={KHR_lights_punctual:{lights:{__array__:{__target__:!0,color:[new Ae(b.ANIMATIONTYPE_COLOR3,"diffuse",fe,()=>3)],intensity:[new Ae(b.ANIMATIONTYPE_FLOAT,"intensity",D,()=>1)],range:[new Ae(b.ANIMATIONTYPE_FLOAT,"range",D,()=>1)],spot:{innerConeAngle:[new Ae(b.ANIMATIONTYPE_FLOAT,"innerAngle",Ht,()=>1)],outerConeAngle:[new Ae(b.ANIMATIONTYPE_FLOAT,"angle",Ht,()=>1)]}}}}},no={nodes:Qr,materials:to,cameras:eo,extensions:so};class Qt{constructor(e,t){this._gltf=e,this._infoTree=t}convert(e){let t=this._gltf,s=this._infoTree,n;if(!e.startsWith("/"))throw new Error("Path must start with a /");const r=e.split("/");r.shift();for(const o of r){if(s.__array__)s=s.__array__;else if(s=s[o],!s)throw new Error(`Path ${e} is invalid`);if(t===void 0)throw new Error(`Path ${e} is invalid`);t=t[o],s.__target__&&(n=t)}return{object:n,info:s}}}const ft="KHR_animation_pointer";class ro extends Qt{constructor(e){super(e,no)}}class oo{constructor(e){this.name=ft,this._loader=e,this._pathToObjectConverter=new ro(this._loader.gltf)}get enabled(){return this._loader.isExtensionUsed(ft)}dispose(){this._loader=null,delete this._pathToObjectConverter}_loadAnimationChannelAsync(e,t,s,n,r){var c;const o=(c=n.target.extensions)==null?void 0:c.KHR_animation_pointer;if(!o||!this._pathToObjectConverter)return null;n.target.path!=="pointer"&&U.Warn(`${e}/target/path: Value (${n.target.path}) must be (pointer) when using the ${this.name} extension`),n.target.node!=null&&U.Warn(`${e}/target/node: Value (${n.target.node}) must not be present when using the ${this.name} extension`);const a=`${e}/extensions/${this.name}`,l=o.pointer;if(!l)throw new Error(`${a}: Pointer is missing`);try{const h=this._pathToObjectConverter.convert(l);return this._loader._loadAnimationChannelFromTargetInfoAsync(e,t,s,n,h,r)}catch{return U.Warn(`${a}/pointer: Invalid pointer (${l}) skipped`),null}}}_.RegisterExtension(ft,i=>new oo(i));const _t="MSFT_audio_emitter";class io{constructor(e){this.name=_t,this._loader=e,this.enabled=this._loader.isExtensionUsed(_t)}dispose(){this._loader=null,this._clips=null,this._emitters=null}onLoading(){const e=this._loader.gltf.extensions;if(e&&e[this.name]){const t=e[this.name];this._clips=t.clips,this._emitters=t.emitters,y.Assign(this._clips),y.Assign(this._emitters)}}loadSceneAsync(e,t){return _.LoadExtensionAsync(e,t,this.name,(s,n)=>{const r=new Array;r.push(this._loader.loadSceneAsync(e,t));for(const o of n.emitters){const a=y.Get(`${s}/emitters`,this._emitters,o);if(a.refDistance!=null||a.maxDistance!=null||a.rolloffFactor!=null||a.distanceModel!=null||a.innerAngle!=null||a.outerAngle!=null)throw new Error(`${s}: Direction or Distance properties are not allowed on emitters attached to a scene`);r.push(this._loadEmitterAsync(`${s}/emitters/${a.index}`,a))}return Promise.all(r).then(()=>{})})}loadNodeAsync(e,t,s){return _.LoadExtensionAsync(e,t,this.name,(n,r)=>{const o=new Array;return this._loader.loadNodeAsync(n,t,a=>{for(const l of r.emitters){const c=y.Get(`${n}/emitters`,this._emitters,l);o.push(this._loadEmitterAsync(`${n}/emitters/${c.index}`,c).then(()=>{for(const h of c._babylonSounds)h.attachToMesh(a),(c.innerAngle!=null||c.outerAngle!=null)&&(h.setLocalDirectionToMesh(C.Forward()),h.setDirectionalCone(2*S.ToDegrees(c.innerAngle==null?Math.PI:c.innerAngle),2*S.ToDegrees(c.outerAngle==null?Math.PI:c.outerAngle),0))}))}s(a)}).then(a=>Promise.all(o).then(()=>a))})}loadAnimationAsync(e,t){return _.LoadExtensionAsync(e,t,this.name,(s,n)=>this._loader.loadAnimationAsync(e,t).then(r=>{const o=new Array;y.Assign(n.events);for(const a of n.events)o.push(this._loadAnimationEventAsync(`${s}/events/${a.index}`,e,t,a,r));return Promise.all(o).then(()=>r)}))}_loadClipAsync(e,t){if(t._objectURL)return t._objectURL;let s;if(t.uri)s=this._loader.loadUriAsync(e,t,t.uri);else{const n=y.Get(`${e}/bufferView`,this._loader.gltf.bufferViews,t.bufferView);s=this._loader.loadBufferViewAsync(`/bufferViews/${n.index}`,n)}return t._objectURL=s.then(n=>URL.createObjectURL(new Blob([n],{type:t.mimeType}))),t._objectURL}_loadEmitterAsync(e,t){if(t._babylonSounds=t._babylonSounds||[],!t._babylonData){const s=new Array,n=t.name||`emitter${t.index}`,r={loop:!1,autoplay:!1,volume:t.volume==null?1:t.volume};for(let a=0;a<t.clips.length;a++){const l=`/extensions/${this.name}/clips`,c=y.Get(l,this._clips,t.clips[a].clip);s.push(this._loadClipAsync(`${l}/${t.clips[a].clip}`,c).then(h=>{const d=t._babylonSounds[a]=new xs(n,h,this._loader.babylonScene,null,r);d.refDistance=t.refDistance||1,d.maxDistance=t.maxDistance||256,d.rolloffFactor=t.rolloffFactor||1,d.distanceModel=t.distanceModel||"exponential"}))}const o=Promise.all(s).then(()=>{const a=t.clips.map(c=>c.weight||1),l=new or(t.loop||!1,t._babylonSounds,a);t.innerAngle&&(l.directionalConeInnerAngle=2*S.ToDegrees(t.innerAngle)),t.outerAngle&&(l.directionalConeOuterAngle=2*S.ToDegrees(t.outerAngle)),t.volume&&(l.volume=t.volume),t._babylonData.sound=l});t._babylonData={loaded:o}}return t._babylonData.loaded}_getEventAction(e,t,s,n,r){switch(s){case"play":return o=>{const a=(r||0)+(o-n);t.play(a)};case"stop":return()=>{t.stop()};case"pause":return()=>{t.pause()};default:throw new Error(`${e}: Unsupported action ${s}`)}}_loadAnimationEventAsync(e,t,s,n,r){if(r.targetedAnimations.length==0)return Promise.resolve();const o=r.targetedAnimations[0],a=n.emitter,l=y.Get(`/extensions/${this.name}/emitters`,this._emitters,a);return this._loadEmitterAsync(e,l).then(()=>{const c=l._babylonData.sound;if(c){const h=new Ct(n.time,this._getEventAction(e,c,n.action,n.time,n.startOffset));o.animation.addEvent(h),r.onAnimationGroupEndObservable.add(()=>{c.stop()}),r.onAnimationGroupPauseObservable.add(()=>{c.pause()})}})}}_.RegisterExtension(_t,i=>new io(i));const pt="MSFT_lod";class ao{constructor(e){this.name=pt,this.order=100,this.maxLODsToLoad=10,this.onNodeLODsLoadedObservable=new q,this.onMaterialLODsLoadedObservable=new q,this._bufferLODs=new Array,this._nodeIndexLOD=null,this._nodeSignalLODs=new Array,this._nodePromiseLODs=new Array,this._nodeBufferLODs=new Array,this._materialIndexLOD=null,this._materialSignalLODs=new Array,this._materialPromiseLODs=new Array,this._materialBufferLODs=new Array,this._loader=e,this.enabled=this._loader.isExtensionUsed(pt)}dispose(){this._loader=null,this._nodeIndexLOD=null,this._nodeSignalLODs.length=0,this._nodePromiseLODs.length=0,this._nodeBufferLODs.length=0,this._materialIndexLOD=null,this._materialSignalLODs.length=0,this._materialPromiseLODs.length=0,this._materialBufferLODs.length=0,this.onMaterialLODsLoadedObservable.clear(),this.onNodeLODsLoadedObservable.clear()}onReady(){for(let e=0;e<this._nodePromiseLODs.length;e++){const t=Promise.all(this._nodePromiseLODs[e]).then(()=>{e!==0&&(this._loader.endPerformanceCounter(`Node LOD ${e}`),this._loader.log(`Loaded node LOD ${e}`)),this.onNodeLODsLoadedObservable.notifyObservers(e),e!==this._nodePromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Node LOD ${e+1}`),this._loadBufferLOD(this._nodeBufferLODs,e+1),this._nodeSignalLODs[e]&&this._nodeSignalLODs[e].resolve())});this._loader._completePromises.push(t)}for(let e=0;e<this._materialPromiseLODs.length;e++){const t=Promise.all(this._materialPromiseLODs[e]).then(()=>{e!==0&&(this._loader.endPerformanceCounter(`Material LOD ${e}`),this._loader.log(`Loaded material LOD ${e}`)),this.onMaterialLODsLoadedObservable.notifyObservers(e),e!==this._materialPromiseLODs.length-1&&(this._loader.startPerformanceCounter(`Material LOD ${e+1}`),this._loadBufferLOD(this._materialBufferLODs,e+1),this._materialSignalLODs[e]&&this._materialSignalLODs[e].resolve())});this._loader._completePromises.push(t)}}loadSceneAsync(e,t){const s=this._loader.loadSceneAsync(e,t);return this._loadBufferLOD(this._bufferLODs,0),s}loadNodeAsync(e,t,s){return _.LoadExtensionAsync(e,t,this.name,(n,r)=>{let o;const a=this._getLODs(n,t,this._loader.gltf.nodes,r.ids);this._loader.logOpen(`${n}`);for(let l=0;l<a.length;l++){const c=a[l];l!==0&&(this._nodeIndexLOD=l,this._nodeSignalLODs[l]=this._nodeSignalLODs[l]||new ge);const h=u=>{s(u),u.setEnabled(!1)},d=this._loader.loadNodeAsync(`/nodes/${c.index}`,c,h).then(u=>{if(l!==0){const f=a[l-1];f._babylonTransformNode&&(this._disposeTransformNode(f._babylonTransformNode),delete f._babylonTransformNode)}return u.setEnabled(!0),u});this._nodePromiseLODs[l]=this._nodePromiseLODs[l]||[],l===0?o=d:(this._nodeIndexLOD=null,this._nodePromiseLODs[l].push(d))}return this._loader.logClose(),o})}_loadMaterialAsync(e,t,s,n,r){return this._nodeIndexLOD?null:_.LoadExtensionAsync(e,t,this.name,(o,a)=>{let l;const c=this._getLODs(o,t,this._loader.gltf.materials,a.ids);this._loader.logOpen(`${o}`);for(let h=0;h<c.length;h++){const d=c[h];h!==0&&(this._materialIndexLOD=h);const u=this._loader._loadMaterialAsync(`/materials/${d.index}`,d,s,n,f=>{h===0&&r(f)}).then(f=>{if(h!==0){r(f);const p=c[h-1]._data;p[n]&&(this._disposeMaterials([p[n].babylonMaterial]),delete p[n])}return f});this._materialPromiseLODs[h]=this._materialPromiseLODs[h]||[],h===0?l=u:(this._materialIndexLOD=null,this._materialPromiseLODs[h].push(u))}return this._loader.logClose(),l})}_loadUriAsync(e,t,s){if(this._nodeIndexLOD!==null){this._loader.log("deferred");const n=this._nodeIndexLOD-1;return this._nodeSignalLODs[n]=this._nodeSignalLODs[n]||new ge,this._nodeSignalLODs[this._nodeIndexLOD-1].promise.then(()=>this._loader.loadUriAsync(e,t,s))}else if(this._materialIndexLOD!==null){this._loader.log("deferred");const n=this._materialIndexLOD-1;return this._materialSignalLODs[n]=this._materialSignalLODs[n]||new ge,this._materialSignalLODs[n].promise.then(()=>this._loader.loadUriAsync(e,t,s))}return null}loadBufferAsync(e,t,s,n){if(this._loader.parent.useRangeRequests&&!t.uri){if(!this._loader.bin)throw new Error(`${e}: Uri is missing or the binary glTF is missing its binary chunk`);const r=(o,a)=>{const l=s,c=l+n-1;let h=o[a];return h?(h.start=Math.min(h.start,l),h.end=Math.max(h.end,c)):(h={start:l,end:c,loaded:new ge},o[a]=h),h.loaded.promise.then(d=>new Uint8Array(d.buffer,d.byteOffset+s-h.start,n))};return this._loader.log("deferred"),this._nodeIndexLOD!==null?r(this._nodeBufferLODs,this._nodeIndexLOD):this._materialIndexLOD!==null?r(this._materialBufferLODs,this._materialIndexLOD):r(this._bufferLODs,0)}return null}_loadBufferLOD(e,t){const s=e[t];s&&(this._loader.log(`Loading buffer range [${s.start}-${s.end}]`),this._loader.bin.readAsync(s.start,s.end-s.start+1).then(n=>{s.loaded.resolve(n)},n=>{s.loaded.reject(n)}))}_getLODs(e,t,s,n){if(this.maxLODsToLoad<=0)throw new Error("maxLODsToLoad must be greater than zero");const r=[];for(let o=n.length-1;o>=0;o--)if(r.push(y.Get(`${e}/ids/${n[o]}`,s,n[o])),r.length===this.maxLODsToLoad)return r;return r.push(t),r}_disposeTransformNode(e){const t=[],s=e.material;s&&t.push(s);for(const r of e.getChildMeshes())r.material&&t.push(r.material);e.dispose();const n=t.filter(r=>this._loader.babylonScene.meshes.every(o=>o.material!=r));this._disposeMaterials(n)}_disposeMaterials(e){const t={};for(const s of e){for(const n of s.getActiveTextures())t[n.uniqueId]=n;s.dispose()}for(const s in t)for(const n of this._loader.babylonScene.materials)n.hasTexture(t[s])&&delete t[s];for(const s in t)t[s].dispose()}}_.RegisterExtension(pt,i=>new ao(i));const mt="MSFT_minecraftMesh";class lo{constructor(e){this.name=mt,this._loader=e,this.enabled=this._loader.isExtensionUsed(mt)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return _.LoadExtraAsync(e,t,this.name,(n,r)=>{if(r){if(!(s instanceof G))throw new Error(`${n}: Material type not supported`);const o=this._loader.loadMaterialPropertiesAsync(e,t,s);return s.needAlphaBlending()&&(s.forceDepthWrite=!0,s.separateCullingPass=!0),s.backFaceCulling=s.forceDepthWrite,s.twoSidedLighting=!0,o}return null})}}_.RegisterExtension(mt,i=>new lo(i));const At="MSFT_sRGBFactors";class co{constructor(e){this.name=At,this._loader=e,this.enabled=this._loader.isExtensionUsed(At)}dispose(){this._loader=null}loadMaterialPropertiesAsync(e,t,s){return _.LoadExtraAsync(e,t,this.name,(n,r)=>{if(r){if(!(s instanceof G))throw new Error(`${n}: Material type not supported`);const o=this._loader.loadMaterialPropertiesAsync(e,t,s),a=s.getScene().getEngine().useExactSrgbConversions;return s.albedoTexture||s.albedoColor.toLinearSpaceToRef(s.albedoColor,a),s.reflectivityTexture||s.reflectivityColor.toLinearSpaceToRef(s.reflectivityColor,a),o}return null})}}_.RegisterExtension(At,i=>new co(i));const ho={"lifecycle/onStart":Ns.ClassName,"lifecycle/onTick":Is.ClassName,log:Ms.ClassName,"flow/delay":vs.ClassName,"customEvent/send":Ss.ClassName,"customEvent/receive":Ps.ClassName,"flow/sequence":Ls.ClassName,"world/get":Fs.ClassName,"world/set":Rs.ClassName,"flow/doN":Bs.ClassName,"variable/get":Ds.ClassName,"variable/set":$s.ClassName,"flow/whileLoop":ks.ClassName,"math/random":Vs.ClassName,"math/e":Gs.ClassName,"math/pi":Us.ClassName,"math/inf":Hs.ClassName,"math/nan":js.ClassName,"math/abs":Ks.ClassName,"math/sign":Ws.ClassName,"math/trunc":qs.ClassName,"math/floor":Ys.ClassName,"math/ceil":zs.ClassName,"math/fract":Xs.ClassName,"math/neg":Zs.ClassName,"math/add":Js.ClassName,"math/sub":Qs.ClassName,"math/mul":en.ClassName,"math/div":tn.ClassName,"math/rem":sn.ClassName,"math/min":nn.ClassName,"math/max":rn.ClassName,"math/clamp":on.ClassName,"math/saturate":an.ClassName,"math/mix":ln.ClassName,"math/eq":cn.ClassName,"math/lt":hn.ClassName,"math/le":dn.ClassName,"math/gt":un.ClassName,"math/ge":fn.ClassName,"math/isnan":_n.ClassName,"math/isinf":pn.ClassName,"math/rad":mn.ClassName,"math/deg":An.ClassName,"math/sin":gn.ClassName,"math/cos":yn.ClassName,"math/tan":bn.ClassName,"math/asin":On.ClassName,"math/acos":Tn.ClassName,"math/atan":En.ClassName,"math/atan2":wn.ClassName,"math/sinh":Cn.ClassName,"math/cosh":xn.ClassName,"math/tanh":Nn.ClassName,"math/asinh":In.ClassName,"math/acosh":Mn.ClassName,"math/atanh":vn.ClassName,"math/exp":Sn.ClassName,"math/log":Pn.ClassName,"math/log2":Ln.ClassName,"math/log10":Fn.ClassName,"math/sqrt":Rn.ClassName,"math/cbrt":Bn.ClassName,"math/pow":Dn.ClassName,"math/length":$n.ClassName,"math/normalize":kn.ClassName,"math/dot":Vn.ClassName,"math/cross":Gn.ClassName,"math/rotate2d":Un.ClassName,"math/rotate3d":Hn.ClassName,"math/transpose":jn.ClassName,"math/determinant":Kn.ClassName,"math/inverse":Wn.ClassName,"math/matmul":qn.ClassName,"math/not":Yn.ClassName,"math/and":zn.ClassName,"math/or":Xn.ClassName,"math/xor":Zn.ClassName,"math/asr":Jn.ClassName,"math/lsl":Qn.ClassName,"math/clz":er.ClassName,"math/ctz":tr.ClassName,"math/popcnt":sr.ClassName},uo={float2:"Vector2",float3:"Vector3",float4:"Vector4",float4x4:"Matrix",int:"FlowGraphInteger"};function gt(i,e,t){if(i.type!==void 0){const s=e.types&&e.types[i.type];if(!s)throw new Error(`${t}: Unknown type: ${i.type}`);const n=s.signature;if(!n)throw new Error(`${t}: Type ${i.type} has no signature`);const r=uo[n];return{value:i.value,className:r}}else return i.value}function fo(i,e,t){const s={},n=i.configuration??[];for(const r of n)if(r.id==="customEvent"){const o=e.customEvents&&e.customEvents[r.value];if(!o)throw new Error(`/extensions/KHR_interactivity/nodes/${t}: Unknown custom event: ${r.value}`);s.eventId=o.id,s.eventData=o.values.map(a=>a.id)}else if(r.id==="variable"){const o=e.variables&&e.variables[r.value];if(!o)throw new Error(`/extensions/KHR_interactivity/nodes/${t}: Unknown variable: ${r.value}`);s.variableName=o.id}else if(r.id==="path"){const o=r.value;s.path=o}else s[r.id]=gt(r,e,`/extensions/KHR_interactivity/nodes/${t}`);return s}function _o(i,e,t){const s=ho[e.type];if(!s)throw new Error(`/extensions/KHR_interactivity/nodes/${i}: Unknown block type: ${e.type}`);const n=i.toString(),r=fo(e,t,n),o=e.metadata;return{className:s,config:r,uniqueId:n,metadata:o,dataInputs:[],dataOutputs:[],signalInputs:[],signalOutputs:[]}}function po(i){const e={uniqueId:me(),_userVariables:{},_connectionValues:{}},t=[e],s=[];for(let r=0;r<i.nodes.length;r++){const o=i.nodes[r],a=_o(r,o,i);s.push(a)}for(let r=0;r<i.nodes.length;r++){const o=i.nodes[r],a=s[r],l=o.flows??[];for(const h of l){const d=h.id,u={uniqueId:me(),name:d,_connectionType:Ne.Output,connectedPointIds:[]};a.signalOutputs.push(u);const f=h.node,p=h.socket,A=s[f];if(!A)throw new Error(`/extensions/KHR_interactivity/nodes/${r}: Could not find node with id ${f} that connects its input with with node ${r}'s output ${d}`);let m=A.signalInputs.find(g=>g.name===p);m||(m={uniqueId:me(),name:p,_connectionType:Ne.Input,connectedPointIds:[]},A.signalInputs.push(m)),m.connectedPointIds.push(u.uniqueId),u.connectedPointIds.push(m.uniqueId)}const c=o.values??[];for(const h of c){const d=h.id,u={uniqueId:me(),name:d,_connectionType:Ne.Input,connectedPointIds:[]};if(a.dataInputs.push(u),h.value!==void 0){const f=gt(h,i,`/extensions/KHR_interactivity/nodes/${r}`);e._connectionValues[u.uniqueId]=f}else if(h.node!==void 0&&h.socket!==void 0){const f=h.node,p=h.socket,A=s[f];if(!A)throw new Error(`/extensions/KHR_interactivity/nodes/${r}: Could not find node with id ${f} that connects its output with node${r}'s input ${d}`);let m=A.dataOutputs.find(g=>g.name===p);m||(m={uniqueId:me(),name:p,_connectionType:Ne.Output,connectedPointIds:[]},A.dataOutputs.push(m)),u.connectedPointIds.push(m.uniqueId),m.connectedPointIds.push(u.uniqueId)}else throw new Error(`/extensions/KHR_interactivity/nodes/${r}: Invalid socket ${d} in node ${r}`)}}const n=i.variables??[];for(let r=0;r<n.length;r++){const o=n[r],a=o.id;e._userVariables[a]=gt(o,i,`/extensions/KHR_interactivity/variables/${r}`)}return{allBlocks:s,executionContexts:t}}class mo extends Qt{constructor(e){super(e,go)}}const Ao={__array__:{__target__:!0,translation:{type:"Vector3",get:i=>i._babylonTransformNode.position,set:(i,e)=>{const t=e._babylonTransformNode;t.position=i},getObject(i){return i._babylonTransformNode}}}},go={nodes:Ao},yt="KHR_interactivity";class yo{constructor(e){this._loader=e,this.name=yt,this.enabled=this._loader.isExtensionUsed(yt),this._pathConverter=new mo(this._loader.gltf)}dispose(){this._loader=null,delete this._pathConverter}onReady(){var r;if(!this._loader.babylonScene||!this._pathConverter)return;const e=this._loader.babylonScene,t=(r=this._loader.gltf.extensions)==null?void 0:r.KHR_interactivity,s=po(t),n=new nr({scene:e});rr.Parse(s,{coordinator:n,pathConverter:this._pathConverter}),n.start()}}_.RegisterExtension(yt,i=>new yo(i));const es="ExtrasAsMetadata";class bo{_assignExtras(e,t){if(t.extras&&Object.keys(t.extras).length>0){const s=e.metadata=e.metadata||{},n=s.gltf=s.gltf||{};n.extras=t.extras}}constructor(e){this.name=es,this.enabled=!0,this._loader=e}dispose(){this._loader=null}loadNodeAsync(e,t,s){return this._loader.loadNodeAsync(e,t,n=>{this._assignExtras(n,t),s(n)})}loadCameraAsync(e,t,s){return this._loader.loadCameraAsync(e,t,n=>{this._assignExtras(n,t),s(n)})}createMaterial(e,t,s){const n=this._loader.createMaterial(e,t,s);return this._assignExtras(n,t),n}}_.RegisterExtension(es,i=>new bo(i));class te{constructor(){this.materials=[]}parseMTL(e,t,s,n){if(t instanceof ArrayBuffer)return;const r=t.split(`
`),o=/\s+/;let a,l=null;for(let c=0;c<r.length;c++){const h=r[c].trim();if(h.length===0||h.charAt(0)==="#")continue;const d=h.indexOf(" ");let u=d>=0?h.substring(0,d):h;u=u.toLowerCase();const f=d>=0?h.substring(d+1).trim():"";if(u==="newmtl")l&&this.materials.push(l),e._blockEntityCollection=!!n,l=new we(f,e),l._parentContainer=n,e._blockEntityCollection=!1;else if(u==="kd"&&l)a=f.split(o,3).map(parseFloat),l.diffuseColor=L.FromArray(a);else if(u==="ka"&&l)a=f.split(o,3).map(parseFloat),l.ambientColor=L.FromArray(a);else if(u==="ks"&&l)a=f.split(o,3).map(parseFloat),l.specularColor=L.FromArray(a);else if(u==="ke"&&l)a=f.split(o,3).map(parseFloat),l.emissiveColor=L.FromArray(a);else if(u==="ns"&&l)l.specularPower=parseFloat(f);else if(u==="d"&&l)l.alpha=parseFloat(f);else if(u==="map_ka"&&l)l.ambientTexture=te._GetTexture(s,f,e);else if(u==="map_kd"&&l)l.diffuseTexture=te._GetTexture(s,f,e);else if(u==="map_ks"&&l)l.specularTexture=te._GetTexture(s,f,e);else if(u!=="map_ns")if(u==="map_bump"&&l){const p=f.split(o),A=p.indexOf("-bm");let m=null;A>=0&&(m=p[A+1],p.splice(A,2)),l.bumpTexture=te._GetTexture(s,p.join(" "),e),l.bumpTexture&&m!==null&&(l.bumpTexture.level=parseFloat(m))}else u==="map_d"&&l&&(l.opacityTexture=te._GetTexture(s,f,e))}l&&this.materials.push(l)}static _GetTexture(e,t,s){if(!t)return null;let n=e;if(e==="file:"){let r=t.lastIndexOf("\\");r===-1&&(r=t.lastIndexOf("/")),r>-1?n+=t.substr(r+1):n+=t}else n+=t;return new B(n,s,!1,te.INVERT_TEXTURE_Y)}}te.INVERT_TEXTURE_Y=!0;class P{constructor(e,t,s){this._positions=[],this._normals=[],this._uvs=[],this._colors=[],this._meshesFromObj=[],this._indicesForBabylon=[],this._wrappedPositionForBabylon=[],this._wrappedUvsForBabylon=[],this._wrappedColorsForBabylon=[],this._wrappedNormalsForBabylon=[],this._tuplePosNorm=[],this._curPositionInIndices=0,this._hasMeshes=!1,this._unwrappedPositionsForBabylon=[],this._unwrappedColorsForBabylon=[],this._unwrappedNormalsForBabylon=[],this._unwrappedUVForBabylon=[],this._triangles=[],this._materialNameFromObj="",this._objMeshName="",this._increment=1,this._isFirstMaterial=!0,this._grayColor=new Re(.5,.5,.5,1),this._materialToUse=e,this._babylonMeshesArray=t,this._loadingOptions=s}_isInArray(e,t){e[t[0]]||(e[t[0]]={normals:[],idx:[]});const s=e[t[0]].normals.indexOf(t[1]);return s===-1?-1:e[t[0]].idx[s]}_isInArrayUV(e,t){e[t[0]]||(e[t[0]]={normals:[],idx:[],uv:[]});const s=e[t[0]].normals.indexOf(t[1]);return s!=1&&t[2]===e[t[0]].uv[s]?e[t[0]].idx[s]:-1}_setData(e,t,s,n,r,o,a){let l;this._loadingOptions.optimizeWithUV?l=this._isInArrayUV(this._tuplePosNorm,[e,s,t]):l=this._isInArray(this._tuplePosNorm,[e,s]),l===-1?(this._indicesForBabylon.push(this._wrappedPositionForBabylon.length),this._wrappedPositionForBabylon.push(n),this._wrappedUvsForBabylon.push(r),this._wrappedNormalsForBabylon.push(o),a!==void 0&&this._wrappedColorsForBabylon.push(a),this._tuplePosNorm[e].normals.push(s),this._tuplePosNorm[e].idx.push(this._curPositionInIndices++),this._loadingOptions.optimizeWithUV&&this._tuplePosNorm[e].uv.push(t)):this._indicesForBabylon.push(l)}_unwrapData(){for(let e=0;e<this._wrappedPositionForBabylon.length;e++)this._unwrappedPositionsForBabylon.push(this._wrappedPositionForBabylon[e].x,this._wrappedPositionForBabylon[e].y,this._wrappedPositionForBabylon[e].z),this._unwrappedNormalsForBabylon.push(this._wrappedNormalsForBabylon[e].x,this._wrappedNormalsForBabylon[e].y,this._wrappedNormalsForBabylon[e].z),this._unwrappedUVForBabylon.push(this._wrappedUvsForBabylon[e].x,this._wrappedUvsForBabylon[e].y),this._loadingOptions.importVertexColors&&this._unwrappedColorsForBabylon.push(this._wrappedColorsForBabylon[e].r,this._wrappedColorsForBabylon[e].g,this._wrappedColorsForBabylon[e].b,this._wrappedColorsForBabylon[e].a);this._wrappedPositionForBabylon.length=0,this._wrappedNormalsForBabylon.length=0,this._wrappedUvsForBabylon.length=0,this._wrappedColorsForBabylon.length=0,this._tuplePosNorm.length=0,this._curPositionInIndices=0}_getTriangles(e,t){for(let s=t;s<e.length-1;s++)this._triangles.push(e[0],e[s],e[s+1])}_setDataForCurrentFaceWithPattern1(e,t){this._getTriangles(e,t);for(let s=0;s<this._triangles.length;s++){const n=parseInt(this._triangles[s])-1;this._setData(n,0,0,this._positions[n],be.Zero(),C.Up(),this._loadingOptions.importVertexColors?this._colors[n]:void 0)}this._triangles.length=0}_setDataForCurrentFaceWithPattern2(e,t){this._getTriangles(e,t);for(let s=0;s<this._triangles.length;s++){const n=this._triangles[s].split("/"),r=parseInt(n[0])-1,o=parseInt(n[1])-1;this._setData(r,o,0,this._positions[r],this._uvs[o],C.Up(),this._loadingOptions.importVertexColors?this._colors[r]:void 0)}this._triangles.length=0}_setDataForCurrentFaceWithPattern3(e,t){this._getTriangles(e,t);for(let s=0;s<this._triangles.length;s++){const n=this._triangles[s].split("/"),r=parseInt(n[0])-1,o=parseInt(n[1])-1,a=parseInt(n[2])-1;this._setData(r,o,a,this._positions[r],this._uvs[o],this._normals[a])}this._triangles.length=0}_setDataForCurrentFaceWithPattern4(e,t){this._getTriangles(e,t);for(let s=0;s<this._triangles.length;s++){const n=this._triangles[s].split("//"),r=parseInt(n[0])-1,o=parseInt(n[1])-1;this._setData(r,1,o,this._positions[r],be.Zero(),this._normals[o],this._loadingOptions.importVertexColors?this._colors[r]:void 0)}this._triangles.length=0}_setDataForCurrentFaceWithPattern5(e,t){this._getTriangles(e,t);for(let s=0;s<this._triangles.length;s++){const n=this._triangles[s].split("/"),r=this._positions.length+parseInt(n[0]),o=this._uvs.length+parseInt(n[1]),a=this._normals.length+parseInt(n[2]);this._setData(r,o,a,this._positions[r],this._uvs[o],this._normals[a],this._loadingOptions.importVertexColors?this._colors[r]:void 0)}this._triangles.length=0}_addPreviousObjMesh(){this._meshesFromObj.length>0&&(this._handledMesh=this._meshesFromObj[this._meshesFromObj.length-1],this._unwrapData(),this._indicesForBabylon.reverse(),this._handledMesh.indices=this._indicesForBabylon.slice(),this._handledMesh.positions=this._unwrappedPositionsForBabylon.slice(),this._handledMesh.normals=this._unwrappedNormalsForBabylon.slice(),this._handledMesh.uvs=this._unwrappedUVForBabylon.slice(),this._loadingOptions.importVertexColors&&(this._handledMesh.colors=this._unwrappedColorsForBabylon.slice()),this._indicesForBabylon.length=0,this._unwrappedPositionsForBabylon.length=0,this._unwrappedColorsForBabylon.length=0,this._unwrappedNormalsForBabylon.length=0,this._unwrappedUVForBabylon.length=0)}_optimizeNormals(e){const t=e.getVerticesData(N.PositionKind),s=e.getVerticesData(N.NormalKind),n={};if(!t||!s)return;for(let o=0;o<t.length/3;o++){const a=t[o*3+0],l=t[o*3+1],c=t[o*3+2],h=a+"_"+l+"_"+c;let d=n[h];d||(d=[],n[h]=d),d.push(o)}const r=new C;for(const o in n){const a=n[o];if(a.length<2)continue;const l=a[0];for(let c=1;c<a.length;++c){const h=a[c];s[l*3+0]+=s[h*3+0],s[l*3+1]+=s[h*3+1],s[l*3+2]+=s[h*3+2]}r.copyFromFloats(s[l*3+0],s[l*3+1],s[l*3+2]),r.normalize();for(let c=0;c<a.length;++c){const h=a[c];s[h*3+0]=r.x,s[h*3+1]=r.y,s[h*3+2]=r.z}}e.setVerticesData(N.NormalKind,s)}parse(e,t,s,n,r){var a;const o=t.split(`
`);for(let l=0;l<o.length;l++){const c=o[l].trim().replace(/\s\s/g," ");let h;if(!(c.length===0||c.charAt(0)==="#"))if(P.VertexPattern.test(c)){if(h=c.match(/[^ ]+/g),this._positions.push(new C(parseFloat(h[1]),parseFloat(h[2]),parseFloat(h[3]))),this._loadingOptions.importVertexColors)if(h.length>=7){const d=parseFloat(h[4]),u=parseFloat(h[5]),f=parseFloat(h[6]);this._colors.push(new Re(d>1?d/255:d,u>1?u/255:u,f>1?f/255:f,h.length===7||h[7]===void 0?1:parseFloat(h[7])))}else this._colors.push(this._grayColor)}else if((h=P.NormalPattern.exec(c))!==null)this._normals.push(new C(parseFloat(h[1]),parseFloat(h[2]),parseFloat(h[3])));else if((h=P.UVPattern.exec(c))!==null)this._uvs.push(new be(parseFloat(h[1])*this._loadingOptions.UVScaling.x,parseFloat(h[2])*this._loadingOptions.UVScaling.y));else if((h=P.FacePattern3.exec(c))!==null)this._setDataForCurrentFaceWithPattern3(h[1].trim().split(" "),1);else if((h=P.FacePattern4.exec(c))!==null)this._setDataForCurrentFaceWithPattern4(h[1].trim().split(" "),1);else if((h=P.FacePattern5.exec(c))!==null)this._setDataForCurrentFaceWithPattern5(h[1].trim().split(" "),1);else if((h=P.FacePattern2.exec(c))!==null)this._setDataForCurrentFaceWithPattern2(h[1].trim().split(" "),1);else if((h=P.FacePattern1.exec(c))!==null)this._setDataForCurrentFaceWithPattern1(h[1].trim().split(" "),1);else if((h=P.LinePattern1.exec(c))!==null)this._setDataForCurrentFaceWithPattern1(h[1].trim().split(" "),0);else if((h=P.LinePattern2.exec(c))!==null)this._setDataForCurrentFaceWithPattern2(h[1].trim().split(" "),0);else if((h=P.LinePattern3.exec(c))!==null)this._setDataForCurrentFaceWithPattern3(h[1].trim().split(" "),0);else if(P.GroupDescriptor.test(c)||P.ObjectDescriptor.test(c)){const d={name:c.substring(2).trim(),indices:void 0,positions:void 0,normals:void 0,uvs:void 0,colors:void 0,materialName:this._materialNameFromObj,isObject:P.ObjectDescriptor.test(c)};this._addPreviousObjMesh(),this._meshesFromObj.push(d),this._hasMeshes=!0,this._isFirstMaterial=!0,this._increment=1}else if(P.UseMtlDescriptor.test(c)){if(this._materialNameFromObj=c.substring(7).trim(),!this._isFirstMaterial||!this._hasMeshes){this._addPreviousObjMesh();const d={name:(this._objMeshName||"mesh")+"_mm"+this._increment.toString(),indices:void 0,positions:void 0,normals:void 0,uvs:void 0,colors:void 0,materialName:this._materialNameFromObj,isObject:!1};this._increment++,this._meshesFromObj.push(d),this._hasMeshes=!0}this._hasMeshes&&this._isFirstMaterial&&(this._meshesFromObj[this._meshesFromObj.length-1].materialName=this._materialNameFromObj,this._isFirstMaterial=!1)}else P.MtlLibGroupDescriptor.test(c)?r(c.substring(7).trim()):P.SmoothDescriptor.test(c)||U.Log("Unhandled expression at line : "+c)}if(this._hasMeshes&&(this._handledMesh=this._meshesFromObj[this._meshesFromObj.length-1],this._indicesForBabylon.reverse(),this._unwrapData(),this._handledMesh.indices=this._indicesForBabylon,this._handledMesh.positions=this._unwrappedPositionsForBabylon,this._handledMesh.normals=this._unwrappedNormalsForBabylon,this._handledMesh.uvs=this._unwrappedUVForBabylon,this._loadingOptions.importVertexColors&&(this._handledMesh.colors=this._unwrappedColorsForBabylon)),!this._hasMeshes){let l=null;if(this._indicesForBabylon.length)this._indicesForBabylon.reverse(),this._unwrapData();else{for(const c of this._positions)this._unwrappedPositionsForBabylon.push(c.x,c.y,c.z);if(this._normals.length)for(const c of this._normals)this._unwrappedNormalsForBabylon.push(c.x,c.y,c.z);if(this._uvs.length)for(const c of this._uvs)this._unwrappedUVForBabylon.push(c.x,c.y);if(this._colors.length)for(const c of this._colors)this._unwrappedColorsForBabylon.push(c.r,c.g,c.b,c.a);this._materialNameFromObj||(l=new we(Me.RandomId(),s),l.pointsCloud=!0,this._materialNameFromObj=l.name,this._normals.length||(l.disableLighting=!0,l.emissiveColor=L.White()))}this._meshesFromObj.push({name:Me.RandomId(),indices:this._indicesForBabylon,positions:this._unwrappedPositionsForBabylon,colors:this._unwrappedColorsForBabylon,normals:this._unwrappedNormalsForBabylon,uvs:this._unwrappedUVForBabylon,materialName:this._materialNameFromObj,directMaterial:l,isObject:!0})}for(let l=0;l<this._meshesFromObj.length;l++){if(e&&this._meshesFromObj[l].name){if(e instanceof Array){if(e.indexOf(this._meshesFromObj[l].name)===-1)continue}else if(this._meshesFromObj[l].name!==e)continue}this._handledMesh=this._meshesFromObj[l],s._blockEntityCollection=!!n;const c=new oe(this._meshesFromObj[l].name,s);if(c._parentContainer=n,s._blockEntityCollection=!1,this._handledMesh._babylonMesh=c,!this._handledMesh.isObject){for(let d=l-1;d>=0;--d)if(this._meshesFromObj[d].isObject&&this._meshesFromObj[d]._babylonMesh){c.parent=this._meshesFromObj[d]._babylonMesh;break}}if(this._materialToUse.push(this._meshesFromObj[l].materialName),((a=this._handledMesh.positions)==null?void 0:a.length)===0){this._babylonMeshesArray.push(c);continue}const h=new De;if(h.uvs=this._handledMesh.uvs,h.indices=this._handledMesh.indices,h.positions=this._handledMesh.positions,this._loadingOptions.computeNormals){const d=new Array;De.ComputeNormals(this._handledMesh.positions,this._handledMesh.indices,d),h.normals=d}else h.normals=this._handledMesh.normals;this._loadingOptions.importVertexColors&&(h.colors=this._handledMesh.colors),h.applyToMesh(c),this._loadingOptions.invertY&&(c.scaling.y*=-1),this._loadingOptions.optimizeNormals&&this._optimizeNormals(c),this._babylonMeshesArray.push(c),this._handledMesh.directMaterial&&(c.material=this._handledMesh.directMaterial)}}}P.ObjectDescriptor=/^o/;P.GroupDescriptor=/^g/;P.MtlLibGroupDescriptor=/^mtllib /;P.UseMtlDescriptor=/^usemtl /;P.SmoothDescriptor=/^s /;P.VertexPattern=/^v(\s+[\d|.|+|\-|e|E]+){3,7}/;P.NormalPattern=/^vn(\s+[\d|.|+|\-|e|E]+)( +[\d|.|+|\-|e|E]+)( +[\d|.|+|\-|e|E]+)/;P.UVPattern=/^vt(\s+[\d|.|+|\-|e|E]+)( +[\d|.|+|\-|e|E]+)/;P.FacePattern1=/^f\s+(([\d]{1,}[\s]?){3,})+/;P.FacePattern2=/^f\s+((([\d]{1,}\/[\d]{1,}[\s]?){3,})+)/;P.FacePattern3=/^f\s+((([\d]{1,}\/[\d]{1,}\/[\d]{1,}[\s]?){3,})+)/;P.FacePattern4=/^f\s+((([\d]{1,}\/\/[\d]{1,}[\s]?){3,})+)/;P.FacePattern5=/^f\s+(((-[\d]{1,}\/-[\d]{1,}\/-[\d]{1,}[\s]?){3,})+)/;P.LinePattern1=/^l\s+(([\d]{1,}[\s]?){2,})+/;P.LinePattern2=/^l\s+((([\d]{1,}\/[\d]{1,}[\s]?){2,})+)/;P.LinePattern3=/^l\s+((([\d]{1,}\/[\d]{1,}\/[\d]{1,}[\s]?){2,})+)/;class H{static get INVERT_TEXTURE_Y(){return te.INVERT_TEXTURE_Y}static set INVERT_TEXTURE_Y(e){te.INVERT_TEXTURE_Y=e}constructor(e){this.name="obj",this.extensions=".obj",this._assetContainer=null,this._loadingOptions=e||H._DefaultLoadingOptions}static get _DefaultLoadingOptions(){return{computeNormals:H.COMPUTE_NORMALS,optimizeNormals:H.OPTIMIZE_NORMALS,importVertexColors:H.IMPORT_VERTEX_COLORS,invertY:H.INVERT_Y,invertTextureY:H.INVERT_TEXTURE_Y,UVScaling:H.UV_SCALING,materialLoadingFailsSilently:H.MATERIAL_LOADING_FAILS_SILENTLY,optimizeWithUV:H.OPTIMIZE_WITH_UV,skipMaterials:H.SKIP_MATERIALS}}_loadMTL(e,t,s,n){const r=t+e;S.LoadFile(r,s,void 0,void 0,!1,(o,a)=>{n(r,a)})}createPlugin(){return new H(H._DefaultLoadingOptions)}canDirectLoad(){return!1}importMeshAsync(e,t,s,n){return this._parseSolid(e,t,s,n).then(r=>({meshes:r,particleSystems:[],skeletons:[],animationGroups:[],transformNodes:[],geometries:[],lights:[]}))}loadAsync(e,t,s){return this.importMeshAsync(null,e,t,s).then(()=>{})}loadAssetContainerAsync(e,t,s){const n=new bt(e);return this._assetContainer=n,this.importMeshAsync(null,e,t,s).then(r=>(r.meshes.forEach(o=>n.meshes.push(o)),r.meshes.forEach(o=>{const a=o.material;a&&n.materials.indexOf(a)==-1&&(n.materials.push(a),a.getActiveTextures().forEach(c=>{n.textures.indexOf(c)==-1&&n.textures.push(c)}))}),this._assetContainer=null,n)).catch(r=>{throw this._assetContainer=null,r})}_parseSolid(e,t,s,n){let r="";const o=new te,a=[],l=[];new P(a,l,this._loadingOptions).parse(e,s,t,this._assetContainer,d=>{r=d});const h=[];return r!==""&&!this._loadingOptions.skipMaterials&&h.push(new Promise((d,u)=>{this._loadMTL(r,n,f=>{try{o.parseMTL(t,f,n,this._assetContainer);for(let p=0;p<o.materials.length;p++){let A=0;const m=[];let g;for(;(g=a.indexOf(o.materials[p].name,A))>-1;)m.push(g),A=g+1;if(g===-1&&m.length===0)o.materials[p].dispose();else for(let x=0;x<m.length;x++){const w=l[m[x]],E=o.materials[p];w.material=E,w.getTotalIndices()||(E.pointsCloud=!0)}}d()}catch(p){S.Warn(`Error processing MTL file: '${r}'`),this._loadingOptions.materialLoadingFailsSilently?d():u(p)}},(f,p)=>{S.Warn(`Error downloading MTL file: '${r}'`),this._loadingOptions.materialLoadingFailsSilently?d():u(p)})})),Promise.all(h).then(()=>l)}}H.OPTIMIZE_WITH_UV=!0;H.INVERT_Y=!1;H.IMPORT_VERTEX_COLORS=!1;H.COMPUTE_NORMALS=!1;H.OPTIMIZE_NORMALS=!1;H.UV_SCALING=new be(1,1);H.SKIP_MATERIALS=!1;H.MATERIAL_LOADING_FAILS_SILENTLY=!0;ce&&ce.RegisterPlugin(new H);class ue{constructor(){this.solidPattern=/solid (\S*)([\S\s]*?)endsolid[ ]*(\S*)/g,this.facetsPattern=/facet([\s\S]*?)endfacet/g,this.normalPattern=/normal[\s]+([-+]?[0-9]+\.?[0-9]*([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+/g,this.vertexPattern=/vertex[\s]+([-+]?[0-9]+\.?[0-9]*([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+[\s]+([-+]?[0-9]*\.?[0-9]+([eE][-+]?[0-9]+)?)+/g,this.name="stl",this.extensions={".stl":{isBinary:!0}}}importMesh(e,t,s,n,r){let o;if(typeof s!="string"){if(this._isBinary(s)){const a=new oe("stlmesh",t);return this._parseBinary(a,s),r&&r.push(a),!0}s=new TextDecoder().decode(new Uint8Array(s))}for(;o=this.solidPattern.exec(s);){let a=o[1];const l=o[3];if(l&&a!=l)return S.Error("Error in STL, solid name != endsolid name"),!1;if(e&&a){if(e instanceof Array){if(!e.indexOf(a))continue}else if(a!==e)continue}a=a||"stlmesh";const c=new oe(a,t);this._parseASCII(c,o[2]),r&&r.push(c)}return!0}load(e,t,s){return this.importMesh(null,e,t,s,null)}loadAssetContainer(e,t,s){const n=new bt(e);return e._blockEntityCollection=!0,this.importMesh(null,e,t,s,n.meshes),e._blockEntityCollection=!1,n}_isBinary(e){const t=new DataView(e);if(t.byteLength<=80)return!1;const s=32/8*3+32/8*3*3+16/8,n=t.getUint32(80,!0);if(80+32/8+n*s===t.byteLength)return!0;const r=[115,111,108,105,100];for(let o=0;o<5;o++)if(t.getUint8(o)!==r[o])return!0;return!1}_parseBinary(e,t){const s=new DataView(t),n=s.getUint32(80,!0),r=84,o=12*4+2;let a=0;const l=new Float32Array(n*3*3),c=new Float32Array(n*3*3),h=new Uint32Array(n*3);let d=0;for(let u=0;u<n;u++){const f=r+u*o,p=s.getFloat32(f,!0),A=s.getFloat32(f+4,!0),m=s.getFloat32(f+8,!0);for(let g=1;g<=3;g++){const x=f+g*12;l[a]=s.getFloat32(x,!0),c[a]=p,ue.DO_NOT_ALTER_FILE_COORDINATES?(l[a+1]=s.getFloat32(x+4,!0),l[a+2]=s.getFloat32(x+8,!0),c[a+1]=A,c[a+2]=m):(l[a+2]=s.getFloat32(x+4,!0),l[a+1]=s.getFloat32(x+8,!0),c[a+2]=A,c[a+1]=m),a+=3}ue.DO_NOT_ALTER_FILE_COORDINATES?(h[d]=d,h[d+1]=d+2,h[d+2]=d+1,d+=3):(h[d]=d++,h[d]=d++,h[d]=d++)}e.setVerticesData(N.PositionKind,l),e.setVerticesData(N.NormalKind,c),e.setIndices(h),e.computeWorldMatrix(!0)}_parseASCII(e,t){const s=[],n=[],r=[];let o=0,a;for(;a=this.facetsPattern.exec(t);){const l=a[1],c=this.normalPattern.exec(l);if(this.normalPattern.lastIndex=0,!c)continue;const h=[Number(c[1]),Number(c[5]),Number(c[3])];let d;for(;d=this.vertexPattern.exec(l);)ue.DO_NOT_ALTER_FILE_COORDINATES?(s.push(Number(d[1]),Number(d[3]),Number(d[5])),n.push(h[0],h[2],h[1])):(s.push(Number(d[1]),Number(d[5]),Number(d[3])),n.push(h[0],h[1],h[2]));ue.DO_NOT_ALTER_FILE_COORDINATES?(r.push(o,o+2,o+1),o+=3):r.push(o++,o++,o++),this.vertexPattern.lastIndex=0}this.facetsPattern.lastIndex=0,e.setVerticesData(N.PositionKind,s),e.setVerticesData(N.NormalKind,n),e.setIndices(r),e.computeWorldMatrix(!0)}}ue.DO_NOT_ALTER_FILE_COORDINATES=!1;ce&&ce.RegisterPlugin(new ue);class Mt{constructor(){this.name="splat",this.extensions={".splat":{isBinary:!0},".ply":{isBinary:!0}}}createPlugin(){return new Mt}canDirectLoad(){return!1}_loadPLY(e){const t=new Uint8Array(e),s=new TextDecoder().decode(t.slice(0,1024*10)),n=`end_header
`,r=s.indexOf(n);if(r<0||!s)return e;const o=parseInt(/element vertex (\d+)\n/.exec(s)[1]);let a=0;const l={double:8,int:4,uint:4,float:4,short:2,ushort:2,uchar:1},c=[],h=s.slice(0,r).split(`
`).filter(m=>m.startsWith("property "));for(const m of h){const[g,x,w]=m.split(" ");if(c.push({name:w,type:x,offset:a}),!l[x])throw new Error(`Unsupported property type: ${x}`);a+=l[x]}const d=3*4+3*4+4+4,u=.28209479177387814,f=new DataView(e,r+n.length),p=new ArrayBuffer(d*o),A=new Y;for(let m=0;m<o;m++){const g=new Float32Array(p,m*d,3),x=new Float32Array(p,m*d+12,3),w=new Uint8ClampedArray(p,m*d+24,4),E=new Uint8ClampedArray(p,m*d+28,4);let O=255,I=0,T=0,v=0;for(let $=0;$<c.length;$++){const R=c[$];let M;switch(R.type){case"float":M=f.getFloat32(R.offset+m*a,!0);break;case"int":M=f.getInt32(R.offset+m*a,!0);break;default:throw new Error(`Unsupported property type: ${R.type}`)}switch(R.name){case"x":g[0]=M;break;case"y":g[1]=M;break;case"z":g[2]=M;break;case"scale_0":x[0]=Math.exp(M);break;case"scale_1":x[1]=Math.exp(M);break;case"scale_2":x[2]=Math.exp(M);break;case"red":w[0]=M;break;case"green":w[1]=M;break;case"blue":w[2]=M;break;case"f_dc_0":w[0]=(.5+u*M)*255;break;case"f_dc_1":w[1]=(.5+u*M)*255;break;case"f_dc_2":w[2]=(.5+u*M)*255;break;case"f_dc_3":w[3]=(.5+u*M)*255;break;case"opacity":w[3]=1/(1+Math.exp(-M))*255;break;case"rot_0":O=M;break;case"rot_1":I=M;break;case"rot_2":T=M;break;case"rot_3":v=M;break}}A.set(I,T,v,O),A.normalize(),E[0]=A.w*128+128,E[1]=A.x*128+128,E[2]=A.y*128+128,E[3]=A.z*128+128}return p}importMeshAsync(e,t,s,n){return new Lt("",t).loadFileAsync(n)}loadAsync(e,t,s){return new Lt("GaussianSplatting",e).loadDataAsync(this._loadPLY(t))}loadAssetContainerAsync(e,t,s){throw new Error("loadAssetContainerAsync not implemented for Gaussian Splatting loading")}}ce&&ce.RegisterPlugin(new Mt);
